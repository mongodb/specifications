<!DOCTYPE HTML>
<html lang="en" class="light" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Write Commands - MongoDB Driver Specifications</title>


        <!-- Custom HTML head -->
        
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->

    </head>
    <body class="sidebar-visible no-js">
    <div id="body-container">
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('light')
            html.classList.add(theme);
            var body = document.querySelector('body');
            body.classList.remove('no-js')
            body.classList.add('js');
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var body = document.querySelector('body');
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            body.classList.remove('sidebar-visible');
            body.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="../index.html">Introduction</a></li><li class="chapter-item expanded affix "><a href="../driver-mantras.html">Mantras</a></li><li class="chapter-item expanded affix "><a href="../wireversion-featurelist/wireversion-featurelist.html">Wire Version Feature List</a></li><li class="chapter-item expanded affix "><li class="part-title">Specifications</li><li class="chapter-item expanded "><div><strong aria-hidden="true">1.</strong> Serialization</div></li><li><ol class="section"><li class="chapter-item expanded "><a href="../BSON.html"><strong aria-hidden="true">1.1.</strong> BSON</a></li><li class="chapter-item expanded "><a href="../bson-objectid/objectid.html"><strong aria-hidden="true">1.2.</strong> ObjectId</a></li><li class="chapter-item expanded "><a href="../bson-decimal128/decimal128.html"><strong aria-hidden="true">1.3.</strong> Decimal128</a></li><li class="chapter-item expanded "><a href="../bson-binary-uuid/uuid.html"><strong aria-hidden="true">1.4.</strong> UUID</a></li><li class="chapter-item expanded "><a href="../dbref/dbref.html"><strong aria-hidden="true">1.5.</strong> DBRef</a></li><li class="chapter-item expanded "><a href="../extended-json/extended-json.html"><strong aria-hidden="true">1.6.</strong> Extended JSON</a></li></ol></li><li class="chapter-item expanded "><li class="spacer"></li><li class="chapter-item expanded "><div><strong aria-hidden="true">2.</strong> Communication</div></li><li><ol class="section"><li class="chapter-item expanded "><a href="../message/OP_MSG.html"><strong aria-hidden="true">2.1.</strong> OP_MSG</a></li><li class="chapter-item expanded "><a href="../run-command/run-command.html"><strong aria-hidden="true">2.2.</strong> Command Execution</a></li><li class="chapter-item expanded "><a href="../connection-string/connection-string-spec.html"><strong aria-hidden="true">2.3.</strong> Connection String</a></li><li class="chapter-item expanded "><a href="../uri-options/uri-options.html"><strong aria-hidden="true">2.4.</strong> URI Options</a></li><li class="chapter-item expanded "><a href="../ocsp-support/ocsp-support.html"><strong aria-hidden="true">2.5.</strong> OCSP</a></li><li class="chapter-item expanded "><a href="../mongodb-handshake/handshake.html"><strong aria-hidden="true">2.6.</strong> Initial Handshake</a></li><li class="chapter-item expanded "><a href="../compression/OP_COMPRESSED.html"><strong aria-hidden="true">2.7.</strong> Wire Compression</a></li><li class="chapter-item expanded "><a href="../socks5-support/socks5.html"><strong aria-hidden="true">2.8.</strong> SOCKS5</a></li><li class="chapter-item expanded "><a href="../initial-dns-seedlist-discovery/initial-dns-seedlist-discovery.html"><strong aria-hidden="true">2.9.</strong> Initial DNS Seedlist Discovery</a></li></ol></li><li class="chapter-item expanded "><li class="spacer"></li><li class="chapter-item expanded "><div><strong aria-hidden="true">3.</strong> Connectivity</div></li><li><ol class="section"><li class="chapter-item expanded "><a href="../server-discovery-and-monitoring/server-discovery-and-monitoring.html"><strong aria-hidden="true">3.1.</strong> Server Discovery and Monitoring</a></li><li class="chapter-item expanded "><a href="../connection-monitoring-and-pooling/connection-monitoring-and-pooling.html"><strong aria-hidden="true">3.2.</strong> Connection Monitoring and Pooling</a></li><li class="chapter-item expanded "><a href="../load-balancers/load-balancers.html"><strong aria-hidden="true">3.3.</strong> Load Balancer Support</a></li></ol></li><li class="chapter-item expanded "><li class="spacer"></li><li class="chapter-item expanded "><div><strong aria-hidden="true">4.</strong> Availability</div></li><li><ol class="section"><li class="chapter-item expanded "><a href="../server-discovery-and-monitoring/server-monitoring.html"><strong aria-hidden="true">4.1.</strong> Server Monitoring</a></li><li class="chapter-item expanded "><a href="../polling-srv-records-for-mongos-discovery/polling-srv-records-for-mongos-discovery.html"><strong aria-hidden="true">4.2.</strong> SRV Polling for mongos Discovery</a></li><li class="chapter-item expanded "><a href="../server-selection/server-selection.html"><strong aria-hidden="true">4.3.</strong> Server Selection</a></li><li class="chapter-item expanded "><a href="../max-staleness/max-staleness.html"><strong aria-hidden="true">4.4.</strong> Max Staleness</a></li></ol></li><li class="chapter-item expanded "><li class="spacer"></li><li class="chapter-item expanded "><div><strong aria-hidden="true">5.</strong> Resilience</div></li><li><ol class="section"><li class="chapter-item expanded "><div><strong aria-hidden="true">5.1.</strong> Retryability</div></li><li><ol class="section"><li class="chapter-item expanded "><a href="../retryable-reads/retryable-reads.html"><strong aria-hidden="true">5.1.1.</strong> Reads</a></li><li class="chapter-item expanded "><a href="../retryable-writes/retryable-writes.html"><strong aria-hidden="true">5.1.2.</strong> Writes</a></li></ol></li><li class="chapter-item expanded "><a href="../client-side-operations-timeout/client-side-operations-timeout.html"><strong aria-hidden="true">5.2.</strong> CSOT</a></li><li class="chapter-item expanded "><div><strong aria-hidden="true">5.3.</strong> Consistency</div></li><li><ol class="section"><li class="chapter-item expanded "><a href="../sessions/driver-sessions.html"><strong aria-hidden="true">5.3.1.</strong> Sessions</a></li><li class="chapter-item expanded "><a href="../causal-consistency/causal-consistency.html"><strong aria-hidden="true">5.3.2.</strong> Causal Consistency</a></li><li class="chapter-item expanded "><a href="../sessions/snapshot-sessions.html"><strong aria-hidden="true">5.3.3.</strong> Snapshot Reads</a></li><li class="chapter-item expanded "><a href="../transactions/transactions.html"><strong aria-hidden="true">5.3.4.</strong> Transactions</a></li><li class="chapter-item expanded "><a href="../transactions-convenient-api/transactions-convenient-api.html"><strong aria-hidden="true">5.3.5.</strong> Convenient Transactions API</a></li></ol></li></ol></li><li class="chapter-item expanded "><li class="spacer"></li><li class="chapter-item expanded "><div><strong aria-hidden="true">6.</strong> Programmability</div></li><li><ol class="section"><li class="chapter-item expanded "><div><strong aria-hidden="true">6.1.</strong> Resource Management</div></li><li><ol class="section"><li class="chapter-item expanded "><a href="../enumerate-databases/enumerate-databases.html"><strong aria-hidden="true">6.1.1.</strong> Databases</a></li><li class="chapter-item expanded "><a href="../enumerate-collections/enumerate-collections.html"><strong aria-hidden="true">6.1.2.</strong> Collections</a></li><li class="chapter-item expanded "><a href="../index-management/index-management.html"><strong aria-hidden="true">6.1.3.</strong> Indexes</a></li></ol></li><li class="chapter-item expanded "><div><strong aria-hidden="true">6.2.</strong> Data Management</div></li><li><ol class="section"><li class="chapter-item expanded "><a href="../crud/crud.html"><strong aria-hidden="true">6.2.1.</strong> CRUD</a></li><li class="chapter-item expanded "><a href="../collation/collation.html"><strong aria-hidden="true">6.2.2.</strong> Collation</a></li><li class="chapter-item expanded "><a href="../server_write_commands/server_write_commands.html" class="active"><strong aria-hidden="true">6.2.3.</strong> Write Commands</a></li><li class="chapter-item expanded "><a href="../driver-bulk-update.html"><strong aria-hidden="true">6.2.4.</strong> Bulk API</a></li><li class="chapter-item expanded "><a href="../crud/bulk-write.html"><strong aria-hidden="true">6.2.5.</strong> Bulk Write</a></li><li class="chapter-item expanded "><a href="../read-write-concern/read-write-concern.html"><strong aria-hidden="true">6.2.6.</strong> R/W Concern</a></li></ol></li><li class="chapter-item expanded "><div><strong aria-hidden="true">6.3.</strong> Cursors</div></li><li><ol class="section"><li class="chapter-item expanded "><a href="../change-streams/change-streams.html"><strong aria-hidden="true">6.3.1.</strong> Change Streams</a></li><li class="chapter-item expanded "><a href="../find_getmore_killcursors_commands/find_getmore_killcursors_commands.html"><strong aria-hidden="true">6.3.2.</strong> find/getMore/killCursors</a></li></ol></li><li class="chapter-item expanded "><a href="../gridfs/gridfs-spec.html"><strong aria-hidden="true">6.4.</strong> GridFS</a></li><li class="chapter-item expanded "><a href="../versioned-api/versioned-api.html"><strong aria-hidden="true">6.5.</strong> Stable API</a></li><li class="chapter-item expanded "><div><strong aria-hidden="true">6.6.</strong> Security</div></li><li><ol class="section"><li class="chapter-item expanded "><a href="../client-side-encryption/client-side-encryption.html"><strong aria-hidden="true">6.6.1.</strong> Client Side Encryption</a></li><li class="chapter-item expanded "><a href="../bson-binary-encrypted/binary-encrypted.html"><strong aria-hidden="true">6.6.2.</strong> BSON Binary Subtype 6</a></li></ol></li></ol></li><li class="chapter-item expanded "><li class="spacer"></li><li class="chapter-item expanded "><div><strong aria-hidden="true">7.</strong> Observability</div></li><li><ol class="section"><li class="chapter-item expanded "><a href="../command-logging-and-monitoring/command-logging-and-monitoring.html"><strong aria-hidden="true">7.1.</strong> Command Logging and Monitoring</a></li><li class="chapter-item expanded "><a href="../server-discovery-and-monitoring/server-discovery-and-monitoring-logging-and-monitoring.html"><strong aria-hidden="true">7.2.</strong> SDAM Logging and Monitoring</a></li><li class="chapter-item expanded "><a href="../logging/logging.html"><strong aria-hidden="true">7.3.</strong> Standardized Logging</a></li><li class="chapter-item expanded "><a href="../connection-monitoring-and-pooling/connection-monitoring-and-pooling.html"><strong aria-hidden="true">7.4.</strong> Connection Pool Logging</a></li></ol></li><li class="chapter-item expanded "><li class="spacer"></li><li class="chapter-item expanded "><div><strong aria-hidden="true">8.</strong> Testability</div></li><li><ol class="section"><li class="chapter-item expanded "><a href="../unified-test-format/unified-test-format.html"><strong aria-hidden="true">8.1.</strong> Unified Test Format</a></li><li class="chapter-item expanded "><a href="../atlas-data-lake-testing/tests/index.html"><strong aria-hidden="true">8.2.</strong> Atlas Data Federation Testing</a></li><li class="chapter-item expanded "><a href="../benchmarking/benchmarking.html"><strong aria-hidden="true">8.3.</strong> Performance Benchmarking</a></li><li class="chapter-item expanded "><a href="../bson-corpus/bson-corpus.html"><strong aria-hidden="true">8.4.</strong> BSON Corpus</a></li><li class="chapter-item expanded "><a href="../connections-survive-step-down/tests/index.html"><strong aria-hidden="true">8.5.</strong> Replication Event Resilience</a></li><li class="chapter-item expanded "><a href="../faas-automated-testing/faas-automated-testing.html"><strong aria-hidden="true">8.6.</strong> FAAS Automated Testing</a></li><li class="chapter-item expanded "><a href="../serverless-testing/index.html"><strong aria-hidden="true">8.7.</strong> Atlas Serverless Testing</a></li></ol></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <!-- Track and set sidebar scroll position -->
        <script>
            var sidebarScrollbox = document.querySelector('#sidebar .sidebar-scrollbox');
            sidebarScrollbox.addEventListener('click', function(e) {
                if (e.target.tagName === 'A') {
                    sessionStorage.setItem('sidebar-scroll', sidebarScrollbox.scrollTop);
                }
            }, { passive: true });
            var sidebarScrollTop = sessionStorage.getItem('sidebar-scroll');
            sessionStorage.removeItem('sidebar-scroll');
            if (sidebarScrollTop) {
                // preserve sidebar scroll position when navigating via links within sidebar
                sidebarScrollbox.scrollTop = sidebarScrollTop;
            } else {
                // scroll sidebar to current active section when navigating via "next/previous chapter" buttons
                var activeSection = document.querySelector('#sidebar .active');
                if (activeSection) {
                    activeSection.scrollIntoView({ block: 'center' });
                }
            }
        </script>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">MongoDB Driver Specifications</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="write-commands-specification"><a class="header" href="#write-commands-specification">Write Commands Specification</a></h1>
<ul>
<li>Status: Accepted</li>
<li>Minimum Server Version: 2.6</li>
</ul>
<hr />
<h2 id="goals"><a class="header" href="#goals">Goals</a></h2>
<ul>
<li>Method to do writes (insert/update/delete) that declares the write concern up front</li>
<li>Support for batch operations</li>
<li>As efficient as possible</li>
<li>getLastError is disallowed after anything except old style write ops</li>
</ul>
<h2 id="non-goals"><a class="header" href="#non-goals">Non-Goals</a></h2>
<ul>
<li>We're not specifying nor building any generic mechanism for feature discovery here</li>
<li>We're not specifying nor building any generic way to be backwards compatible</li>
</ul>
<h2 id="requests-format"><a class="header" href="#requests-format">Requests Format</a></h2>
<p>We use a very similar request format for all insert, update, and delete commands, described below. A request contains
parameters on how to apply the batch items and, of course, the batch items themselves.</p>
<h3 id="generic-fields"><a class="header" href="#generic-fields">Generic Fields</a></h3>
<ul>
<li><code>&lt;write op&gt;</code>: mandatory, with a string type, where <code>&lt;write op&gt;</code> can be <code>insert</code>, <code>update</code>, or <code>delete</code> and the content
string is a valid collection name against which the write should be directed. The <code>&lt;write op&gt;</code> must be the first key
in the document. For example:</li>
</ul>
<pre><code class="language-javascript">db.runCommand{ { update: "users", ...
</code></pre>
<ul>
<li><code>writeConcern</code>: optional, with a valid write concern BSONObj type, which contains the journaling, replication, and/or
time out parameters that will be used at the end of the batch application. The default write concern for a mongod
server can be set as a replica set configuration option, or if there is no replica set default the fallback is
<code>{ w: 1 }</code>. For example:</li>
</ul>
<pre><code class="language-javascript">..., writeConcern: { w: 2 }, ...
</code></pre>
<p>Note that the write concern will be issued at the end of the batch application.</p>
<p>We also support the "unusual" write concern: <code>{ w : 0 }</code>, which means the user is uninterested in the result of the
write at this time. In this protocol, there is no provision to ignore the response packet. The protocol, however, sends
a very condensed response when it sees that write concern (e.g. omits everything but the <code>ok</code> field).</p>
<ul>
<li><code>ordered</code>: optional, with a boolean type. If true, applies the batch's items in the same order the items appear, ie.
sequentially. If <code>ordered</code> is false, the server applies the batch items in no particular order -- possibly, in
parallel. The default value is true, sequential. For example:</li>
</ul>
<pre><code class="language-javascript">..., ordered: false, ...
</code></pre>
<ul>
<li>
<p><code>metadata</code>: RESERVED FOR MONGOS USE, future use.</p>
</li>
<li>
<p><code>failFast</code>: NOT YET USED, RESERVED FOR FUTURE USE. Optional, with a boolean type. If false, allows the batch to
continue processing even if some elements in the batch have errors. If true, the batch will stop on first error(s) it
detects (write concern will not be applied). Defaults to true for ordered batches, and false for unordered batches.</p>
</li>
</ul>
<h3 id="batch-items-format"><a class="header" href="#batch-items-format">Batch Items Format</a></h3>
<p>We describe the array of batch items to be applied according to which type of write operation we'd like to perform.</p>
<p><span id="insert"></span></p>
<ul>
<li>For inserts, <code>documents</code> array: mandatory, with an array of objects type. Objects must be valid for insertion. For
example:</li>
</ul>
<pre><code class="language-javascript">{ insert: "coll",
  documents: [ &lt;obj&gt;, &lt;obj&gt;, ... ],
  ...
}
</code></pre>
<p><span id="update"></span></p>
<ul>
<li>For updates, an <code>updates</code> array: mandatory, with an array of update objects type. Update objects must contain the
query expression <code>q</code>, an update expression <code>u</code> fields, and, optionally, a boolean <code>multi</code> if several documents may be
changed, and a boolean <code>upsert</code> if updates can become inserts. Both optional fields default to false. For example:</li>
</ul>
<pre><code class="language-javascript">{ update: "coll",
  updates: [
      { q : &lt;query&gt;, u : &lt;update&gt;, multi : &lt;multi&gt;, upsert : &lt;upsert&gt; },
      ...
  ],
  ...
}
</code></pre>
<p><span id="delete"></span></p>
<ul>
<li>for deletes a <code>deletes</code> array: mandatory, with an array of delete object type. For example:</li>
</ul>
<pre><code class="language-javascript">{ delete: "coll",
  deletes : [
      { q : &lt;query&gt;, limit : &lt;num&gt; },
      ...
  ],
  ...
}
</code></pre>
<p>Note that, to avoid accidentally deleting more documents than intended, we force the <code>limit</code> field to be present all the
time. When all documents that satisfy <code>q</code> should be deleted set <code>limit</code> to zero, as opposed to being omitted.</p>
<p>Note: The only valid values for <code>limit</code> is 1 and 0.</p>
<h3 id="request-size-limits"><a class="header" href="#request-size-limits">Request Size Limits</a></h3>
<p>Supporting unlimited batch sizes poses two problems - the BSONObj internal size limit is 16 MiB + 16 KiB (for command
overhead), and a small write operation may have a much larger response. In order to ensure a batch can be correctly
processed, two limits must be respected.</p>
<p>Both of these limits can be found using hello():</p>
<ul>
<li><code>maxBsonObjectSize</code> : currently 16 MiB, this is the maximum size of writes (excluding command overhead) that should be
sent to the server. Documents to be inserted, query documents for updates and deletes, and update expression documents
must be &lt;= this size. Once these documents have been assembled into a write command the total size may exceed
<code>maxBsonObjectSize</code> by a maximum of 16 KiB, allowing users to insert documents up to <code>maxBsonObjectSize</code>.</li>
<li><code>maxWriteBatchSize</code> : this is the maximum number of inserts, updates, or deletes that can be included in a write
batch. If more than this number of writes are included, the server cannot guarantee space in the response document to
reply to the batch.</li>
</ul>
<p>If the batch is too large in size or bytes, the command may fail.</p>
<h2 id="response-format"><a class="header" href="#response-format">Response Format</a></h2>
<p>There are two types of responses to any command:</p>
<ul>
<li>a <code>command failure</code>, which indicates the command itself did not complete successfully. Example command failures
include failure to authorize, failure to parse, operation aborted by user, and unexpected errors during execution
(these should be very rare).</li>
<li>successful command execution, which for write commands may include write errors.</li>
</ul>
<h3 id="command-failure-fields"><a class="header" href="#command-failure-fields">Command Failure Fields</a></h3>
<p>All commands have the same format when they fail unexpectedly:</p>
<p><code>{ ok : 0, code : &lt;error code&gt;, errmsg : &lt;human-readable string&gt; }</code></p>
<p>When a batch write command fails this way, like other commands, no guarantees are made about the state of the writes
which were sent. Particular error codes may indicate more about what occurred, but those codes are outside the scope of
this spec.</p>
<h3 id="general-response-fields"><a class="header" href="#general-response-fields">General Response Fields</a></h3>
<p>Again, like other commands, batch write commands return <code>{ ok : 1, ... }</code> when they complete successfully. Importantly,
successful execution of a batch write command may include reporting of unsuccessful writes (write errors) and write
concern application (write concern error).</p>
<p>The main body of a successful response is below:</p>
<p><span id="ok"></span></p>
<ul>
<li><code>ok</code>: Mandatory field, (double)"1" if operation was executed. Does not mean successfully. For example, duplicate key
error will still set ok = 1</li>
</ul>
<p><span id="n"></span></p>
<ul>
<li><code>n</code>: Mandatory field, with a positive numeric type or zero. This field contains the aggregated number of documents
successfully affected by the entire write command. This includes the number of documents inserted, upserted, updated,
and deleted. We do not report on the individual number of documents affected by each batch item. If the application
would wish so, then the application should issue one-item batches.</li>
</ul>
<p><span id="writeErrors"></span></p>
<ul>
<li><code>writeErrors</code>: Optional field, an array of write errors. For every batch write that had an error, there is one BSON
error document in the array describing the error. (See the <a href="#error-document">Error Document</a> section.)</li>
</ul>
<p><span id="writeConcernError"></span></p>
<ul>
<li><code>writeConcernError</code>: Optional field, which may contain a BSON error document indicating an error occurred while
applying the write concern (or an error indicating that the write concern was not applied). (See the
<a href="#error-document">Error Document</a> section.)</li>
</ul>
<h3 id="situational-fields"><a class="header" href="#situational-fields">Situational Fields</a></h3>
<p>We use the fields above for all responses, regardless of the request type. But some request types require additional
response information, as described below.</p>
<p><span id="nModified"></span></p>
<ul>
<li><code>nModified</code>: Optional field, with a positive numeric type or zero. Zero is the default value. This field is only and
always present for batch updates. <code>nModified</code> is the physical number of documents affected by an update, while <code>n</code> is
the logical number of documents matched by the update's query. For example, if we have 100 documents like :</li>
</ul>
<pre><code class="language-javascript">{ bizName: "McD", employees: ["Alice", "Bob", "Carol"] }
</code></pre>
<p>and we are adding a single new employee using <code>$addToSet</code> for each business document, <code>n</code> is useful to ensure all
businesses have been updated, and <code>nModified</code> is useful to know which businesses actually added a new employee.</p>
<p><span id="upserted"></span></p>
<ul>
<li><code>upserted</code>: Optional field, with an array type. If any upserts occurred in the batch, the array contains a BSON
document listing the <code>index</code> and <code>_id</code> of the newly upserted document in the database.</li>
</ul>
<p><span id="lastOp"></span></p>
<ul>
<li><code>lastOp</code>: MONGOD ONLY. Optional field, with a timestamp type, indicating the latest opTime on the server after all
documents were processed.</li>
<li><code>electionId</code>: MONGOD ONLY. Optional ObjectId field representing the last primary election Id.</li>
</ul>
<h3 id="error-document"><a class="header" href="#error-document">Error Document</a></h3>
<p>For a write error or a write concern error, the following fields will appear in the error document:</p>
<p><span id="code"></span></p>
<ul>
<li><code>code</code>: Mandatory field with integer format. Contains a numeric code corresponding to a certain type of error.</li>
</ul>
<p><span id="errInfo"></span></p>
<ul>
<li><code>errInfo</code>: Optional field, with a BSONObj format. This field contains structured information about an error that can
be processed programmatically. For example, if a request returns with a shard version error, we may report the proper
shard version as a sub-field here. For another example, if a write concern timeout occurred, the information
previously reported on <code>wtimeout</code> would be reported here. The format of this field depends on the code above.</li>
</ul>
<p><span id="errmsg"></span></p>
<ul>
<li><code>errmsg</code>: Mandatory field, containing a human-readable version of the error.</li>
</ul>
<p><span id="index"></span></p>
<ul>
<li><code>index</code>: WRITE ERROR ONLY. The index of the erroneous batch item relative to request batch order. Batch items indexes
start with 0.</li>
</ul>
<h2 id="examples"><a class="header" href="#examples">Examples</a></h2>
<h3 id="successful-case"><a class="header" href="#successful-case">Successful case</a></h3>
<p>Note that <code>ok: 1</code> by itself does <strong>not</strong> mean that an insert, update, or delete was executed successfully, just that the
batch was processed successfully. <code>ok: 1</code> merely means "all operations executed". <code>n</code> reports how many items from that
batch were affected by the operation.</p>
<h2 id="insert"><a class="header" href="#insert">Insert</a></h2>
<p>Request:</p>
<pre><code class="language-javascript">{ insert: "coll", documents: [ {a: 1} ] }
</code></pre>
<p>Response:</p>
<pre><code class="language-javascript">{ "ok" : 1, "n" : 1 }
</code></pre>
<p>Request:</p>
<pre><code class="language-javascript">{ insert: "coll", documents: [ {a: 1}, {b: 2}, {c: 3}, {d: 4} ] }
</code></pre>
<p>Response:</p>
<pre><code class="language-javascript">{ "ok" : 1, "n" : 4 }
</code></pre>
<h2 id="delete"><a class="header" href="#delete">Delete</a></h2>
<p>Request:</p>
<pre><code class="language-javascript">{ delete: "coll", deletes: [ { q: {b: 2}, limit: 1} ] }
</code></pre>
<p>Response:</p>
<pre><code class="language-javascript">{ "ok" : 1, "n" : 1 }
</code></pre>
<p>Request:</p>
<pre><code class="language-javascript">{
 delete: "coll",
 deletes:
 [
     {
         q: {a: 1},
         limit: 0
     },
     {
         q: {c: 3},
         limit: 1
     }
 ]
}
</code></pre>
<p>Response:</p>
<pre><code class="language-javascript">{ "ok" : 1, "n" : 3 }
</code></pre>
<h2 id="update"><a class="header" href="#update">Update</a></h2>
<p>Request:</p>
<pre><code class="language-javascript">{
  update: "coll",
  "updates":
  [
      {
          q: { d: 4 },
          u: { $set: {d: 5} }
      }
  ]
}
</code></pre>
<p>Response:</p>
<pre><code class="language-javascript">{ "ok" : 1, "nModified" : 1, "n" : 1 }
</code></pre>
<h3 id="checking-if-command-failed"><a class="header" href="#checking-if-command-failed">Checking if command failed</a></h3>
<p>To check if a write command failed:</p>
<pre><code class="language-python">if (ok == 0) {
  // The command itself failed (authentication failed.., syntax error)
} else if (writeErrors is array) {
  // Couldn't write the data (duplicate key.., out of disk space..)
} else if (writeConcernError is object) {
  // Operation took to long on secondary, hit wtimeout ...,
}
</code></pre>
<h3 id="command-failure-to-parse-or-authenticate"><a class="header" href="#command-failure-to-parse-or-authenticate">Command failure to parse or authenticate</a></h3>
<p>Request:</p>
<pre><code class="language-javascript">{ update: "coll",
  updates: [
    { q: {a:1}, x: {$set: {b: 2} } },
    { q: {a:2}, u: {$set: {c: 2} } }
  ]
}
</code></pre>
<p>Response:</p>
<pre><code class="language-javascript">{ ok: 0,
  code: &lt;number&gt;,
  errmsg: "Failed to parse batched update request, missing update expression 'u' field"
}

{ ok: 0,
  code: &lt;number&gt;,
  errmsg: "Not authorized to perform update"
}
</code></pre>
<p>Note that no information is given about command execution - if this was performed against a mongos, for example, the
batch may or may not have been partially applied - there is no programmatic way to determine this.</p>
<h3 id="write-concern-failure"><a class="header" href="#write-concern-failure">Write concern failure</a></h3>
<p>Request:</p>
<pre><code class="language-javascript">{ insert: "coll", documents: [ {a: 1}, {a:2} ], writeConcern: {w: 3, wtimeout: 100} }
</code></pre>
<p>Response:</p>
<pre><code class="language-javascript">{ ok: 1,
  n: 2,
  writeConcernError: {
    code : &lt;number&gt;,
    errInfo: { wtimeout : true },
    errmsg: "Could not replicate operation within requested timeout"
  }
}
</code></pre>
<h3 id="mixed-failures"><a class="header" href="#mixed-failures">Mixed failures</a></h3>
<p>Request:</p>
<pre><code class="language-javascript">db.coll.ensureIndex( {a:1}, {unique: true} )
{ insert: "coll",
  documents: [
    { a: 1 },
    { a: 1 },
    { a: 2 }
  ],
  ordered: false,
  writeConcern: { w: 3, wtimeout: 100 }
}
</code></pre>
<p>Response:</p>
<pre><code class="language-javascript">{ ok: 1,
  n: 2,
  writeErrors: [
    { index: 1,
      code: &lt;number&gt;,
      errmsg: "Attempt to insert duplicate key when unique index is present"
    }
  ],
  writeConcernError: {
    code: &lt;number&gt;,
    errInfo : { wtimeout : true },
    errmsg: "Could not replicate operation within requested timeout"
  }
}
</code></pre>
<p>Note that the field <code>n</code> in the response came back with 2, even though there are three items in the batch. This means
that there must be an entry in <code>writeErrors</code> for the item that failed. Note also that the request turned off <code>ordered</code>,
so the write concern error was hit when trying to replicate batch items 0 and 2.</p>
<p>Just to illustrate the support for <code>{w:0}</code>, here's how the response would look, had the request asked for that write
concern.</p>
<p>Response:</p>
<pre><code class="language-javascript">{ ok: 1 }
</code></pre>
<h2 id="faq"><a class="header" href="#faq">FAQ</a></h2>
<h3 id="why-are-_id-values-generated-client-side-by-default-for-new-documents"><a class="header" href="#why-are-_id-values-generated-client-side-by-default-for-new-documents">Why are <code>_id</code> values generated client-side by default for new documents?</a></h3>
<p>Though drivers may expose configuration options to prevent this behavior, by default a new <code>ObjectId</code> value will be
created client-side before an <code>insert</code> operation.</p>
<p>This design decision primarily stems from the fact that MongoDB is a distributed database and the typical unique
auto-incrementing scalar value most RDBMS' use for generating a primary key would not be robust enough, necessitating
the need for a more robust data type (<code>ObjectId</code> in this case). These <code>_id</code> values can be generated either on the client
or the server, however when done client-side a new document's <code>_id</code> value is immediately available for use without the
need for a network round trip.</p>
<p>Prior to MongoDB 3.6, an <code>insert</code> operation would use the <code>OP_INSERT</code> opcode of the wire protocol to send the operation,
and retrieve the results subsequently with a <code>getLastError</code> command. If client-side <code>_id</code> values were omitted, this
command response wouldn't contain the server-created <code>_id</code> values for new documents. Following MongoDB 3.6 when all
commands would be issued using the <code>OP_MSG</code> wire protocol opcode (<code>insert</code> included), the response to the command still
wouldn't contain the <code>_id</code> values for inserted documents.</p>
<h3 id="can-a-driver-still-use-the-op_insert-op_delete-op_update"><a class="header" href="#can-a-driver-still-use-the-op_insert-op_delete-op_update">Can a driver still use the <code>OP_INSERT</code>, <code>OP_DELETE</code>, <code>OP_UPDATE</code>?</a></h3>
<p>The
<a href="https://www.mongodb.com/docs/manual/release-notes/6.0-compatibility/#legacy-opcodes-removed">legacy opcodes were removed in MongoDB 6.0</a>.
As of MongoDB 3.6 these opcodes were superseded by
<a href="https://www.mongodb.com/docs/manual/reference/mongodb-wire-protocol/#op_msg">OP_MSG</a>, however all server versions up
until 6.0 continued to support the legacy opcodes.</p>
<h3 id="can-an-application-still-issue-requests-with-write-concerns-w-0"><a class="header" href="#can-an-application-still-issue-requests-with-write-concerns-w-0">Can an application still issue requests with write concerns {w: 0}?</a></h3>
<p>Yes. The drivers are still required to serve a {w:0} write concern by returning the control to the application as soon
as possible. But a driver should send the request to the server via a write command and should, therefore, take the
corresponding response off the wire -- even if the caller is not interested in that result.</p>
<h3 id="what-happens-if-a-driver-receives-a-write-request-against-an-old-server"><a class="header" href="#what-happens-if-a-driver-receives-a-write-request-against-an-old-server">What happens if a driver receives a write request against an old server?</a></h3>
<p>It must convert that request into write operations + gle's and use the old op codes.</p>
<h3 id="are-we-discontinuing-the-use-of-getlasterror"><a class="header" href="#are-we-discontinuing-the-use-of-getlasterror">Are we discontinuing the use of getLastError?</a></h3>
<p>Yes but as of 2.6 the existing getLastError behavior is supported for backward compatibility.</p>
<h2 id="changelog"><a class="header" href="#changelog">Changelog</a></h2>
<ul>
<li>
<p>2024-07-31: Migrated from reStructuredText to Markdown.</p>
</li>
<li>
<p>2024-06-04: Add FAQ entry outlining client-side <code>_id</code> value generation Update FAQ to indicate legacy opcodes were
removed</p>
</li>
<li>
<p>2022-10-05: Revise spec front matter and reformat changelog.</p>
</li>
<li>
<p>2022-07-25: Remove outdated value for <code>maxWriteBatchSize</code></p>
</li>
<li>
<p>2021-04-22: Updated to use hello command</p>
</li>
<li>
<p>2014-05-15: Removed text related to bulk operations; see the Bulk API spec for bulk details. Clarified some
paragraphs; re-ordered the response field sections.</p>
</li>
<li>
<p>2014-05-14: First public version</p>
</li>
</ul>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../collation/collation.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../driver-bulk-update.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../collation/collation.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../driver-bulk-update.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../elasticlunr.min.js"></script>
        <script src="../mark.min.js"></script>
        <script src="../searcher.js"></script>

        <script src="../clipboard.min.js"></script>
        <script src="../highlight.js"></script>
        <script src="../book.js"></script>

        <!-- Custom JS scripts -->


    </div>
    </body>
</html>
