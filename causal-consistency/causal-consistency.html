<!DOCTYPE HTML>
<html lang="en" class="light" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Causal Consistency - MongoDB Driver Specifications</title>


        <!-- Custom HTML head -->
        
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->

    </head>
    <body class="sidebar-visible no-js">
    <div id="body-container">
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('light')
            html.classList.add(theme);
            var body = document.querySelector('body');
            body.classList.remove('no-js')
            body.classList.add('js');
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var body = document.querySelector('body');
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            body.classList.remove('sidebar-visible');
            body.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="../index.html">Introduction</a></li><li class="chapter-item expanded affix "><a href="../driver-mantras.html">Mantras</a></li><li class="chapter-item expanded affix "><a href="../wireversion-featurelist/wireversion-featurelist.html">Wire Version Feature List</a></li><li class="chapter-item expanded affix "><li class="part-title">Specifications</li><li class="chapter-item expanded "><div><strong aria-hidden="true">1.</strong> Serialization</div></li><li><ol class="section"><li class="chapter-item expanded "><a href="../BSON.html"><strong aria-hidden="true">1.1.</strong> BSON</a></li><li class="chapter-item expanded "><a href="../bson-objectid/objectid.html"><strong aria-hidden="true">1.2.</strong> ObjectId</a></li><li class="chapter-item expanded "><a href="../bson-decimal128/decimal128.html"><strong aria-hidden="true">1.3.</strong> Decimal128</a></li><li class="chapter-item expanded "><a href="../bson-binary-uuid/uuid.html"><strong aria-hidden="true">1.4.</strong> UUID</a></li><li class="chapter-item expanded "><a href="../dbref/dbref.html"><strong aria-hidden="true">1.5.</strong> DBRef</a></li><li class="chapter-item expanded "><a href="../extended-json/extended-json.html"><strong aria-hidden="true">1.6.</strong> Extended JSON</a></li></ol></li><li class="chapter-item expanded "><li class="spacer"></li><li class="chapter-item expanded "><div><strong aria-hidden="true">2.</strong> Communication</div></li><li><ol class="section"><li class="chapter-item expanded "><a href="../message/OP_MSG.html"><strong aria-hidden="true">2.1.</strong> OP_MSG</a></li><li class="chapter-item expanded "><a href="../run-command/run-command.html"><strong aria-hidden="true">2.2.</strong> Command Execution</a></li><li class="chapter-item expanded "><a href="../connection-string/connection-string-spec.html"><strong aria-hidden="true">2.3.</strong> Connection String</a></li><li class="chapter-item expanded "><a href="../uri-options/uri-options.html"><strong aria-hidden="true">2.4.</strong> URI Options</a></li><li class="chapter-item expanded "><a href="../ocsp-support/ocsp-support.html"><strong aria-hidden="true">2.5.</strong> OCSP</a></li><li class="chapter-item expanded "><a href="../mongodb-handshake/handshake.html"><strong aria-hidden="true">2.6.</strong> Initial Handshake</a></li><li class="chapter-item expanded "><a href="../compression/OP_COMPRESSED.html"><strong aria-hidden="true">2.7.</strong> Wire Compression</a></li><li class="chapter-item expanded "><a href="../socks5-support/socks5.html"><strong aria-hidden="true">2.8.</strong> SOCKS5</a></li><li class="chapter-item expanded "><a href="../initial-dns-seedlist-discovery/initial-dns-seedlist-discovery.html"><strong aria-hidden="true">2.9.</strong> Initial DNS Seedlist Discovery</a></li></ol></li><li class="chapter-item expanded "><li class="spacer"></li><li class="chapter-item expanded "><div><strong aria-hidden="true">3.</strong> Connectivity</div></li><li><ol class="section"><li class="chapter-item expanded "><a href="../server-discovery-and-monitoring/server-discovery-and-monitoring.html"><strong aria-hidden="true">3.1.</strong> Server Discovery and Monitoring</a></li><li class="chapter-item expanded "><a href="../connection-monitoring-and-pooling/connection-monitoring-and-pooling.html"><strong aria-hidden="true">3.2.</strong> Connection Monitoring and Pooling</a></li><li class="chapter-item expanded "><a href="../load-balancers/load-balancers.html"><strong aria-hidden="true">3.3.</strong> Load Balancer Support</a></li></ol></li><li class="chapter-item expanded "><li class="spacer"></li><li class="chapter-item expanded "><div><strong aria-hidden="true">4.</strong> Availability</div></li><li><ol class="section"><li class="chapter-item expanded "><a href="../server-discovery-and-monitoring/server-monitoring.html"><strong aria-hidden="true">4.1.</strong> Server Monitoring</a></li><li class="chapter-item expanded "><a href="../polling-srv-records-for-mongos-discovery/polling-srv-records-for-mongos-discovery.html"><strong aria-hidden="true">4.2.</strong> SRV Polling for mongos Discovery</a></li><li class="chapter-item expanded "><a href="../server-selection/server-selection.html"><strong aria-hidden="true">4.3.</strong> Server Selection</a></li><li class="chapter-item expanded "><a href="../max-staleness/max-staleness.html"><strong aria-hidden="true">4.4.</strong> Max Staleness</a></li></ol></li><li class="chapter-item expanded "><li class="spacer"></li><li class="chapter-item expanded "><div><strong aria-hidden="true">5.</strong> Resilience</div></li><li><ol class="section"><li class="chapter-item expanded "><div><strong aria-hidden="true">5.1.</strong> Retryability</div></li><li><ol class="section"><li class="chapter-item expanded "><a href="../retryable-reads/retryable-reads.html"><strong aria-hidden="true">5.1.1.</strong> Reads</a></li><li class="chapter-item expanded "><a href="../retryable-writes/retryable-writes.html"><strong aria-hidden="true">5.1.2.</strong> Writes</a></li></ol></li><li class="chapter-item expanded "><a href="../client-side-operations-timeout/client-side-operations-timeout.html"><strong aria-hidden="true">5.2.</strong> CSOT</a></li><li class="chapter-item expanded "><div><strong aria-hidden="true">5.3.</strong> Consistency</div></li><li><ol class="section"><li class="chapter-item expanded "><a href="../sessions/driver-sessions.html"><strong aria-hidden="true">5.3.1.</strong> Sessions</a></li><li class="chapter-item expanded "><a href="../causal-consistency/causal-consistency.html" class="active"><strong aria-hidden="true">5.3.2.</strong> Causal Consistency</a></li><li class="chapter-item expanded "><a href="../sessions/snapshot-sessions.html"><strong aria-hidden="true">5.3.3.</strong> Snapshot Reads</a></li><li class="chapter-item expanded "><a href="../transactions/transactions.html"><strong aria-hidden="true">5.3.4.</strong> Transactions</a></li><li class="chapter-item expanded "><a href="../transactions-convenient-api/transactions-convenient-api.html"><strong aria-hidden="true">5.3.5.</strong> Convenient Transactions API</a></li></ol></li></ol></li><li class="chapter-item expanded "><li class="spacer"></li><li class="chapter-item expanded "><div><strong aria-hidden="true">6.</strong> Programmability</div></li><li><ol class="section"><li class="chapter-item expanded "><div><strong aria-hidden="true">6.1.</strong> Resource Management</div></li><li><ol class="section"><li class="chapter-item expanded "><a href="../enumerate-databases/enumerate-databases.html"><strong aria-hidden="true">6.1.1.</strong> Databases</a></li><li class="chapter-item expanded "><a href="../enumerate-collections/enumerate-collections.html"><strong aria-hidden="true">6.1.2.</strong> Collections</a></li><li class="chapter-item expanded "><a href="../index-management/index-management.html"><strong aria-hidden="true">6.1.3.</strong> Indexes</a></li></ol></li><li class="chapter-item expanded "><div><strong aria-hidden="true">6.2.</strong> Data Management</div></li><li><ol class="section"><li class="chapter-item expanded "><a href="../crud/crud.html"><strong aria-hidden="true">6.2.1.</strong> CRUD</a></li><li class="chapter-item expanded "><a href="../collation/collation.html"><strong aria-hidden="true">6.2.2.</strong> Collation</a></li><li class="chapter-item expanded "><a href="../server_write_commands/server_write_commands.html"><strong aria-hidden="true">6.2.3.</strong> Write Commands</a></li><li class="chapter-item expanded "><a href="../driver-bulk-update.html"><strong aria-hidden="true">6.2.4.</strong> Bulk API</a></li><li class="chapter-item expanded "><a href="../crud/bulk-write.html"><strong aria-hidden="true">6.2.5.</strong> Bulk Write</a></li><li class="chapter-item expanded "><a href="../read-write-concern/read-write-concern.html"><strong aria-hidden="true">6.2.6.</strong> R/W Concern</a></li></ol></li><li class="chapter-item expanded "><div><strong aria-hidden="true">6.3.</strong> Cursors</div></li><li><ol class="section"><li class="chapter-item expanded "><a href="../change-streams/change-streams.html"><strong aria-hidden="true">6.3.1.</strong> Change Streams</a></li><li class="chapter-item expanded "><a href="../find_getmore_killcursors_commands/find_getmore_killcursors_commands.html"><strong aria-hidden="true">6.3.2.</strong> find/getMore/killCursors</a></li></ol></li><li class="chapter-item expanded "><a href="../gridfs/gridfs-spec.html"><strong aria-hidden="true">6.4.</strong> GridFS</a></li><li class="chapter-item expanded "><a href="../versioned-api/versioned-api.html"><strong aria-hidden="true">6.5.</strong> Stable API</a></li><li class="chapter-item expanded "><div><strong aria-hidden="true">6.6.</strong> Security</div></li><li><ol class="section"><li class="chapter-item expanded "><a href="../client-side-encryption/client-side-encryption.html"><strong aria-hidden="true">6.6.1.</strong> Client Side Encryption</a></li><li class="chapter-item expanded "><a href="../bson-binary-encrypted/binary-encrypted.html"><strong aria-hidden="true">6.6.2.</strong> BSON Binary Subtype 6</a></li></ol></li></ol></li><li class="chapter-item expanded "><li class="spacer"></li><li class="chapter-item expanded "><div><strong aria-hidden="true">7.</strong> Observability</div></li><li><ol class="section"><li class="chapter-item expanded "><a href="../command-logging-and-monitoring/command-logging-and-monitoring.html"><strong aria-hidden="true">7.1.</strong> Command Logging and Monitoring</a></li><li class="chapter-item expanded "><a href="../server-discovery-and-monitoring/server-discovery-and-monitoring-logging-and-monitoring.html"><strong aria-hidden="true">7.2.</strong> SDAM Logging and Monitoring</a></li><li class="chapter-item expanded "><a href="../logging/logging.html"><strong aria-hidden="true">7.3.</strong> Standardized Logging</a></li><li class="chapter-item expanded "><a href="../connection-monitoring-and-pooling/connection-monitoring-and-pooling.html"><strong aria-hidden="true">7.4.</strong> Connection Pool Logging</a></li></ol></li><li class="chapter-item expanded "><li class="spacer"></li><li class="chapter-item expanded "><div><strong aria-hidden="true">8.</strong> Testability</div></li><li><ol class="section"><li class="chapter-item expanded "><a href="../unified-test-format/unified-test-format.html"><strong aria-hidden="true">8.1.</strong> Unified Test Format</a></li><li class="chapter-item expanded "><a href="../atlas-data-lake-testing/tests/index.html"><strong aria-hidden="true">8.2.</strong> Atlas Data Federation Testing</a></li><li class="chapter-item expanded "><a href="../benchmarking/benchmarking.html"><strong aria-hidden="true">8.3.</strong> Performance Benchmarking</a></li><li class="chapter-item expanded "><a href="../bson-corpus/bson-corpus.html"><strong aria-hidden="true">8.4.</strong> BSON Corpus</a></li><li class="chapter-item expanded "><a href="../connections-survive-step-down/tests/index.html"><strong aria-hidden="true">8.5.</strong> Replication Event Resilience</a></li><li class="chapter-item expanded "><a href="../faas-automated-testing/faas-automated-testing.html"><strong aria-hidden="true">8.6.</strong> FAAS Automated Testing</a></li><li class="chapter-item expanded "><a href="../serverless-testing/index.html"><strong aria-hidden="true">8.7.</strong> Atlas Serverless Testing</a></li></ol></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <!-- Track and set sidebar scroll position -->
        <script>
            var sidebarScrollbox = document.querySelector('#sidebar .sidebar-scrollbox');
            sidebarScrollbox.addEventListener('click', function(e) {
                if (e.target.tagName === 'A') {
                    sessionStorage.setItem('sidebar-scroll', sidebarScrollbox.scrollTop);
                }
            }, { passive: true });
            var sidebarScrollTop = sessionStorage.getItem('sidebar-scroll');
            sessionStorage.removeItem('sidebar-scroll');
            if (sidebarScrollTop) {
                // preserve sidebar scroll position when navigating via links within sidebar
                sidebarScrollbox.scrollTop = sidebarScrollTop;
            } else {
                // scroll sidebar to current active section when navigating via "next/previous chapter" buttons
                var activeSection = document.querySelector('#sidebar .active');
                if (activeSection) {
                    activeSection.scrollIntoView({ block: 'center' });
                }
            }
        </script>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">MongoDB Driver Specifications</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="causal-consistency-specification"><a class="header" href="#causal-consistency-specification">Causal Consistency Specification</a></h1>
<ul>
<li>Status: Accepted</li>
<li>Minimum Server Version: 3.6</li>
</ul>
<hr />
<h2 id="abstract"><a class="header" href="#abstract">Abstract</a></h2>
<p>Version 3.6 of the server introduces support for causal consistency. This spec builds upon the Sessions Specification to
define how an application requests causal consistency and how a driver interacts with the server to implement causal
consistency.</p>
<h2 id="definitions"><a class="header" href="#definitions">Definitions</a></h2>
<h3 id="meta"><a class="header" href="#meta">META</a></h3>
<p>The keywords "MUST", "MUST NOT", "REQUIRED", "SHALL", "SHALL NOT", "SHOULD", "SHOULD NOT", "RECOMMENDED", "MAY", and
"OPTIONAL" in this document are to be interpreted as described in <a href="https://www.ietf.org/rfc/rfc2119.txt">RFC 2119</a>.</p>
<h3 id="terms"><a class="header" href="#terms">Terms</a></h3>
<p><strong>Causal consistency</strong></p>
<p>A property that guarantees that an application can read its own writes and that a later read will never observe a
version of the data that is older than an earlier read.</p>
<p><strong>ClientSession</strong></p>
<p>The driver object representing a client session and the operations that can be performed on it.</p>
<p><strong>Cluster time</strong></p>
<p>The current cluster time. The server reports its view of the current cluster time in the <code>$clusterTime</code> field in
responses from the server and the driver participates in distributing the current cluster time to all nodes (called
"gossipping the cluster time") by sending the highest <code>$clusterTime</code> it has seen so far in messages it sends to mongos
servers. The current cluster time is a logical time, but is digitally signed to prevent malicious clients from
propagating invalid cluster times. Cluster time is only used in replica sets and sharded clusters.</p>
<p><strong>Logical time</strong></p>
<p>A time-like quantity that can be used to determine the order in which events occurred. Logical time is represented as a
BsonTimestamp.</p>
<p><strong>MongoClient</strong></p>
<p>The root object of a driver's API. MAY be named differently in some drivers.</p>
<p><strong>MongoCollection</strong></p>
<p>The driver object representing a collection and the operations that can be performed on it. MAY be named differently in
some drivers.</p>
<p><strong>MongoDatabase</strong></p>
<p>The driver object representing a database and the operations that can be performed on it. MAY be named differently in
some drivers.</p>
<p><strong>Operation time</strong></p>
<p>The logical time at which an operation occurred. The server reports the operation time in the response to all commands,
including error responses. The operation time by definition is always less than or equal to the cluster time. Operation
times are tracked on a per <code>ClientSession</code> basis, so the <code>operationTime</code> of each <code>ClientSession</code> corresponds to the time
of the last operation performed in that particular <code>ClientSession</code>.</p>
<p><strong>ServerSession</strong></p>
<p>The driver object representing a server session.</p>
<p><strong>Session</strong></p>
<p>A session is an abstract concept that represents a set of sequential operations executed by an application that are
related in some way. This specification defines how sessions are used to implement causal consistency.</p>
<p><strong>Unacknowledged writes</strong></p>
<p>Unacknowledged writes are write operations that are sent to the server without waiting for a reply acknowledging the
write. See the "Unacknowledged Writes" section below for information on how unacknowledged writes interact with causal
consistency.</p>
<h2 id="specification"><a class="header" href="#specification">Specification</a></h2>
<p>An application requests causal consistency by creating a <code>ClientSession</code> with options that specify that causal
consistency is desired. An application then passes the session as an argument to methods in the <code>MongoDatabase</code> and
<code>MongoCollection</code> classes. Any operations performed against that session will then be causally consistent.</p>
<h2 id="naming-variations"><a class="header" href="#naming-variations">Naming variations</a></h2>
<p>This specification defines names for new methods and types. To the extent possible you SHOULD use these names in your
driver. However, where your driver's and/or language's naming conventions differ you SHOULD continue to use them
instead. For example, you might use <code>StartSession</code> or <code>start_session</code> instead of <code>startSession</code>.</p>
<h2 id="high-level-summary-of-the-api-changes-for-causal-consistency"><a class="header" href="#high-level-summary-of-the-api-changes-for-causal-consistency">High level summary of the API changes for causal consistency</a></h2>
<p>Causal consistency is built on top of client sessions.</p>
<p>Applications will start a new client session for causal consistency like this:</p>
<pre><code class="language-typescript">options = new SessionOptions(causalConsistency = true);
session = client.startSession(options);
</code></pre>
<p>All read operations performed using this session will now be causally consistent.</p>
<p>If no value is provided for <code>causalConsistency</code> and snapshot reads are not requested a value of true is implied. See the
<code>causalConsistency</code> section.</p>
<h2 id="mongoclient-changes"><a class="header" href="#mongoclient-changes">MongoClient changes</a></h2>
<p>There are no API changes to <code>MongoClient</code> to support causal consistency. Applications indicate whether they want causal
consistency by setting the <code>causalConsistency</code> field in the options passed to the <code>startSession</code> method.</p>
<h2 id="sessionoptions-changes"><a class="header" href="#sessionoptions-changes">SessionOptions changes</a></h2>
<p><code>SessionOptions</code> change summary</p>
<pre><code class="language-typescript">class SessionOptions {
    Optional&lt;bool&gt; causalConsistency;

    // other options defined by other specs
}
</code></pre>
<p>In order to support causal consistency a new property named <code>causalConsistency</code> is added to <code>SessionOptions</code>.
Applications set <code>causalConsistency</code> when starting a client session to indicate whether they want causal consistency.
All read operations performed using that client session are then causally consistent.</p>
<p>Each new member is documented below.</p>
<h3 id="causalconsistency"><a class="header" href="#causalconsistency">causalConsistency</a></h3>
<p>Applications set <code>causalConsistency</code> when starting a session to indicate whether they want causal consistency.</p>
<p>Note that the <code>causalConsistency</code> property is optional. For explicit sessions, the default value of this property is
<code>not supplied</code>. If no value is supplied for <code>causalConsistency</code> the value will be inherited. Currently it is inherited
from the global default which is defined to be true. In the future it <em>might</em> be inherited from client settings. For
implicit sessions, the value of this property MUST be set to <code>false</code> in order to avoid potential conflicts with an
operation's read concern level.</p>
<p>Causal consistency is provided at the session level by tracking the <code>clusterTime</code> and <code>operationTime</code> for each session.
In some cases an application may wish subsequent operations in one session to be causally consistent with operations
that were executed in a different session. In that case the application can call the <code>advanceClusterTime</code> and
<code>advanceOperationTime</code> methods in <code>ClientSession</code> to advance the <code>clusterTime</code> and <code>operationTime</code> of one session to the
<code>clusterTime</code> and <code>operationTime</code> from another session.</p>
<h2 id="clientsession-changes"><a class="header" href="#clientsession-changes">ClientSession changes</a></h2>
<p><code>ClientSession</code> changes summary</p>
<pre><code class="language-typescript">interface ClientSession {
    Optional&lt;BsonTimestamp&gt; operationTime;

    void advanceOperationTime(BsonTimestamp operationTime);

    // other members as defined in other specs
}
</code></pre>
<p>Each new member is documented below.</p>
<h3 id="operationtime"><a class="header" href="#operationtime">operationTime</a></h3>
<p>This property returns the operation time of the most recent operation performed using this session. If no operations
have been performed using this session the value will be null unless <code>advanceOperationTime</code> has been called. This value
will also be null when the cluster does not report operation times.</p>
<h3 id="advanceoperationtime"><a class="header" href="#advanceoperationtime">advanceOperationTime</a></h3>
<p>This method advances the <code>operationTime</code> for a session. If the new <code>operationTime</code> is greater than the session's current
<code>operationTime</code> then the session's <code>operationTime</code> MUST be advanced to the new <code>operationTime</code>. If the new
<code>operationTime</code> is less than or equal to the session's current <code>operationTime</code> then the session's <code>operationTime</code> MUST
NOT be changed.</p>
<p>Drivers MUST NOT attempt to validate the supplied <code>operationTime</code>. While the server requires that <code>operationTime</code> be
less than or equal to <code>clusterTime</code> we don't want to check that when <code>advanceOperationTime</code> is called. This allows an
application to call <code>advanceClusterTime</code> and <code>advanceOperationTime</code> in any order, or perhaps to not call
<code>advanceClusterTime</code> at all and let the <code>clusterTime</code> that is sent to the server be implied by the <code>clusterTime</code> in
<code>MongoClient</code>.</p>
<h2 id="mongodatabase-changes"><a class="header" href="#mongodatabase-changes">MongoDatabase changes</a></h2>
<p>There are no additional API changes to <code>MongoDatabase</code> beyond those specified in the Sessions Specification. All
<code>MongoDatabase</code> methods that talk to the server have been overloaded to take a session parameter. If that session was
started with <code>causalConsistency = true</code> then all operations using that session will be causally consistent.</p>
<h2 id="mongocollection-changes"><a class="header" href="#mongocollection-changes">MongoCollection changes</a></h2>
<p>There are no additional API changes to <code>MongoCollection</code> beyond those specified in the Sessions Specification. All
<code>MongoCollection</code> methods that talk to the server have been overloaded to take a session parameter. If that session was
started with <code>causalConsistency = true</code> then all operations using that session will be causally consistent.</p>
<h2 id="server-commands"><a class="header" href="#server-commands">Server Commands</a></h2>
<p>There are no new server commands related to causal consistency. Instead, causal consistency is implemented by:</p>
<ol>
<li>Saving the <code>operationTime</code> returned by 3.6+ servers for all operations in a property of the <code>ClientSession</code> object.
The server reports the <code>operationTime</code> whether the operation succeeded or not and drivers MUST save the
<code>operationTime</code> in the <code>ClientSession</code> whether the operation succeeded or not.</li>
<li>Passing that <code>operationTime</code> in the <code>afterClusterTime</code> field of the <code>readConcern</code> field for subsequent causally
consistent read operations (for all commands that support a <code>readConcern</code>)</li>
<li>Gossiping clusterTime (described in the Driver Session Specification)</li>
</ol>
<h2 id="server-command-responses"><a class="header" href="#server-command-responses">Server Command Responses</a></h2>
<p>To support causal consistency the server returns the <code>operationTime</code> in responses it sends to the driver (for both read
and write operations).</p>
<pre><code class="language-typescript">{
    ok : 1 or 0,
    ... // the rest of the command reply
    operationTime : &lt;BsonTimestamp&gt;
    $clusterTime : &lt;BsonDocument&gt; // only in deployments that support cluster times
}
</code></pre>
<p>The <code>operationTime</code> MUST be stored in the <code>ClientSession</code> to later be passed as the <code>afterClusterTime</code> field of the
<code>readConcern</code> field in subsequent read operations. The <code>operationTime</code> is returned whether the command succeeded or not
and MUST be stored in either case.</p>
<p>Drivers MUST examine all responses from the server for the presence of an <code>operationTime</code> field and store the value in
the <code>ClientSession</code>.</p>
<p>When connected to a standalone node command replies do not include an <code>operationTime</code> field. All operations against a
standalone node are causally consistent automatically because there is only one node.</p>
<p>When connected to a deployment that supports cluster times the command response also includes a field called
<code>$clusterTime</code> that drivers MUST use to gossip the cluster time. See the Sessions Specification for details.</p>
<h2 id="causally-consistent-read-commands"><a class="header" href="#causally-consistent-read-commands">Causally consistent read commands</a></h2>
<p>For causal consistency the driver MUST send the <code>operationTime</code> saved in the <code>ClientSession</code> as the value of the
<code>afterClusterTime</code> field of the <code>readConcern</code> field:</p>
<pre><code class="language-typescript">{
    find : &lt;string&gt;, // or other read command
    ... // the rest of the command parameters
    readConcern :
    {
        level : ..., // from the operation's read concern (only if specified)
        afterClusterTime : &lt;BsonTimestamp&gt;
    }
}
</code></pre>
<p>For the lists of commands that support causally consistent reads, see
<a href="../read-write-concern/read-write-concern.html#read-concern">ReadConcern</a> spec.</p>
<p>The driver MUST merge the <code>ReadConcern</code> specified for the operation with the <code>operationTime</code> from the <code>ClientSession</code>
(which goes in the <code>afterClusterTime</code> field) to generate the combined <code>readConcern</code> to send to the server. If the level
property of the read concern for the operation is null then the driver MUST NOT include a <code>level</code> field alongside the
<code>afterClusterTime</code> of the <code>readConcern</code> value sent to the server. Drivers MUST NOT attempt to verify whether the server
supports causally consistent reads or not for a given read concern level. The server will return an error if a given
level does not support causal consistency.</p>
<p>The Read and Write Concern specification states that when a user has not specified a <code>ReadConcern</code> or has specified the
server's default <code>ReadConcern</code>, drivers MUST omit the <code>ReadConcern</code> parameter when sending the command. For causally
consistent reads this requirement is modified to state that when the <code>ReadConcern</code> parameter would normally be omitted
drivers MUST send a <code>ReadConcern</code> after all because that is how the <code>afterClusterTime</code> value is sent to the server.</p>
<p>The Read and Write Concern Specification states that drivers MUST NOT add a <code>readConcern</code> field to commands that are run
using a generic <code>runCommand</code> method. The same is true for causal consistency, so commands that are run using
<code>runCommand</code> MUST NOT have an <code>afterClusterTime</code> field added to them.</p>
<p>When executing a causally consistent read, the <code>afterClusterTime</code> field MUST be sent when connected to a deployment that
supports cluster times, and MUST NOT be sent when connected to a deployment that does not support cluster times.</p>
<h2 id="unacknowledged-writes"><a class="header" href="#unacknowledged-writes">Unacknowledged writes</a></h2>
<p>The implementation of causal consistency relies on the <code>operationTime</code> returned by the server in the acknowledgement of
a write. Since unacknowledged writes don't receive a response from the server (or don't wait for a response) the
<code>ClientSession</code>'s <code>operationTime</code> is not updated after an unacknowledged write. That means that a causally consistent
read after an unacknowledged write cannot be causally consistent with the unacknowledged write. Rather than prohibiting
unacknowledged writes in a causally consistent session we have decided to accept this limitation. Drivers MUST document
that causally consistent reads are not causally consistent with unacknowledged writes.</p>
<h2 id="test-plan"><a class="header" href="#test-plan">Test Plan</a></h2>
<p>Below is a list of test cases to write.</p>
<p>Note: some tests are only relevant to certain deployments. For the purpose of deciding which tests to run assume that
any deployment that is version 3.6 or higher and is either a replica set or a sharded cluster supports cluster times.</p>
<ol>
<li>When a <code>ClientSession</code> is first created the <code>operationTime</code> has no value.
<ul>
<li><code>session = client.startSession()</code></li>
<li>assert <code>session.operationTime</code> has no value</li>
</ul>
</li>
<li>The first read in a causally consistent session must not send <code>afterClusterTime</code> to the server (because the
<code>operationTime</code> has not yet been determined)
<ul>
<li><code>session = client.startSession(causalConsistency = true)</code></li>
<li><code>document = collection.anyReadOperation(session, ...)</code></li>
<li>capture the command sent to the server (using APM or other mechanism)</li>
<li>assert that the command does not have an <code>afterClusterTime</code></li>
</ul>
</li>
<li>The first read or write on a <code>ClientSession</code> should update the <code>operationTime</code> of the <code>ClientSession</code>, even if there
is an error.
<ul>
<li>skip this test if connected to a deployment that does not support cluster times</li>
<li><code>session = client.startSession() // with or without causal consistency</code></li>
<li><code>collection.anyReadOrWriteOperation(session, ...) // test with errors also if possible</code></li>
<li>capture the response sent from the server (using APM or other mechanism)</li>
<li>assert <code>session.operationTime</code> has the same value that is in the response from the server</li>
</ul>
</li>
<li>A <code>findOne</code> followed by any other read operation (test them all) should include the <code>operationTime</code> returned by the
server for the first operation in the <code>afterClusterTime</code> parameter of the second operation
<ul>
<li>skip this test if connected to a deployment that does not support cluster times</li>
<li><code>session = client.startSession(causalConsistency = true)</code></li>
<li><code>collection.findOne(session, {})</code></li>
<li><code>operationTime = session.operationTime</code></li>
<li><code>collection.anyReadOperation(session, ...)</code></li>
<li>capture the command sent to the server (using APM or other mechanism)</li>
<li>assert that the command has an <code>afterClusterTime</code> field with a value of <code>operationTime</code></li>
</ul>
</li>
<li>Any write operation (test them all) followed by a <code>findOne</code> operation should include the <code>operationTime</code> of the
first operation in the <code>afterClusterTime</code> parameter of the second operation, including the case where the first
operation returned an error.
<ul>
<li>skip this test if connected to a deployment that does not support cluster times</li>
<li><code>session = client.startSession(causalConsistency = true)</code></li>
<li><code>collection.anyWriteOperation(session, ...) // test with errors also where possible</code></li>
<li><code>operationTime = session.operationTime</code></li>
<li><code>collection.findOne(session, {})</code></li>
<li>capture the command sent to the server (using APM or other mechanism)</li>
<li>assert that the command has an <code>afterClusterTime</code> field with a value of <code>operationTime</code></li>
</ul>
</li>
<li>A read operation in a <code>ClientSession</code> that is not causally consistent should not include the <code>afterClusterTime</code>
parameter in the command sent to the server.
<ul>
<li>skip this test if connected to a deployment that does not support cluster times</li>
<li><code>session = client.startSession(causalConsistency = false)</code></li>
<li><code>collection.anyReadOperation(session, {})</code></li>
<li><code>operationTime = session.operationTime</code></li>
<li>capture the command sent to the server (using APM or other mechanism)</li>
<li>assert that the command does not have an <code>afterClusterTime</code> field</li>
</ul>
</li>
<li>A read operation in a causally consistent session against a deployment that does not support cluster times does not
include the <code>afterClusterTime</code> parameter in the command sent to the server.
<ul>
<li>skip this test if connected to a deployment that does support cluster times</li>
<li><code>session = client.startSession(causalConsistency = true)</code></li>
<li><code>collection.anyReadOperation(session, {})</code></li>
<li>capture the command sent to the server (using APM or other mechanism)</li>
<li>assert that the command does not have an <code>afterClusterTime</code> field</li>
</ul>
</li>
<li>When using the default server <code>ReadConcern</code> the <code>readConcern</code> parameter in the command sent to the server should not
include a <code>level</code> field.
<ul>
<li>skip this test if connected to a deployment that does not support cluster times</li>
<li><code>session = client.startSession(causalConsistency = true)</code></li>
<li>configure <code>collection</code> to use default server <code>ReadConcern</code></li>
<li><code>collection.findOne(session, {})</code></li>
<li><code>operationTime = session.operationTime</code></li>
<li><code>collection.anyReadOperation(session, ...)</code></li>
<li>capture the command sent to the server (using APM or other mechanism)</li>
<li>assert that the command does not have a <code>`level</code> field</li>
<li>assert that the command has a <code>afterClusterTime</code> field with a value of <code>operationTime</code></li>
</ul>
</li>
<li>When using a custom <code>ReadConcern</code> the <code>readConcern</code> field in the command sent to the server should be a merger of
the <code>ReadConcern</code> value and the <code>afterClusterTime</code> field.
<ul>
<li>skip this test if connected to a deployment that does not support cluster times</li>
<li><code>session = client.startSession(causalConsistency = true)</code></li>
<li>configure collection to use a custom ReadConcern</li>
<li><code>collection.findOne(session, {})</code></li>
<li><code>operationTime = session.operationTime</code></li>
<li><code>collection.anyReadOperation(session, ...)</code></li>
<li>capture the command sent to the server (using APM or other mechanism)</li>
<li>assert that the command has a <code>level</code> field with a value matching the custom readConcern</li>
<li>assert that the command has an <code>afterClusterTime</code> field with a value of <code>operationTime</code></li>
</ul>
</li>
<li><strong>Removed</strong></li>
<li>When connected to a deployment that does not support cluster times messages sent to the server should not include
<code>$clusterTime</code>.
<ul>
<li>skip this test when connected to a deployment that does support cluster times</li>
<li><code>document = collection.findOne({})</code></li>
<li>capture the command sent to the server</li>
<li>assert that the command does not include a <code>$clusterTime</code> field</li>
</ul>
</li>
<li>When connected to a deployment that does support cluster times messages sent to the server should include
<code>$clusterTime</code>.
<ul>
<li>skip this test when connected to a deployment that does not support cluster times</li>
<li><code>document = collection.findOne({})</code></li>
<li>capture the command sent to the server</li>
<li>assert that the command includes a <code>$clusterTime</code> field</li>
</ul>
</li>
</ol>
<h2 id="motivation"><a class="header" href="#motivation">Motivation</a></h2>
<p>To support causal consistency. Only supported with server version 3.6 or newer.</p>
<h2 id="design-rationale"><a class="header" href="#design-rationale">Design Rationale</a></h2>
<p>The goal is to modify the driver API as little as possible so that existing programs that don't need causal consistency
don't have to be changed. This goal is met by defining a <code>SessionOptions</code> field that applications use to start a
<code>ClientSession</code> that can be used for causal consistency. Any operations performed with such a session are then causally
consistent.</p>
<p>The <code>operationTime</code> is tracked on a per <code>ClientSession</code> basis. This allows each <code>ClientSession</code> to have an
<code>operationTime</code> that is sufficiently new to guarantee causal consistency for that session, but no newer. Using an
<code>operationTime</code> that is newer than necessary can cause reads to block longer than necessary when sent to a lagging
secondary. The goal is to block for just long enough to guarantee causal consistency and no longer.</p>
<h2 id="backwards-compatibility"><a class="header" href="#backwards-compatibility">Backwards Compatibility</a></h2>
<p>The API changes to support sessions extend the existing API but do not introduce any backward breaking changes. Existing
programs that don't use causal consistency continue to compile and run correctly.</p>
<h2 id="reference-implementation"><a class="header" href="#reference-implementation">Reference Implementation</a></h2>
<p>A reference implementation must be completed before any spec is given status "Final", but it need not be completed
before the spec is "Accepted". While there is merit to the approach of reaching consensus on the specification and
rationale before writing code, the principle of "rough consensus and running code" is still useful when it comes to
resolving many discussions of spec details. A final reference implementation must include test code and documentation.</p>
<h2 id="qa"><a class="header" href="#qa">Q&amp;A</a></h2>
<h2 id="changelog"><a class="header" href="#changelog">Changelog</a></h2>
<ul>
<li>
<p>2024-02-08: Migrated from reStructuredText to Markdown.</p>
</li>
<li>
<p>2022-11-11: Require <code>causalConsistency=false</code> for implicit sessions.</p>
</li>
<li>
<p>2022-10-05: Remove spec front matter and reformat changelog.</p>
</li>
<li>
<p>2022-01-28: Fix formatting for prose tests</p>
</li>
<li>
<p>2022-01-22: Remove outdated prose test #10</p>
</li>
<li>
<p>2021-06-26: Default value for causalConsistency is influenced by snapshot reads</p>
</li>
<li>
<p>2017-11-17: Added link to ReadConcern spec which lists commands that support readConcern</p>
</li>
<li>
<p>2017-10-06: advanceOperationTime MUST NOT validate operationTime</p>
</li>
<li>
<p>2017-10-05: How to handle default read concern</p>
</li>
<li>
<p>2017-10-04: Added advanceOperationTime</p>
</li>
<li>
<p>2017-09-28: Remove remaining references to collections being associated with sessions. Update spec to reflect that
replica sets use $clusterTime also now.</p>
</li>
<li>
<p>2017-09-13: Renamed "causally consistent reads" to "causal consistency". If no value is supplied for
<code>causallyConsistent</code> assume true.</p>
</li>
</ul>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../sessions/driver-sessions.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../sessions/snapshot-sessions.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../sessions/driver-sessions.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../sessions/snapshot-sessions.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../elasticlunr.min.js"></script>
        <script src="../mark.min.js"></script>
        <script src="../searcher.js"></script>

        <script src="../clipboard.min.js"></script>
        <script src="../highlight.js"></script>
        <script src="../book.js"></script>

        <!-- Custom JS scripts -->


    </div>
    </body>
</html>
