<!DOCTYPE HTML>
<html lang="en" class="light" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>OP_MSG - MongoDB Driver Specifications</title>


        <!-- Custom HTML head -->
        
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->

    </head>
    <body class="sidebar-visible no-js">
    <div id="body-container">
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('light')
            html.classList.add(theme);
            var body = document.querySelector('body');
            body.classList.remove('no-js')
            body.classList.add('js');
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var body = document.querySelector('body');
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            body.classList.remove('sidebar-visible');
            body.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="../index.html">Introduction</a></li><li class="chapter-item expanded affix "><a href="../driver-mantras.html">Mantras</a></li><li class="chapter-item expanded affix "><a href="../wireversion-featurelist/wireversion-featurelist.html">Wire Version Feature List</a></li><li class="chapter-item expanded affix "><li class="part-title">Specifications</li><li class="chapter-item expanded "><div><strong aria-hidden="true">1.</strong> Serialization</div></li><li><ol class="section"><li class="chapter-item expanded "><a href="../BSON.html"><strong aria-hidden="true">1.1.</strong> BSON</a></li><li class="chapter-item expanded "><a href="../bson-objectid/objectid.html"><strong aria-hidden="true">1.2.</strong> ObjectId</a></li><li class="chapter-item expanded "><a href="../bson-decimal128/decimal128.html"><strong aria-hidden="true">1.3.</strong> Decimal128</a></li><li class="chapter-item expanded "><a href="../bson-binary-uuid/uuid.html"><strong aria-hidden="true">1.4.</strong> UUID</a></li><li class="chapter-item expanded "><a href="../dbref/dbref.html"><strong aria-hidden="true">1.5.</strong> DBRef</a></li><li class="chapter-item expanded "><a href="../extended-json/extended-json.html"><strong aria-hidden="true">1.6.</strong> Extended JSON</a></li></ol></li><li class="chapter-item expanded "><li class="spacer"></li><li class="chapter-item expanded "><div><strong aria-hidden="true">2.</strong> Communication</div></li><li><ol class="section"><li class="chapter-item expanded "><a href="../message/OP_MSG.html" class="active"><strong aria-hidden="true">2.1.</strong> OP_MSG</a></li><li class="chapter-item expanded "><a href="../run-command/run-command.html"><strong aria-hidden="true">2.2.</strong> Command Execution</a></li><li class="chapter-item expanded "><a href="../connection-string/connection-string-spec.html"><strong aria-hidden="true">2.3.</strong> Connection String</a></li><li class="chapter-item expanded "><a href="../uri-options/uri-options.html"><strong aria-hidden="true">2.4.</strong> URI Options</a></li><li class="chapter-item expanded "><a href="../ocsp-support/ocsp-support.html"><strong aria-hidden="true">2.5.</strong> OCSP</a></li><li class="chapter-item expanded "><a href="../mongodb-handshake/handshake.html"><strong aria-hidden="true">2.6.</strong> Initial Handshake</a></li><li class="chapter-item expanded "><a href="../compression/OP_COMPRESSED.html"><strong aria-hidden="true">2.7.</strong> Wire Compression</a></li><li class="chapter-item expanded "><a href="../socks5-support/socks5.html"><strong aria-hidden="true">2.8.</strong> SOCKS5</a></li><li class="chapter-item expanded "><a href="../initial-dns-seedlist-discovery/initial-dns-seedlist-discovery.html"><strong aria-hidden="true">2.9.</strong> Initial DNS Seedlist Discovery</a></li></ol></li><li class="chapter-item expanded "><li class="spacer"></li><li class="chapter-item expanded "><div><strong aria-hidden="true">3.</strong> Connectivity</div></li><li><ol class="section"><li class="chapter-item expanded "><a href="../server-discovery-and-monitoring/server-discovery-and-monitoring.html"><strong aria-hidden="true">3.1.</strong> Server Discovery and Monitoring</a></li><li class="chapter-item expanded "><a href="../connection-monitoring-and-pooling/connection-monitoring-and-pooling.html"><strong aria-hidden="true">3.2.</strong> Connection Monitoring and Pooling</a></li><li class="chapter-item expanded "><a href="../load-balancers/load-balancers.html"><strong aria-hidden="true">3.3.</strong> Load Balancer Support</a></li></ol></li><li class="chapter-item expanded "><li class="spacer"></li><li class="chapter-item expanded "><div><strong aria-hidden="true">4.</strong> Availability</div></li><li><ol class="section"><li class="chapter-item expanded "><a href="../server-discovery-and-monitoring/server-monitoring.html"><strong aria-hidden="true">4.1.</strong> Server Monitoring</a></li><li class="chapter-item expanded "><a href="../polling-srv-records-for-mongos-discovery/polling-srv-records-for-mongos-discovery.html"><strong aria-hidden="true">4.2.</strong> SRV Polling for mongos Discovery</a></li><li class="chapter-item expanded "><a href="../server-selection/server-selection.html"><strong aria-hidden="true">4.3.</strong> Server Selection</a></li><li class="chapter-item expanded "><a href="../max-staleness/max-staleness.html"><strong aria-hidden="true">4.4.</strong> Max Staleness</a></li></ol></li><li class="chapter-item expanded "><li class="spacer"></li><li class="chapter-item expanded "><div><strong aria-hidden="true">5.</strong> Resilience</div></li><li><ol class="section"><li class="chapter-item expanded "><div><strong aria-hidden="true">5.1.</strong> Retryability</div></li><li><ol class="section"><li class="chapter-item expanded "><a href="../retryable-reads/retryable-reads.html"><strong aria-hidden="true">5.1.1.</strong> Reads</a></li><li class="chapter-item expanded "><a href="../retryable-writes/retryable-writes.html"><strong aria-hidden="true">5.1.2.</strong> Writes</a></li></ol></li><li class="chapter-item expanded "><a href="../client-side-operations-timeout/client-side-operations-timeout.html"><strong aria-hidden="true">5.2.</strong> CSOT</a></li><li class="chapter-item expanded "><div><strong aria-hidden="true">5.3.</strong> Consistency</div></li><li><ol class="section"><li class="chapter-item expanded "><a href="../sessions/driver-sessions.html"><strong aria-hidden="true">5.3.1.</strong> Sessions</a></li><li class="chapter-item expanded "><a href="../causal-consistency/causal-consistency.html"><strong aria-hidden="true">5.3.2.</strong> Causal Consistency</a></li><li class="chapter-item expanded "><a href="../sessions/snapshot-sessions.html"><strong aria-hidden="true">5.3.3.</strong> Snapshot Reads</a></li><li class="chapter-item expanded "><a href="../transactions/transactions.html"><strong aria-hidden="true">5.3.4.</strong> Transactions</a></li><li class="chapter-item expanded "><a href="../transactions-convenient-api/transactions-convenient-api.html"><strong aria-hidden="true">5.3.5.</strong> Convenient Transactions API</a></li></ol></li></ol></li><li class="chapter-item expanded "><li class="spacer"></li><li class="chapter-item expanded "><div><strong aria-hidden="true">6.</strong> Programmability</div></li><li><ol class="section"><li class="chapter-item expanded "><div><strong aria-hidden="true">6.1.</strong> Resource Management</div></li><li><ol class="section"><li class="chapter-item expanded "><a href="../enumerate-databases/enumerate-databases.html"><strong aria-hidden="true">6.1.1.</strong> Databases</a></li><li class="chapter-item expanded "><a href="../enumerate-collections/enumerate-collections.html"><strong aria-hidden="true">6.1.2.</strong> Collections</a></li><li class="chapter-item expanded "><a href="../index-management/index-management.html"><strong aria-hidden="true">6.1.3.</strong> Indexes</a></li></ol></li><li class="chapter-item expanded "><div><strong aria-hidden="true">6.2.</strong> Data Management</div></li><li><ol class="section"><li class="chapter-item expanded "><a href="../crud/crud.html"><strong aria-hidden="true">6.2.1.</strong> CRUD</a></li><li class="chapter-item expanded "><a href="../collation/collation.html"><strong aria-hidden="true">6.2.2.</strong> Collation</a></li><li class="chapter-item expanded "><a href="../server_write_commands/server_write_commands.html"><strong aria-hidden="true">6.2.3.</strong> Write Commands</a></li><li class="chapter-item expanded "><a href="../driver-bulk-update.html"><strong aria-hidden="true">6.2.4.</strong> Bulk API</a></li><li class="chapter-item expanded "><a href="../crud/bulk-write.html"><strong aria-hidden="true">6.2.5.</strong> Bulk Write</a></li><li class="chapter-item expanded "><a href="../read-write-concern/read-write-concern.html"><strong aria-hidden="true">6.2.6.</strong> R/W Concern</a></li></ol></li><li class="chapter-item expanded "><div><strong aria-hidden="true">6.3.</strong> Cursors</div></li><li><ol class="section"><li class="chapter-item expanded "><a href="../change-streams/change-streams.html"><strong aria-hidden="true">6.3.1.</strong> Change Streams</a></li><li class="chapter-item expanded "><a href="../find_getmore_killcursors_commands/find_getmore_killcursors_commands.html"><strong aria-hidden="true">6.3.2.</strong> find/getMore/killCursors</a></li></ol></li><li class="chapter-item expanded "><a href="../gridfs/gridfs-spec.html"><strong aria-hidden="true">6.4.</strong> GridFS</a></li><li class="chapter-item expanded "><a href="../versioned-api/versioned-api.html"><strong aria-hidden="true">6.5.</strong> Stable API</a></li><li class="chapter-item expanded "><div><strong aria-hidden="true">6.6.</strong> Security</div></li><li><ol class="section"><li class="chapter-item expanded "><a href="../client-side-encryption/client-side-encryption.html"><strong aria-hidden="true">6.6.1.</strong> Client Side Encryption</a></li><li class="chapter-item expanded "><a href="../bson-binary-encrypted/binary-encrypted.html"><strong aria-hidden="true">6.6.2.</strong> BSON Binary Subtype 6</a></li></ol></li></ol></li><li class="chapter-item expanded "><li class="spacer"></li><li class="chapter-item expanded "><div><strong aria-hidden="true">7.</strong> Observability</div></li><li><ol class="section"><li class="chapter-item expanded "><a href="../command-logging-and-monitoring/command-logging-and-monitoring.html"><strong aria-hidden="true">7.1.</strong> Command Logging and Monitoring</a></li><li class="chapter-item expanded "><a href="../server-discovery-and-monitoring/server-discovery-and-monitoring-logging-and-monitoring.html"><strong aria-hidden="true">7.2.</strong> SDAM Logging and Monitoring</a></li><li class="chapter-item expanded "><a href="../logging/logging.html"><strong aria-hidden="true">7.3.</strong> Standardized Logging</a></li><li class="chapter-item expanded "><a href="../connection-monitoring-and-pooling/connection-monitoring-and-pooling.html"><strong aria-hidden="true">7.4.</strong> Connection Pool Logging</a></li></ol></li><li class="chapter-item expanded "><li class="spacer"></li><li class="chapter-item expanded "><div><strong aria-hidden="true">8.</strong> Testability</div></li><li><ol class="section"><li class="chapter-item expanded "><a href="../unified-test-format/unified-test-format.html"><strong aria-hidden="true">8.1.</strong> Unified Test Format</a></li><li class="chapter-item expanded "><a href="../atlas-data-lake-testing/tests/index.html"><strong aria-hidden="true">8.2.</strong> Atlas Data Federation Testing</a></li><li class="chapter-item expanded "><a href="../benchmarking/benchmarking.html"><strong aria-hidden="true">8.3.</strong> Performance Benchmarking</a></li><li class="chapter-item expanded "><a href="../bson-corpus/bson-corpus.html"><strong aria-hidden="true">8.4.</strong> BSON Corpus</a></li><li class="chapter-item expanded "><a href="../connections-survive-step-down/tests/index.html"><strong aria-hidden="true">8.5.</strong> Replication Event Resilience</a></li><li class="chapter-item expanded "><a href="../faas-automated-testing/faas-automated-testing.html"><strong aria-hidden="true">8.6.</strong> FAAS Automated Testing</a></li><li class="chapter-item expanded "><a href="../serverless-testing/index.html"><strong aria-hidden="true">8.7.</strong> Atlas Serverless Testing</a></li></ol></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <!-- Track and set sidebar scroll position -->
        <script>
            var sidebarScrollbox = document.querySelector('#sidebar .sidebar-scrollbox');
            sidebarScrollbox.addEventListener('click', function(e) {
                if (e.target.tagName === 'A') {
                    sessionStorage.setItem('sidebar-scroll', sidebarScrollbox.scrollTop);
                }
            }, { passive: true });
            var sidebarScrollTop = sessionStorage.getItem('sidebar-scroll');
            sessionStorage.removeItem('sidebar-scroll');
            if (sidebarScrollTop) {
                // preserve sidebar scroll position when navigating via links within sidebar
                sidebarScrollbox.scrollTop = sidebarScrollTop;
            } else {
                // scroll sidebar to current active section when navigating via "next/previous chapter" buttons
                var activeSection = document.querySelector('#sidebar .active');
                if (activeSection) {
                    activeSection.scrollIntoView({ block: 'center' });
                }
            }
        </script>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">MongoDB Driver Specifications</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="op_msg"><a class="header" href="#op_msg">OP_MSG</a></h1>
<ul>
<li>Status: Accepted</li>
<li>Minimum Server Version: 3.6</li>
</ul>
<h3 id="abstract"><a class="header" href="#abstract">Abstract</a></h3>
<p><code>OP_MSG</code> is a bi-directional wire protocol opcode introduced in MongoDB 3.6 with the goal of replacing most existing
opcodes, merging their use into one extendable opcode.</p>
<h3 id="meta"><a class="header" href="#meta">META</a></h3>
<p>The keywords "MUST", "MUST NOT", "REQUIRED", "SHALL", "SHALL NOT", "SHOULD", "SHOULD NOT", "RECOMMENDED", "MAY", and
"OPTIONAL" in this document are to be interpreted as described in <a href="https://www.ietf.org/rfc/rfc2119.txt">RFC 2119</a>.</p>
<h3 id="specification"><a class="header" href="#specification">Specification</a></h3>
<h4 id="usage"><a class="header" href="#usage">Usage</a></h4>
<p><code>OP_MSG</code> is only available in MongoDB 3.6 (<code>maxWireVersion &gt;= 6</code>) and later. MongoDB drivers MUST perform the MongoDB
handshake using <code>OP_MSG</code> if an API version was declared on the client.</p>
<p>If no API version was declared, drivers that have historically supported MongoDB 3.4 and earlier MUST perform the
handshake using <code>OP_QUERY</code> to determine if the node supports <code>OP_MSG</code>. Drivers that have only ever supported MongoDB 3.6
and newer MAY default to using <code>OP_MSG</code>.</p>
<p>If the node supports <code>OP_MSG</code>, any and all messages MUST use <code>OP_MSG</code>, optionally compressed with <code>OP_COMPRESSED</code>.
Authentication messages MUST also use <code>OP_MSG</code> when it is supported, but MUST NOT use <code>OP_COMPRESSED</code>.</p>
<h4 id="op_msg-1"><a class="header" href="#op_msg-1">OP_MSG</a></h4>
<p>Types used in this document</p>
<div class="table-wrapper"><table><thead><tr><th>Type</th><th>Meaning</th></tr></thead><tbody>
<tr><td>document</td><td>A BSON document</td></tr>
<tr><td>cstring</td><td>NULL terminated string</td></tr>
<tr><td>int32</td><td>4 bytes (32-bit signed integer, two's complement)</td></tr>
<tr><td>uint8</td><td>1 byte (8-bit unsigned integer)</td></tr>
<tr><td>uint32</td><td>4 bytes (32-bit unsigned integer)</td></tr>
<tr><td>union</td><td>One of the listed members</td></tr>
</tbody></table>
</div>
<p>Elements inside brackets (<code>[</code> <code>]</code>) are optional parts of the message.</p>
<ul>
<li>Zero or more instances: <code>*</code></li>
<li>One or more instances: <code>+</code></li>
</ul>
<p>The new opcode, called <code>OP_MSG</code>, has the following structure:</p>
<pre><code class="language-c">struct Section {
    uint8 payloadType;
    union payload {
        document  document; // payloadType == 0
        struct sequence { // payloadType == 1
            int32      size;
            cstring    identifier;
            document*  documents;
        };
    };
};

struct OP_MSG {
    struct MsgHeader {
        int32  messageLength;
        int32  requestID;
        int32  responseTo;
        int32  opCode = 2013;
    };
    uint32      flagBits;
    Section+    sections;
    [uint32     checksum;]
};
</code></pre>
<p>Each <code>OP_MSG</code> MUST NOT exceed the <code>maxMessageSizeBytes</code> as configured by the MongoDB Handshake.</p>
<p>Each <code>OP_MSG</code> MUST have one section with <code>Payload Type 0</code>, and zero or more <code>Payload Type 1</code>. Bulk writes SHOULD use
<code>Payload Type 1</code>, and MUST do so when the batch contains more than one entry.</p>
<p>Sections may exist in any order. Each <code>OP_MSG</code> MAY contain a checksum, and MUST set the relevant <code>flagBits</code> when that
field is included.</p>
<div class="table-wrapper"><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody>
<tr><td>flagBits</td><td>Network level flags, such as signaling recipient that another message is incoming without any other actions in the meantime, and availability of message checksums</td></tr>
<tr><td>sections</td><td>An array of one or more sections</td></tr>
<tr><td>checksum</td><td>crc32c message checksum. When present, the appropriate flag MUST be set in the flagBits.</td></tr>
</tbody></table>
</div>
<h5 id="flagbits"><a class="header" href="#flagbits">flagBits</a></h5>
<p>flagBits contains a bit vector of specialized network flags. The low 16 bits declare what the current message contains,
and what the expectations of the recipient are. The high 16 bits are designed to declare optional attributes of the
current message and expectations of the recipient.</p>
<p>All unused bits MUST be set to 0.</p>
<p>Clients MUST error if any unsupported or undefined required bits are set to 1 and MUST ignore all undefined optional
bits.</p>
<p>The currently defined flags are:</p>
<div class="table-wrapper"><table><thead><tr><th>Bit</th><th>Name</th><th>Request</th><th>Response</th><th>Description</th></tr></thead><tbody>
<tr><td>0</td><td>checksumPresent</td><td>x</td><td>x</td><td>Checksum present</td></tr>
<tr><td>1</td><td>moreToCome</td><td>x</td><td>x</td><td>Sender will send another message and is not prepared for overlapping messages</td></tr>
<tr><td>-16</td><td>exhaustAllowed</td><td>x</td><td></td><td>Client is prepared for multiple replies (using the moreToCome bit) to this request</td></tr>
</tbody></table>
</div>
<h5 id="checksumpresent"><a class="header" href="#checksumpresent">checksumPresent</a></h5>
<p>This is a reserved field for future support of <code>crc32c</code> checksums.</p>
<h5 id="moretocome"><a class="header" href="#moretocome">moreToCome</a></h5>
<p>The <code>OP_MSG</code> message is essentially a request-response protocol, one message per turn. However, setting the <code>moreToCome</code>
flag indicates to the recipient that the sender is not ready to give up its turn and will send another message.</p>
<h5 id="moretocome-on-requests"><a class="header" href="#moretocome-on-requests">moreToCome On Requests</a></h5>
<p>When the <code>moreToCome</code> flag is set on a request it signals to the recipient that the sender does not want to know the
outcome of the message. There is no response to a request where <code>moreToCome</code> has been set. Clients doing unacknowledged
writes MUST set the <code>moreToCome</code> flag, and MUST set the writeConcern to <code>w=0</code>.</p>
<p>If, during the processing of a <code>moreToCome</code> flagged write request, a server discovers that it is no longer primary, then
the server will close the connection. All other errors during processing will be silently dropped, and will not result
in the connection being closed.</p>
<h5 id="moretocome-on-responses"><a class="header" href="#moretocome-on-responses">moreToCome On Responses</a></h5>
<p>When the <code>moreToCome</code> flag is set on a response it signals to the recipient that the sender will send additional
responses on the connection. The recipient MUST continue to read responses until it reads a response with the
<code>moreToCome</code> flag not set, and MUST NOT send any more requests on this connection until it reads a response with the
<code>moreToCome</code> flag not set. The client MUST either consume all messages with the <code>moreToCome</code> flag set or close the
connection.</p>
<p>When the server sends responses with the <code>moreToCome</code> flag set, each of these responses will have a unique <code>messageId</code>,
and the <code>responseTo</code> field of every follow-up response will be the <code>messageId</code> of the previous response.</p>
<p>The client MUST be prepared to receive a response without <code>moreToCome</code> set prior to completing iteration of a cursor,
even if an earlier response for the same cursor had the <code>moreToCome</code> flag set. To continue iterating such a cursor, the
client MUST issue an explicit <code>getMore</code> request.</p>
<p><span id="exhaustAllowed"></span></p>
<h5 id="exhaustallowed"><a class="header" href="#exhaustallowed">exhaustAllowed</a></h5>
<p>Setting this flag on a request indicates to the recipient that the sender is prepared to handle multiple replies (using
the <code>moreToCome</code> bit) to this request. The server will never produce replies with the <code>moreToCome</code> bit set unless the
request has the <code>exhaustAllowed</code> bit set.</p>
<p>Setting the <code>exhaustAllowed</code> bit on a request does not guarantee that the responses will have the <code>moreToCome</code> bit set.</p>
<p>MongoDB server only handles the <code>exhaustAllowed</code> bit on the following operations. A driver MUST NOT set the
<code>exhaustAllowed</code> bit on other operations.</p>
<div class="table-wrapper"><table><thead><tr><th>Operation</th><th>Minimum MongoDB Version</th></tr></thead><tbody>
<tr><td>getMore</td><td>4.2</td></tr>
<tr><td>hello (including legacy hello)</td><td>4.4 (discoverable via topologyVersion)</td></tr>
</tbody></table>
</div>
<h5 id="sections"><a class="header" href="#sections">sections</a></h5>
<p>Each message contains one or more sections. A section is composed of an uint8 which determines the payload's type, and a
separate payload field. The payload size for payload type 0 and 1 is determined by the first 4 bytes of the payload
field (includes the 4 bytes holding the size but not the payload type).</p>
<div class="table-wrapper"><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody>
<tr><td>type</td><td>A byte indicating the layout and semantics of payload</td></tr>
<tr><td>payload</td><td>The payload of a section can either be a single document, or a document sequence.</td></tr>
</tbody></table>
</div>
<p>When the Payload Type is 0, the content of the payload is:</p>
<div class="table-wrapper"><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody>
<tr><td>document</td><td>The BSON document. The payload size is inferred from the document's leading int32.</td></tr>
</tbody></table>
</div>
<p>When the Payload Type is 1, the content of the payload is:</p>
<div class="table-wrapper"><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody>
<tr><td>size</td><td>Payload size (includes this 4-byte field)</td></tr>
<tr><td>identifier</td><td>A unique identifier (for this message). Generally the name of the "command argument" it contains the value for</td></tr>
<tr><td>documents</td><td>0 or more BSON documents. Each BSON document cannot be larger than <code>maxBSONObjectSize</code>.</td></tr>
</tbody></table>
</div>
<p>Any unknown Payload Types MUST result in an error and the socket MUST be closed. There is no ordering implied by payload
types. A section with payload type 1 can be serialized before payload type 0.</p>
<p>A fully constructed <code>OP_MSG</code> MUST contain exactly one <code>Payload Type 0</code>, and optionally any number of <code>Payload Type 1</code>
where each identifier MUST be unique per message.</p>
<h4 id="command-arguments-as-payload"><a class="header" href="#command-arguments-as-payload">Command Arguments As Payload</a></h4>
<p>Certain commands support "pulling out" certain arguments to the command, and providing them as <code>Payload Type 1</code>, where
the <code>identifier</code> is the command argument's name. Specifying a command argument as a separate payload removes the need to
use a BSON Array. For example, <code>Payload Type 1</code> allows an array of documents to be specified as a sequence of BSON
documents on the wire without the overhead of array keys.</p>
<p>MongoDB 3.6 only allows certain command arguments to be provided this way. These are:</p>
<div class="table-wrapper"><table><thead><tr><th>Command Name</th><th>Command Argument</th></tr></thead><tbody>
<tr><td>insert</td><td>documents</td></tr>
<tr><td>update</td><td>updates</td></tr>
<tr><td>delete</td><td>deletes</td></tr>
</tbody></table>
</div>
<h4 id="global-command-arguments"><a class="header" href="#global-command-arguments">Global Command Arguments</a></h4>
<p>The new opcode contains no field for providing the database name. Instead, the protocol now has the concept of global
command arguments. These global command arguments can be passed to all MongoDB commands alongside the rest of the
command arguments.</p>
<p>Currently defined global arguments:</p>
<div class="table-wrapper"><table><thead><tr><th>Argument Name</th><th>Default Value</th><th>Description</th></tr></thead><tbody>
<tr><td>$db</td><td></td><td>The database name to execute the command on. MUST be provided and be a valid database name.</td></tr>
<tr><td><code>$readPreference</code></td><td><code>{ "mode": "primary" }</code></td><td>Determines server selection, and also whether a secondary server permits reads or responds "not writable primary". See Server Selection Spec for rules about when read preference must or must not be included, and for rules about when read preference "primaryPreferred" must be added automatically.</td></tr>
</tbody></table>
</div>
<p>Additional global arguments are likely to be introduced in the future and defined in their own specs.</p>
<h3 id="user-originating-commands"><a class="header" href="#user-originating-commands">User originating commands</a></h3>
<p>Drivers MUST NOT mutate user provided command documents in any way, whether it is adding required arguments, pulling out
arguments, compressing it, adding supplemental APM data or any other modification.</p>
<h3 id="examples"><a class="header" href="#examples">Examples</a></h3>
<h4 id="command-arguments-as-payload-examples"><a class="header" href="#command-arguments-as-payload-examples">Command Arguments As Payload Examples</a></h4>
<p>For example, an insert can be represented like:</p>
<pre><code>{
   "insert": "collectionName",
   "documents": [
      {"_id": "Document#1", "example": 1},
      {"_id": "Document#2", "example": 2},
      {"_id": "Document#3", "example": 3}
   ],
   "writeConcern": { w: "majority" }
}
</code></pre>
<p>Or, pulling out the <code>"documents"</code> argument out of the command document and Into <code>Payload Type 1</code>. The <code>Payload Type 0</code>
would then be:</p>
<pre><code>{
   "insert": "collectionName",
   "$db": "databaseName",
   "writeConcern": { w: "majority" }
}
</code></pre>
<p>And <code>Payload Type 1</code>:</p>
<pre><code>identifier: "documents"
documents: {"_id": "Document#1", "example": 1}{"_id": "Document#2", "example": 2}{"_id": "Document#3", "example": 3}
</code></pre>
<p>Note that the BSON documents are placed immediately after each other, not with any separator. The writeConcern is also
left intact as a command argument in the <code>Payload Type 0</code> section. The command name MUST continue to be the first key of
the command arguments in the <code>Payload Type 0</code> section.</p>
<hr />
<p>An update can for example be represented like:</p>
<pre><code>{
   "update": "collectionName",
   "updates": [
      {
         "q": {"example": 1},
         "u": { "$set": { "example": 4} }
      },
      {
         "q": {"example": 2},
         "u": { "$set": { "example": 5} }
      }
   ]
}
</code></pre>
<p>Or, pulling out the <code>"update"</code> argument out of the command document and Into <code>Payload Type 1</code>. The <code>Payload Type 0</code>
would then be:</p>
<pre><code>{
   "update": "collectionName",
   "$db": "databaseName"
}
</code></pre>
<p>And <code>Payload Type 1</code>:</p>
<pre><code>identifier: updates
documents: {"q": {"example": 1}, "u": { "$set": { "example": 4}}}{"q": {"example": 2}, "u": { "$set": { "example": 5}}}
</code></pre>
<p>Note that the BSON documents are placed immediately after each other, not with any separator.</p>
<hr />
<p>A delete can for example be represented like:</p>
<pre><code>{
   "delete": "collectionName",
   "deletes": [
      {
         "q": {"example": 3},
         "limit": 1
      },
      {
         "q": {"example": 4},
         "limit": 1
      }
   ]
}
</code></pre>
<p>Or, pulling out the <code>"deletes"</code> argument out of the command document and into <code>Payload Type 1</code>. The <code>Payload Type 0</code>
would then be:</p>
<pre><code>{
   "delete": "collectionName",
   "$db": "databaseName"
}
</code></pre>
<p>And <code>Payload Type 1</code>:</p>
<pre><code>identifier: delete
documents: {"q": {"example": 3}, "limit": 1}{"q": {"example": 4}, "limit": 1}
</code></pre>
<p>Note that the BSON documents are placed immediately after each other, not with any separator.</p>
<h3 id="test-plan"><a class="header" href="#test-plan">Test Plan</a></h3>
<ul>
<li>Create a single document and insert it over <code>OP_MSG</code>, ensure it works</li>
<li>Create two documents and insert them over <code>OP_MSG</code>, ensure each document is pulled out and presented as document
sequence.</li>
<li>hello.maxWriteBatchSize might change and be bumped to 100,000</li>
<li>Repeat the previous 5 tests as updates, and then deletes.</li>
<li>Create one small document, and one large 16mb document. Ensure they are inserted, updated and deleted in one
roundtrip.</li>
</ul>
<h3 id="motivation-for-change"><a class="header" href="#motivation-for-change">Motivation For Change</a></h3>
<p>MongoDB clients are currently required to work around various issues that each current opcode has, such as having to
determine what sort of node is on the other end as it affects the actual structure of certain messages. MongoDB 3.6
introduces a new wire protocol opcode, <code>OP_MSG</code>, which aims to resolve most historical issues along with providing a
future compatible and extendable opcode.</p>
<h3 id="backwards-compatibility"><a class="header" href="#backwards-compatibility">Backwards Compatibility</a></h3>
<p>The hello.maxWriteBatchSize is being bumped, which also affects <code>OP_QUERY</code>, not only <code>OP_MSG</code>. As a sideeffect, write
errors will now have the message truncated, instead of overflowing the maxMessageSize, if the server determines it would
overflow the allowed size. This applies to all commands that write. The error documents are structurally the same, with
the error messages simply replaced with empty strings.</p>
<h3 id="reference-implementations"><a class="header" href="#reference-implementations">Reference Implementations</a></h3>
<ul>
<li>mongoc</li>
<li>.net</li>
</ul>
<h3 id="future-work"><a class="header" href="#future-work">Future Work</a></h3>
<p>In the near future, this opcode is expected to be extended and include support for:</p>
<ul>
<li>Message checksum (crc32c)</li>
<li>Output document sequences</li>
<li><code>moreToCome</code> can also be used for other commands, such as <code>killCursors</code> to restore <code>OP_KILL_CURSORS</code> behaviour as
currently any errors/replies are ignored.</li>
</ul>
<h3 id="q--a"><a class="header" href="#q--a">Q &amp; A</a></h3>
<ul>
<li>
<p>Has the maximum number of documents per batch changed ?</p>
<ul>
<li>The maximum number of documents per batch is dictated by the <code>maxWriteBatchSize</code> value returned during the MongoDB
Handshake. It is likely this value will be bumped from 1,000 to 100,000.</li>
</ul>
</li>
<li>
<p>Has the maximum size of the message changed?</p>
<ul>
<li>No. The maximum message size is still the <code>maxMessageSizeBytes</code> value returned during the MongoDB Handshake.</li>
</ul>
</li>
<li>
<p>Is everything still little-endian?</p>
<ul>
<li>Yes. As with BSON, all MongoDB opcodes must be serialized in little-endian format.</li>
</ul>
</li>
<li>
<p>How does fire-and-forget (w=0 / unacknowledged write) work over <code>OP_MSG</code>?</p>
<ul>
<li>The client sets the <code>moreToCome</code> flag on the request. The server will not send a response to such requests.</li>
<li>Malformed operation or errors such as duplicate key errors are not discoverable and will be swallowed by the server.</li>
<li>Write errors due to not-primary will close the connection, which clients will pickup on next time it uses the
connection. This means at least one unacknowledged write operation will be lost as the client does not discover the
failover until next time the socket is used.</li>
</ul>
</li>
<li>
<p>Should we provide <code>runMoreToComeCommand()</code> helpers? Since the protocol allows any command to be tagged with
<code>moreToCome</code>, effectively allowing any operation to become <code>fire &amp; forget</code>, it might be a good idea to add such
helper, rather then adding wire protocol headers as options to the existing <code>runCommand</code> helpers.</p>
</li>
</ul>
<h3 id="changelog"><a class="header" href="#changelog">Changelog</a></h3>
<ul>
<li>2024-04-30: Convert from RestructuredText to Markdown.</li>
<li>2022-10-05: Remove spec front matter.</li>
<li>2022-01-13: Clarify that <code>OP_MSG</code> must be used when using stable API</li>
<li>2021-12-16: Clarify that old drivers should default to OP_QUERY handshakes</li>
<li>2021-04-20: Suggest using OP_MSG for initial handshake when using stable API</li>
<li>2021-04-06: Updated to use hello and not writable primary</li>
<li>2017-11-12: Specify read preferences for OP_MSG with direct connection</li>
<li>2017-08-17: Added the <code>User originating command</code> section</li>
<li>2017-07-18: Published initial version</li>
</ul>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../extended-json/extended-json.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../run-command/run-command.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../extended-json/extended-json.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../run-command/run-command.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../elasticlunr.min.js"></script>
        <script src="../mark.min.js"></script>
        <script src="../searcher.js"></script>

        <script src="../clipboard.min.js"></script>
        <script src="../highlight.js"></script>
        <script src="../book.js"></script>

        <!-- Custom JS scripts -->


    </div>
    </body>
</html>
