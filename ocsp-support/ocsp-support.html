<!DOCTYPE HTML>
<html lang="en" class="light" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>OCSP - MongoDB Driver Specifications</title>


        <!-- Custom HTML head -->
        
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->

    </head>
    <body class="sidebar-visible no-js">
    <div id="body-container">
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('light')
            html.classList.add(theme);
            var body = document.querySelector('body');
            body.classList.remove('no-js')
            body.classList.add('js');
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var body = document.querySelector('body');
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            body.classList.remove('sidebar-visible');
            body.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="../index.html">Introduction</a></li><li class="chapter-item expanded affix "><a href="../driver-mantras.html">Mantras</a></li><li class="chapter-item expanded affix "><a href="../wireversion-featurelist/wireversion-featurelist.html">Wire Version Feature List</a></li><li class="chapter-item expanded affix "><li class="part-title">Specifications</li><li class="chapter-item expanded "><div><strong aria-hidden="true">1.</strong> Serialization</div></li><li><ol class="section"><li class="chapter-item expanded "><a href="../BSON.html"><strong aria-hidden="true">1.1.</strong> BSON</a></li><li class="chapter-item expanded "><a href="../bson-objectid/objectid.html"><strong aria-hidden="true">1.2.</strong> ObjectId</a></li><li class="chapter-item expanded "><a href="../bson-decimal128/decimal128.html"><strong aria-hidden="true">1.3.</strong> Decimal128</a></li><li class="chapter-item expanded "><a href="../bson-binary-uuid/uuid.html"><strong aria-hidden="true">1.4.</strong> UUID</a></li><li class="chapter-item expanded "><a href="../dbref/dbref.html"><strong aria-hidden="true">1.5.</strong> DBRef</a></li><li class="chapter-item expanded "><a href="../extended-json/extended-json.html"><strong aria-hidden="true">1.6.</strong> Extended JSON</a></li></ol></li><li class="chapter-item expanded "><li class="spacer"></li><li class="chapter-item expanded "><div><strong aria-hidden="true">2.</strong> Communication</div></li><li><ol class="section"><li class="chapter-item expanded "><a href="../message/OP_MSG.html"><strong aria-hidden="true">2.1.</strong> OP_MSG</a></li><li class="chapter-item expanded "><a href="../run-command/run-command.html"><strong aria-hidden="true">2.2.</strong> Command Execution</a></li><li class="chapter-item expanded "><a href="../connection-string/connection-string-spec.html"><strong aria-hidden="true">2.3.</strong> Connection String</a></li><li class="chapter-item expanded "><a href="../uri-options/uri-options.html"><strong aria-hidden="true">2.4.</strong> URI Options</a></li><li class="chapter-item expanded "><a href="../ocsp-support/ocsp-support.html" class="active"><strong aria-hidden="true">2.5.</strong> OCSP</a></li><li class="chapter-item expanded "><a href="../mongodb-handshake/handshake.html"><strong aria-hidden="true">2.6.</strong> Initial Handshake</a></li><li class="chapter-item expanded "><a href="../compression/OP_COMPRESSED.html"><strong aria-hidden="true">2.7.</strong> Wire Compression</a></li><li class="chapter-item expanded "><a href="../socks5-support/socks5.html"><strong aria-hidden="true">2.8.</strong> SOCKS5</a></li><li class="chapter-item expanded "><a href="../initial-dns-seedlist-discovery/initial-dns-seedlist-discovery.html"><strong aria-hidden="true">2.9.</strong> Initial DNS Seedlist Discovery</a></li></ol></li><li class="chapter-item expanded "><li class="spacer"></li><li class="chapter-item expanded "><div><strong aria-hidden="true">3.</strong> Connectivity</div></li><li><ol class="section"><li class="chapter-item expanded "><a href="../server-discovery-and-monitoring/server-discovery-and-monitoring.html"><strong aria-hidden="true">3.1.</strong> Server Discovery and Monitoring</a></li><li class="chapter-item expanded "><a href="../connection-monitoring-and-pooling/connection-monitoring-and-pooling.html"><strong aria-hidden="true">3.2.</strong> Connection Monitoring and Pooling</a></li><li class="chapter-item expanded "><a href="../load-balancers/load-balancers.html"><strong aria-hidden="true">3.3.</strong> Load Balancer Support</a></li></ol></li><li class="chapter-item expanded "><li class="spacer"></li><li class="chapter-item expanded "><div><strong aria-hidden="true">4.</strong> Availability</div></li><li><ol class="section"><li class="chapter-item expanded "><a href="../server-discovery-and-monitoring/server-monitoring.html"><strong aria-hidden="true">4.1.</strong> Server Monitoring</a></li><li class="chapter-item expanded "><a href="../polling-srv-records-for-mongos-discovery/polling-srv-records-for-mongos-discovery.html"><strong aria-hidden="true">4.2.</strong> SRV Polling for mongos Discovery</a></li><li class="chapter-item expanded "><a href="../server-selection/server-selection.html"><strong aria-hidden="true">4.3.</strong> Server Selection</a></li><li class="chapter-item expanded "><a href="../max-staleness/max-staleness.html"><strong aria-hidden="true">4.4.</strong> Max Staleness</a></li></ol></li><li class="chapter-item expanded "><li class="spacer"></li><li class="chapter-item expanded "><div><strong aria-hidden="true">5.</strong> Resilience</div></li><li><ol class="section"><li class="chapter-item expanded "><div><strong aria-hidden="true">5.1.</strong> Retryability</div></li><li><ol class="section"><li class="chapter-item expanded "><a href="../retryable-reads/retryable-reads.html"><strong aria-hidden="true">5.1.1.</strong> Reads</a></li><li class="chapter-item expanded "><a href="../retryable-writes/retryable-writes.html"><strong aria-hidden="true">5.1.2.</strong> Writes</a></li></ol></li><li class="chapter-item expanded "><a href="../client-side-operations-timeout/client-side-operations-timeout.html"><strong aria-hidden="true">5.2.</strong> CSOT</a></li><li class="chapter-item expanded "><div><strong aria-hidden="true">5.3.</strong> Consistency</div></li><li><ol class="section"><li class="chapter-item expanded "><a href="../sessions/driver-sessions.html"><strong aria-hidden="true">5.3.1.</strong> Sessions</a></li><li class="chapter-item expanded "><a href="../causal-consistency/causal-consistency.html"><strong aria-hidden="true">5.3.2.</strong> Causal Consistency</a></li><li class="chapter-item expanded "><a href="../sessions/snapshot-sessions.html"><strong aria-hidden="true">5.3.3.</strong> Snapshot Reads</a></li><li class="chapter-item expanded "><a href="../transactions/transactions.html"><strong aria-hidden="true">5.3.4.</strong> Transactions</a></li><li class="chapter-item expanded "><a href="../transactions-convenient-api/transactions-convenient-api.html"><strong aria-hidden="true">5.3.5.</strong> Convenient Transactions API</a></li></ol></li></ol></li><li class="chapter-item expanded "><li class="spacer"></li><li class="chapter-item expanded "><div><strong aria-hidden="true">6.</strong> Programmability</div></li><li><ol class="section"><li class="chapter-item expanded "><div><strong aria-hidden="true">6.1.</strong> Resource Management</div></li><li><ol class="section"><li class="chapter-item expanded "><a href="../enumerate-databases/enumerate-databases.html"><strong aria-hidden="true">6.1.1.</strong> Databases</a></li><li class="chapter-item expanded "><a href="../enumerate-collections/enumerate-collections.html"><strong aria-hidden="true">6.1.2.</strong> Collections</a></li><li class="chapter-item expanded "><a href="../index-management/index-management.html"><strong aria-hidden="true">6.1.3.</strong> Indexes</a></li></ol></li><li class="chapter-item expanded "><div><strong aria-hidden="true">6.2.</strong> Data Management</div></li><li><ol class="section"><li class="chapter-item expanded "><a href="../crud/crud.html"><strong aria-hidden="true">6.2.1.</strong> CRUD</a></li><li class="chapter-item expanded "><a href="../collation/collation.html"><strong aria-hidden="true">6.2.2.</strong> Collation</a></li><li class="chapter-item expanded "><a href="../server_write_commands/server_write_commands.html"><strong aria-hidden="true">6.2.3.</strong> Write Commands</a></li><li class="chapter-item expanded "><a href="../driver-bulk-update.html"><strong aria-hidden="true">6.2.4.</strong> Bulk API</a></li><li class="chapter-item expanded "><a href="../crud/bulk-write.html"><strong aria-hidden="true">6.2.5.</strong> Bulk Write</a></li><li class="chapter-item expanded "><a href="../read-write-concern/read-write-concern.html"><strong aria-hidden="true">6.2.6.</strong> R/W Concern</a></li></ol></li><li class="chapter-item expanded "><div><strong aria-hidden="true">6.3.</strong> Cursors</div></li><li><ol class="section"><li class="chapter-item expanded "><a href="../change-streams/change-streams.html"><strong aria-hidden="true">6.3.1.</strong> Change Streams</a></li><li class="chapter-item expanded "><a href="../find_getmore_killcursors_commands/find_getmore_killcursors_commands.html"><strong aria-hidden="true">6.3.2.</strong> find/getMore/killCursors</a></li></ol></li><li class="chapter-item expanded "><a href="../gridfs/gridfs-spec.html"><strong aria-hidden="true">6.4.</strong> GridFS</a></li><li class="chapter-item expanded "><a href="../versioned-api/versioned-api.html"><strong aria-hidden="true">6.5.</strong> Stable API</a></li><li class="chapter-item expanded "><div><strong aria-hidden="true">6.6.</strong> Security</div></li><li><ol class="section"><li class="chapter-item expanded "><a href="../client-side-encryption/client-side-encryption.html"><strong aria-hidden="true">6.6.1.</strong> Client Side Encryption</a></li><li class="chapter-item expanded "><a href="../bson-binary-encrypted/binary-encrypted.html"><strong aria-hidden="true">6.6.2.</strong> BSON Binary Subtype 6</a></li></ol></li></ol></li><li class="chapter-item expanded "><li class="spacer"></li><li class="chapter-item expanded "><div><strong aria-hidden="true">7.</strong> Observability</div></li><li><ol class="section"><li class="chapter-item expanded "><a href="../command-logging-and-monitoring/command-logging-and-monitoring.html"><strong aria-hidden="true">7.1.</strong> Command Logging and Monitoring</a></li><li class="chapter-item expanded "><a href="../server-discovery-and-monitoring/server-discovery-and-monitoring-logging-and-monitoring.html"><strong aria-hidden="true">7.2.</strong> SDAM Logging and Monitoring</a></li><li class="chapter-item expanded "><a href="../logging/logging.html"><strong aria-hidden="true">7.3.</strong> Standardized Logging</a></li><li class="chapter-item expanded "><a href="../connection-monitoring-and-pooling/connection-monitoring-and-pooling.html"><strong aria-hidden="true">7.4.</strong> Connection Pool Logging</a></li></ol></li><li class="chapter-item expanded "><li class="spacer"></li><li class="chapter-item expanded "><div><strong aria-hidden="true">8.</strong> Testability</div></li><li><ol class="section"><li class="chapter-item expanded "><a href="../unified-test-format/unified-test-format.html"><strong aria-hidden="true">8.1.</strong> Unified Test Format</a></li><li class="chapter-item expanded "><a href="../atlas-data-lake-testing/tests/index.html"><strong aria-hidden="true">8.2.</strong> Atlas Data Federation Testing</a></li><li class="chapter-item expanded "><a href="../benchmarking/benchmarking.html"><strong aria-hidden="true">8.3.</strong> Performance Benchmarking</a></li><li class="chapter-item expanded "><a href="../bson-corpus/bson-corpus.html"><strong aria-hidden="true">8.4.</strong> BSON Corpus</a></li><li class="chapter-item expanded "><a href="../connections-survive-step-down/tests/index.html"><strong aria-hidden="true">8.5.</strong> Replication Event Resilience</a></li><li class="chapter-item expanded "><a href="../faas-automated-testing/faas-automated-testing.html"><strong aria-hidden="true">8.6.</strong> FAAS Automated Testing</a></li><li class="chapter-item expanded "><a href="../serverless-testing/index.html"><strong aria-hidden="true">8.7.</strong> Atlas Serverless Testing</a></li></ol></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <!-- Track and set sidebar scroll position -->
        <script>
            var sidebarScrollbox = document.querySelector('#sidebar .sidebar-scrollbox');
            sidebarScrollbox.addEventListener('click', function(e) {
                if (e.target.tagName === 'A') {
                    sessionStorage.setItem('sidebar-scroll', sidebarScrollbox.scrollTop);
                }
            }, { passive: true });
            var sidebarScrollTop = sessionStorage.getItem('sidebar-scroll');
            sessionStorage.removeItem('sidebar-scroll');
            if (sidebarScrollTop) {
                // preserve sidebar scroll position when navigating via links within sidebar
                sidebarScrollbox.scrollTop = sidebarScrollTop;
            } else {
                // scroll sidebar to current active section when navigating via "next/previous chapter" buttons
                var activeSection = document.querySelector('#sidebar .active');
                if (activeSection) {
                    activeSection.scrollIntoView({ block: 'center' });
                }
            }
        </script>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">MongoDB Driver Specifications</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="ocsp-support"><a class="header" href="#ocsp-support">OCSP Support</a></h1>
<ul>
<li>Status: Accepted</li>
<li>Minimum Server Version: 4.4</li>
</ul>
<hr />
<h2 id="abstract"><a class="header" href="#abstract">Abstract</a></h2>
<p>This specification is about the ability for drivers to to support
<a href="https://en.wikipedia.org/wiki/Online_Certificate_Status_Protocol">OCSP</a>—Online Certificate Status Protocol
(<a href="https://tools.ietf.org/html/rfc6960">RFC 6960</a>)—and two of its related extensions:
<a href="https://en.wikipedia.org/wiki/OCSP_stapling">OCSP stapling</a> (<a href="https://tools.ietf.org/html/rfc6066">RFC 6066</a>) and
<a href="https://scotthelme.co.uk/ocsp-must-staple/">Must-Staple</a> (<a href="https://tools.ietf.org/html/rfc7633">RFC 7633</a>).</p>
<h2 id="meta"><a class="header" href="#meta">META</a></h2>
<p>The keywords "MUST", "MUST NOT", "REQUIRED", "SHALL", "SHALL NOT", "SHOULD", "SHOULD NOT", "RECOMMENDED", "MAY", and
"OPTIONAL" in this document are to be interpreted as described in <a href="https://www.ietf.org/rfc/rfc2119.txt">RFC 2119</a>.</p>
<h2 id="specification"><a class="header" href="#specification">Specification</a></h2>
<h3 id="required-server-versions"><a class="header" href="#required-server-versions">Required Server Versions</a></h3>
<p>The server supports attaching a stapled OCSP response with versions ≥ 4.4. Future backports will bring stapling support
to server versions ≥ 3.6. Drivers need not worry about the version of the server as a driver's TLS library should
automatically perform the proper certificate revocation checking behavior once OCSP is enabled.</p>
<h3 id="enabling-ocsp-support-by-default"><a class="header" href="#enabling-ocsp-support-by-default">Enabling OCSP Support by Default</a></h3>
<p>Drivers whose TLS libraries utilize application-wide settings for OCSP MUST respect the application's settings and MUST
NOT change any OCSP settings. Otherwise:</p>
<ul>
<li>If a driver's TLS library supports OCSP, OCSP MUST be enabled by default whenever possible (even if this also enables
Certificate Revocation List (CRL) checking).</li>
<li>If a driver's TLS library supports verifying stapled OCSP responses, this option MUST be enabled by default whenever
possible (even if this also enables CRL checking).</li>
</ul>
<h3 id="suggested-ocsp-behavior"><a class="header" href="#suggested-ocsp-behavior">Suggested OCSP Behavior</a></h3>
<p>Drivers SHOULD implement the OCSP behavior defined below to the extent that their TLS library allows. At any point in
the steps defined below, if a certificate in or necessary to validate the chain is found to be invalid, the driver
SHOULD end the connection.</p>
<ol>
<li>If a driver's TLS library supports Stapled OCSP, the server has a Must-Staple certificate and the server does not
present a stapled OCSP response, a driver SHOULD end the connection.</li>
<li>If a driver's TLS library supports Stapled OCSP and the server staples an OCSP response that does not cover the
certificate it presents or is invalid per <a href="https://tools.ietf.org/html/rfc6960#section-3.2">RFC 6960 Section 3.2</a>, a
driver SHOULD end the connection.</li>
<li>If a driver's TLS library supports Stapled OCSP and the server staples an OCSP response that does cover the
certificate it presents, a driver SHOULD accept the stapled OCSP response and validate all of the certificates that
are presented in the response.</li>
<li>If any unvalidated certificates in the chain remain and the client possesses an OCSP cache, the driver SHOULD
attempt to validate the status of the unvalidated certificates using the cache.</li>
<li>If any unvalidated certificates in the chain remain and the driver has a user specified CRL, the driver SHOULD
attempt to validate the status of the unvalidated certificates using the user-specified CRL.</li>
<li>If any unvalidated certificates in the chain remain and the driver has access to cached CRLs (e.g.
OS-level/application-level/user-level caches), the driver SHOULD attempt to validate the status of the unvalidated
certificates using the cached CRLs.</li>
<li>If the server's certificate remains unvalidated, that certificate has a list of OCSP responder endpoints, and
<code>tlsDisableOCSPEndpointCheck</code> or <code>tlsDisableCertificateRevocationCheck</code> is false
(<a href="#mongoclient-configuration">if the driver supports these options</a>), the driver SHOULD send HTTP requests to the
responders in parallel. The first valid response that concretely marks the certificate status as good or revoked
should be used. A timeout should be applied to requests per the
<a href="../client-side-operations-timeout/client-side-operations-timeout.html">Client Side Operations Timeout</a> specification,
with a default timeout of five seconds. The status for a response should only be checked if the response is valid
per <a href="https://tools.ietf.org/html/rfc6960#section-3.2">RFC 6960 Section 3.2</a></li>
<li>If any unvalidated intermediate certificates remain and those certificates have OCSP endpoints, for each
certificate, the driver SHOULD NOT reach out to the OCSP endpoint specified and attempt to validate that
certificate.*</li>
<li>If any unvalidated intermediate certificates remain and those certificates have CRL distribution points, the driver
SHOULD NOT download those CRLs and attempt to validate the status of all the other certificates using those CRLs.*</li>
<li>Finally, the driver SHOULD continue the connection, even if the status of all the unvalidated certificates has not
been confirmed yet. This means that the driver SHOULD default to "soft fail" behavior, connecting as long as there
are no explicitly invalid certificates—i.e. the driver will connect even if the status of all the unvalidated
certificates has not been confirmed yet (e.g. because an OCSP responder is down).</li>
</ol>
<p>*: See <a href="#suggested-ocsp-behavior">Design Rationale: Suggested OCSP Behavior</a></p>
<h3 id="suggested-ocsp-response-validation-behavior"><a class="header" href="#suggested-ocsp-response-validation-behavior">Suggested OCSP Response Validation Behavior</a></h3>
<p>Drivers SHOULD validate OCSP Responses in the manner specified in
<a href="https://tools.ietf.org/html/rfc6960#section-3.2">RFC 6960: 3.2</a> to the extent that their TLS library allows.</p>
<h3 id="suggested-ocsp-caching-behavior"><a class="header" href="#suggested-ocsp-caching-behavior">Suggested OCSP Caching Behavior</a></h3>
<p>Drivers with sufficient control over their TLS library's OCSP behavior SHOULD implement an OCSP cache. The key for this
cache SHOULD be the certificate identifier (CertID) of the OCSP request as specified in
<a href="https://tools.ietf.org/html/rfc6960#section-4.1.1">RFC 6960: 4.1.1</a>. For convenience, the relevant section has been
duplicated below:</p>
<pre><code>CertID          ::=     SEQUENCE {
    hashAlgorithm       AlgorithmIdentifier,
    issuerNameHash      OCTET STRING, -- Hash of issuer's DN
    issuerKeyHash       OCTET STRING, -- Hash of issuer's public key
    serialNumber        CertificateSerialNumber }
</code></pre>
<p>If a driver would accept a conclusive OCSP response (stapled or non-stapled), the driver SHOULD cache that response. We
define a conclusive OCSP response as an OCSP response that indicates that a certificate is either valid or revoked.
Thus, an unknown certificate status SHOULD NOT be considered conclusive, and the corresponding OCSP response SHOULD NOT
be cached.</p>
<p>In accordance with <a href="https://tools.ietf.org/html/rfc6960#section-3.2">RFC: 6960: 3.2</a>, a cached response SHOULD be
considered valid up to and excluding the time specified in the response's <code>nextUpdate</code> field. In other words, if the
current time is <em>t</em>, then the cache entry SHOULD be considered valid if <em>thisUpdate ⩽ t &lt; nextUpdate</em>.</p>
<p>If a driver would accept a stapled OCSP response and that response has a later <code>nextUpdate</code> than the response already in
the cache, drivers SHOULD replace the older entry in the cache with the fresher response.</p>
<h3 id="mongoclient-configuration"><a class="header" href="#mongoclient-configuration">MongoClient Configuration</a></h3>
<p>This specification introduces the client-level configuration options defined below.</p>
<h4 id="tlsdisableocspendpointcheck"><a class="header" href="#tlsdisableocspendpointcheck">tlsDisableOCSPEndpointCheck</a></h4>
<p>Drivers that can, on a per MongoClient basis, disable non-stapled OCSP while keeping stapled OCSP enabled MUST implement
this option.</p>
<p>This boolean option determines whether a MongoClient should refrain from reaching out to an OCSP endpoint i.e. whether
non-stapled OCSP should be disabled. When set to true, a driver MUST NOT reach out to OCSP endpoints. When set to false,
a driver MUST reach out to OCSP endpoints if needed (as described in
<a href="#suggested-ocsp-behavior">Specification: Suggested OCSP Behavior</a>).</p>
<p>For drivers that pass the <a href="tests/README.html#integration-tests-permutations-to-be-tested">"Soft Fail Test"</a>, this option
MUST default to false.</p>
<p>For drivers that fail the "Soft Fail Test" because their TLS library exhibits hard-fail behavior when a responder is
unreachable, this option MUST default to true, and a driver MUST document this behavior. If this hard-failure behavior
is specific to a particular platform (e.g. the TLS library hard-fails only on Windows) then this option MUST default to
true only on the platform where the driver exhibits hard-fail behavior, and a driver MUST document this behavior.</p>
<h4 id="tlsdisablecertificaterevocationcheck"><a class="header" href="#tlsdisablecertificaterevocationcheck">tlsDisableCertificateRevocationCheck</a></h4>
<p>Drivers whose TLS libraries support an option to toggle general certificate revocation checking must implement this
option if enabling general certificate revocation checking causes hard-fail behavior when no revocation mechanisms are
available (i.e. no methods are defined or the CRL distribution points/OCSP endpoints are unreachable).</p>
<p>This boolean option determines whether a MongoClient should refrain checking certificate revocation status. When set to
true, a driver MUST NOT check certificate revocation status via CRLs or OCSP. When set to false, a driver MUST check
certificate revocation status, reach out to OCSP endpoints if needed (as described in
<a href="#suggested-ocsp-behavior">Specification: Suggested OCSP Behavior</a>).</p>
<p>For drivers that pass the <a href="tests/README.html#integration-tests-permutations-to-be-tested">"Soft Fail Test"</a> , this option
MUST default to false.</p>
<p>If a driver does not support <code>tlsDisableOCSPEndpointCheck</code> and that driver fails the "Soft Fail Test" because their TLS
library exhibits hard-fail behavior when a responder is unreachable, then that driver must default
<code>tlsDisableCertificateRevocationCheck</code> to true. Such a driver also MUST document this behavior. If this hard-failure
behavior is specific to a particular platform (e.g. the TLS library hard-fails only on Windows) then this option MUST
default to true only on the platform where the driver exhibits hard-fail behavior, and a driver MUST document this
behavior.</p>
<h4 id="naming-deviations"><a class="header" href="#naming-deviations">Naming Deviations</a></h4>
<p>Drivers MUST use the defined names of <code>tlsDisableOCSPEndpointCheck</code> and <code>tlsDisableCertificateRevocationCheck</code> for the
connection string parameters to ensure portability of connection strings across applications and drivers. If drivers
solicit MongoClient options through another mechanism (e.g. an options dictionary provided to the MongoClient
constructor), drivers SHOULD use the defined name but MAY deviate to comply with their existing conventions. For
example, a driver may use <code>tls_disable_ocsp_endpoint_check</code> instead of <code>tlsDisableOCSPEndpointCheck</code>.</p>
<h3 id="how-ocsp-interacts-with-existing-configuration-options"><a class="header" href="#how-ocsp-interacts-with-existing-configuration-options">How OCSP interacts with existing configuration options</a></h3>
<p>The following requirements apply only to drivers that are able to enable/disable OCSP on a per MongoClient basis.</p>
<ol>
<li>If a connection string specifies <code>tlsInsecure=true</code> then the driver MUST disable OCSP.</li>
<li>If a connection string contains both <code>tlsInsecure</code> and <code>tlsDisableOCSPEndpointCheck</code> then the driver MUST throw an
error.</li>
<li>If a driver supports <code>tlsAllowInvalidCertificates</code>, and a connection string specifies
<code>tlsAllowInvalidCertificates=true</code>, then the driver MUST disable OCSP.</li>
<li>If a driver supports <code>tlsAllowInvalidCertificates</code>, and a connection string specifies both
<code>tlsAllowInvalidCertificates</code> and <code>tlsDisableOCSPEndpointCheck</code>, then the driver MUST throw an error.</li>
</ol>
<p>The remaining requirements in this section apply only to drivers that expose an option to enable/disable certificate
revocation checking on a per MongoClient basis.</p>
<ol>
<li>Driver MUST enable OCSP support (with stapling if possible) when certificate revocation checking is enabled
<strong>unless</strong> their driver exhibits hard-fail behavior (see
<a href="#tlsdisablecertificaterevocationcheck">tlsDisableCertificateRevocationCheck</a>). In such a case, a driver MUST disable
OCSP support on the platforms where its TLS library exhibits hard-fail behavior.</li>
<li>Drivers SHOULD throw an error if any of <code>tlsInsecure=true</code> or <code>tlsAllowInvalidCertificates=true</code> or
<code>tlsDisableOCSPEndpointCheck=true</code> is specified alongside the option to enable certificate revocation checking.</li>
<li>If a connection string contains both <code>tlsInsecure</code> and <code>tlsDisableCertificateRevocationCheck</code> then the driver MUST
throw an error.</li>
<li>If a driver supports <code>tlsAllowInvalidCertificates</code> and a connection string specifies both
<code>tlsAllowInvalidCertificates</code> and <code>tlsDisableCertificateRevocationCheck</code>, then the driver MUST throw an error.</li>
<li>If a driver supports <code>tlsDisableOCSPEndpointCheck</code>, and a connection string specifies
<code>tlsDisableCertificateRevocationCheck</code>, then the driver MUST throw an error.</li>
</ol>
<h3 id="tls-requirements"><a class="header" href="#tls-requirements">TLS Requirements</a></h3>
<p><a href="https://en.wikipedia.org/wiki/Server_Name_Indication">Server Name Indication</a> (SNI) MUST BE used in the TLS connection
that obtains the server's certificate, otherwise the server may present the incorrect certificate. This requirement is
especially relevant to drivers whose TLS libraries allow for finer-grained control over their TLS behavior (e.g. Python,
C).</p>
<h3 id="documentation-requirements"><a class="header" href="#documentation-requirements">Documentation Requirements</a></h3>
<p>Drivers that cannot support OCSP MUST document this lack of support. Additionally, such drivers MUST document the
following:</p>
<ul>
<li>They MUST document that they will be unable to support certificate revocation checking with Atlas when Atlas moves to
OCSP-only certificates.</li>
<li>They MUST document that users should be aware that if they use a Certificate Authority (CA) that issues OCSP-only
certificates, then the driver cannot perform certificate revocation checking.</li>
</ul>
<p>Drivers that support OCSP without stapling MUST document this lack of support for stapling. They also MUST document
their behavior when an OCSP responder is unavailable and a server has a Must-Staple certificate. If a driver is able to
connect in such a scenario due to the prevalence of
"<a href="https://www.imperialviolet.org/2014/04/19/revchecking.html">soft-fail</a>" behavior in TLS libraries (where a certificate
is accepted when an answer from an OCSP responder cannot be obtained), they additionally MUST document that this ability
to connect to a server with a Must-Staple certificate when an OCSP responder is unavailable differs from the mongo shell
or a driver that does support OCSP-stapling, both of which will fail to connect (i.e. "hard-fail") in such a scenario.</p>
<p>If a driver (e.g. <a href="https://www.mongodb.com/docs/languages/python/pymongo-driver/current/connect/tls/">Python</a>,
<a href="http://mongoc.org/libmongoc/current/mongoc_ssl_opt_t.html">C</a>) allows the user to provide their own certificate
revocation list (CRL), then that driver MUST document their TLS library's preference between the user-provided CRL and
OCSP.</p>
<p>Drivers that cannot enable OCSP by default on a per MongoClient basis (e.g. Java) MUST document this limitation.</p>
<p>Drivers that fail either of the "Malicious Server Tests" (i.e. the driver connects to a test server without TLS
constraints being relaxed) as defined in the test plan below MUST document that their chosen TLS library will connect in
the case that a server with a Must-Staple certificate does not staple a response.</p>
<p>Drivers that fail "Malicious Server Test 2" (i.e. the driver connects to the test server without TLS constraints being
relaxed) as defined in the test plan below MUST document that their chosen TLS library will connect in the case that a
server with a Must-Staple certificate does not staple a response and the OCSP responder is down.</p>
<p>Drivers that fail "Soft Fail Test" MUST document that their driver's TLS library utilizes "hard fail" behavior in the
case of an unavailable OCSP responder in contrast to the mongo shell and drivers that utilize "soft fail" behavior. They
also MUST document the change in defaults for the applicable options (see
<a href="#mongoclient-configuration">MongoClient Configuration</a>).</p>
<p>If any changes related to defaults for OCSP behavior are made after a driver version that supports OCSP has been
released, the driver MUST document potential backwards compatibility issues as noted in the
<a href="#backwards-compatibility">Backwards Compatibility</a> section.</p>
<h2 id="test-plan"><a class="header" href="#test-plan">Test Plan</a></h2>
<p>See <a href="tests/README.html">tests/README</a> for tests.</p>
<h2 id="motivation-for-change"><a class="header" href="#motivation-for-change">Motivation for Change</a></h2>
<p>MongoDB Atlas intends to use <a href="https://letsencrypt.org/">LetsEncrypt</a>, a Certificate Authority (CA) that does not use
CRLs and only uses OCSP. (Atlas currently uses DigiCert certificates which specify both OCSP endpoints and CRL
distribution points.) Therefore, the MongoDB server is adding support for OCSP, and drivers need to support OCSP in
order for applications to continue to have the ability to verify the revocation status of an Atlas server's certificate.
Other CAs have also stopped using CRLs, so enabling OCSP support will ensure that a customer's choice in CAs is not
limited by a driver's lack of OCSP support.</p>
<p>OCSP stapling will also help applications deployed behind a firewall with an outbound allowList. It's a very natural
mistake to neglect to allowList the CRL distribution points and the OCSP endpoints, which can prevent an application
from connecting to a MongoDB instance if certificate revocation checking is enabled but the driver does not support OCSP
stapling.</p>
<p>Finally, drivers whose TLS libraries support <a href="https://en.wikipedia.org/wiki/OCSP_stapling">OCSP stapling</a> extension will
be able to minimize the number of network round trips for the client because the driver's TLS library will read an OCSP
response stapled to the server's certificate that the server provides as part of the TLS handshake. Drivers whose TLS
libraries support OCSP but not stapling will need to make an additional round trip to contact the OCSP endpoint.</p>
<h2 id="design-rationale"><a class="header" href="#design-rationale">Design Rationale</a></h2>
<p>We have chosen not to force drivers whose TLS libraries do not support OCSP/stapling "out of the box" to implement OCSP
support due to the extra work and research that this might require. Similarly, this specification uses "SHOULD" more
commonly (when other specs would prefer "MUST") to account for the fact that some drivers may not be able to fully
customize OCSP behavior in their TLS library.</p>
<p>We are requiring drivers to support both stapled OCSP and non-stapled OCSP in order to support revocation checking for
server versions in Atlas that do not support stapling, especially after Atlas switches to Let's Encrypt certificates
(which do not have CRLs). Additionally, even when servers do support stapling, in the case of a non-"Must Staple"
certificate (which is the type that Atlas is planning to use), if the server is unable to contact the OCSP responder
(e.g. due to a network error) and staple a certificate, the driver being able to query the certificate's OCSP endpoint
allows for one final chance to attempt to verify the certificate's validity.</p>
<h3 id="malicious-server-tests"><a class="header" href="#malicious-server-tests">Malicious Server Tests</a></h3>
<p>"Malicious Server Test 2" is designed to reveal the behavior of TLS libraries of drivers in one of the worst case
scenarios. Since a majority of the drivers will not have fine-grained control over their OCSP behavior, this test case
provides signal about the soft/hard fail behavior in a driver's TLS library so that we can document this.</p>
<p>A driver with control over its OCSP behavior will react the same in "Malicious Server Test 1" and "Malicious Server Test
2", terminating the connection as long as TLS constraints have not been relaxed.</p>
<h3 id="atlas-connectivity-tests"><a class="header" href="#atlas-connectivity-tests">Atlas Connectivity Tests</a></h3>
<p>No additional Atlas connectivity tests will be added because the existing tests should provide sufficient coverage
(provided that one of the non-free tier clusters is upgraded ≥ 3.6).</p>
<h3 id="suggested-ocsp-behavior-1"><a class="header" href="#suggested-ocsp-behavior-1">Suggested OCSP Behavior</a></h3>
<p>For drivers with finer-grain control over their OCSP behavior, the suggested OCSP behavior was chosen as a balance
between security and availability, erring on availability while minimizing network round trips. Therefore, in order to
minimize network round trips, drivers are advised not to reach out to OCSP endpoints and CRL distribution points in
order to verify the revocation status of intermediate certificates.</p>
<h2 id="backwards-compatibility"><a class="header" href="#backwards-compatibility">Backwards Compatibility</a></h2>
<p>An application behind a firewall with an outbound allowList that upgrades to a driver implementing this specification
may experience connectivity issues when OCSP is enabled. This is because the driver may need to contact OCSP endpoints
or CRL distribution points<sup class="footnote-reference"><a href="#1">1</a></sup> specified in the server's certificate and if these OCSP endpoints and/or CRL distribution
points are not accessible, then the connection to the server may fail. (N.B.: TLS libraries
<a href="https://blog.hboeck.de/archives/886-The-Problem-with-OCSP-Stapling-and-Must-Staple-and-why-Certificate-Revocation-is-still-broken.html">typically implement "soft fail"</a>
such that connections can continue even if the OCSP server is inaccessible, so this issue is much more likely in the
case of a server with a certificate that only contains CRL distribution points.) In such a scenario, connectivity may be
able to be restored by disabling non-stapled OCSP via <code>tlsDisableOCSPEndpointCheck</code> or by disabling certificate
revocation checking altogether via <code>tlsDisableCertificateRevocationCheck</code>.</p>
<p>An application that uses a driver that utilizes hard-fail behavior when there are no certificate revocation mechanisms
available may also experience connectivity issue. Cases in which no certificate revocation mechanisms being available
include:</p>
<ol>
<li>When a server's certificate defines neither OCSP endpoints nor CRL distribution points</li>
<li>When a certificate defines CRL distribution points and/or OCSP endpoints but these points are unavailable (e.g. the
points are down or the application is deployed behind a restrictive firewall).</li>
</ol>
<p>In such a scenario, connectivity may be able to be restored by disabling non-stapled OCSP via
<code>tlsDisableOCSPEndpointCheck</code> or by disabling certificate revocation checking via
<code>tlsDisableCertificateRevocationCheck</code>.</p>
<h2 id="reference-implementation"><a class="header" href="#reference-implementation">Reference Implementation</a></h2>
<p>The .NET/C#, Python, C, and Go drivers will provide the reference implementations. See
<a href="https://jira.mongodb.org/browse/CSHARP-2817">CSHARP-2817</a>, <a href="https://jira.mongodb.org/browse/PYTHON-2093">PYTHON-2093</a>,
<a href="https://jira.mongodb.org/browse/CDRIVER-3408">CDRIVER-3408</a> and
<a href="http://jira.mongodb.org/browse/GODRIVER-1467">GODRIVER-1467</a>.</p>
<h2 id="security-implications"><a class="header" href="#security-implications">Security Implications</a></h2>
<p>Customers should be aware that if they choose to use CA that only supports OCSP, they will not be able to check
certificate validity in drivers that cannot support OCSP.</p>
<p>In the case that the server has a Must-Staple certificate and its OCSP responder is down (for longer than the server is
able to cache and staple a previously acquired response), the mongo shell or a driver that supports OCSP stapling will
not be able to connect while a driver that supports OCSP but not stapling will be able to connect.</p>
<p>TLS libraries may implement "<a href="https://www.imperialviolet.org/2014/04/19/revchecking.html">soft-fail</a>" in the case of
non-stapled OCSP which may be undesirable in highly secure contexts.</p>
<p>Drivers that fail the "Malicious Server" tests as defined in Test Plan will connect in the case that server with a
Must-Staple certificate does not staple a response.</p>
<h3 id="testing-against-valid-certificate-chains"><a class="header" href="#testing-against-valid-certificate-chains">Testing Against Valid Certificate Chains</a></h3>
<p>Some TLS libraries are stricter about the types of certificate chains they're willing to accept (and it can be difficult
to debug why a particular certificate chain is considered invalid by a TLS library). Clients and servers with more
control over their OCSP implementation may run into fewer up front costs, but this may be at the cost of not fully
implementing every single aspect of OCSP.</p>
<p>For example, the server team's certificate generation tool generated X509 V1 certificates which were used for testing
OCSP without any issues in the server team's tests. However, while we were creating a test plan for drivers, we
discovered that Java's keytool refused to import X509 V1 certificates into its trust store and thus had to modify the
server team's certificate generation tool to generate V3 certificates.</p>
<p>Another example comes from <a href="https://github.com/dotnet/corefx/issues/41475">.NET on Linux</a>, which currently enforces the
CA/Browser forum requirement that while a leaf certificate can be covered solely by OCSP, "public CAs have to have
CRL[s] covering their issuing CAs". This requirement is not enforced with Java's default TLS libraries. See also:
<a href="#cabrowser-forum-requirements-complications">Future Work: CA/Browser Forum Requirements Complications</a>.</p>
<h2 id="future-work"><a class="header" href="#future-work">Future Work</a></h2>
<p>When the server work is backported, drivers will need to update their prose tests so that tests are run against a wider
range of compatible servers.</p>
<p>Automated Atlas connectivity tests (<a href="https://jira.mongodb.org/browse/DRIVERS-382">DRIVERS-382</a>) may be updated with
additional OCSP-related URIs when 4.4 becomes available for Atlas; alternatively, the clusters behind those URIs may be
updated to 4.4 (or an earlier version where OCSP has been backported). Note: While the free tier cluster used for the
Automated Atlas connectivity tests will automatically get updated to 4.4 when it is available, Atlas currently does not
plan to enable OCSP for free and shared tier instances (i.e. Atlas Proxy).</p>
<p>Options to configure failure behavior (e.g. to maximize security or availability) may be added in the future.</p>
<h3 id="cabrowser-forum-requirements-complications"><a class="header" href="#cabrowser-forum-requirements-complications">CA/Browser Forum Requirements Complications</a></h3>
<p>The test plan may need to be reworked if we discover that a driver's TLS library strictly implements CA/Browser forum
requirements (e.g. <a href="https://github.com/dotnet/corefx/issues/41475">.NET on Linux</a>). This is because our current chain of
certificates does not fulfill the following requirement: while a leaf certificate can be covered solely by OCSP, "public
CAs have to have CRL[s] covering their issuing CAs." This rework of the test plan may happen during the initial
implementation of OCSP support or happen later if a driver's TLS library implements the relevant CA/Browser forum
requirement.</p>
<p>Extending the chain to fulfill the CA/Browser requirement should solve this issue, although drivers that don't support
manually supplying a CRL may need to host a web server that serves the required CRL during testing.</p>
<h2 id="qa"><a class="header" href="#qa">Q&amp;A</a></h2>
<h3 id="can-we-use-one-evergreen-task-combined-with-distinct-certificates-for-each-column-in-the-test-matrix-to-prevent-ocsp-caching-from-affecting-testing"><a class="header" href="#can-we-use-one-evergreen-task-combined-with-distinct-certificates-for-each-column-in-the-test-matrix-to-prevent-ocsp-caching-from-affecting-testing">Can we use one Evergreen task combined with distinct certificates for each column in the test matrix to prevent OCSP caching from affecting testing?</a></h3>
<p>No. This is because Evergreen may reuse a host with an OCSP cache from a previous execution, so using distinct
certificates per column would not obviate the need to clear all relevant OCSP caches prior to each test run. Since
Evergreen does perform some cleanup between executions, having separate tasks for each test column offers an additional
layer of safety in protecting against stale data in OCSP caches.</p>
<h3 id="should-drivers-use-a-nonce-when-creating-an-ocsp-request"><a class="header" href="#should-drivers-use-a-nonce-when-creating-an-ocsp-request">Should drivers use a nonce when creating an OCSP request?</a></h3>
<p>A driver MAY use a nonce if desired, but
<a href="https://tools.ietf.org/html/rfc6960#section-4.4.1">including a nonce in an OCSP request</a> is not required as the server
does not explicitly support nonces.</p>
<h3 id="should-drivers-utilize-a-tolerance-period-when-accepting-ocsp-responses"><a class="header" href="#should-drivers-utilize-a-tolerance-period-when-accepting-ocsp-responses">Should drivers utilize a tolerance period when accepting OCSP responses?</a></h3>
<p>No. Although
<a href="https://tools.ietf.org/html/rfc5019">RFC 5019, The Lightweight Online Certificate Status Protocol (OCSP) Profile for High-Volume Environments,</a>
allows for the configuration of a tolerance period for the acceptance of OCSP responses after <code>nextUpdate</code>, this spec is
not adhering to that RFC.</p>
<h3 id="why-was-the-decision-made-to-allow-ocsp-endpoint-checking-to-be-enableddisabled-via-a-uri-option"><a class="header" href="#why-was-the-decision-made-to-allow-ocsp-endpoint-checking-to-be-enableddisabled-via-a-uri-option">Why was the decision made to allow OCSP endpoint checking to be enabled/disabled via a URI option?</a></h3>
<p>We initially hoped that we would be able to not expose any options specifically related to OCSP to the user, in
accordance with the "No Knobs" <a href="../driver-mantras.html">drivers mantra</a> However, we later decided that users may benefit
from having the ability to disable OCSP endpoint checking when applications are deployed behind restrictive firewall
with outbound allowLists, and this benefit is worth adding another URI option.</p>
<h2 id="appendix"><a class="header" href="#appendix">Appendix</a></h2>
<h3 id="os-level-ocsp-cache-manipulation"><a class="header" href="#os-level-ocsp-cache-manipulation">OS-Level OCSP Cache Manipulation</a></h3>
<h4 id="windows"><a class="header" href="#windows">Windows</a></h4>
<p>On Windows, the OCSP cache can be viewed like so:</p>
<pre><code class="language-bash">certutil -urlcache
</code></pre>
<p>To search the cache for "Lets Encrypt" OCSP cache entries, the following command could be used:</p>
<pre><code class="language-bash">certutil -urlcache | findstr letsencrypt.org
</code></pre>
<p>On Windows, the OCSP cache can be cleared like so:</p>
<pre><code class="language-bash">certutil -urlcache * delete
</code></pre>
<p>To delete only "Let's Encrypt" related entries, the following command could be used:</p>
<pre><code class="language-bash">certutil -urlcache letsencrypt.org delete
</code></pre>
<h4 id="macos"><a class="header" href="#macos">macOS</a></h4>
<p>On macOS 10.14, the OCSP cache can be viewed like so:</p>
<pre><code class="language-bash">find ~/profile/Library/Keychains -name 'ocspcache.sqlite3' \
-exec sqlite3 "{}" 'SELECT responderURI FROM responses;' \;
</code></pre>
<p>To search the cache for "Let's Encrypt" OCSP cache entries, the following command could be used:</p>
<pre><code class="language-bash">find ~/profile/Library/Keychains \
-name 'ocspcache.sqlite3' \
-exec sqlite3 "{}" \
'SELECT responderURI FROM responses WHERE responderURI LIKE "http://%.letsencrypt.org%";' \;
</code></pre>
<p>On macOS 10.14, the OCSP cache can be cleared like so:</p>
<pre><code class="language-bash">find ~/profile/Library/Keychains -name 'ocspcache.sqlite3' \
-exec sqlite3 "{}" 'DELETE FROM responses ;' \;
</code></pre>
<p>To delete only "Let's Encrypt" related entries, the following command could be used:</p>
<pre><code class="language-bash">find ~/profile/Library/Keychains -name 'ocspcache.sqlite3' \
-exec sqlite3 "{}" \
'DELETE FROM responses WHERE responderURI LIKE "http://%.letsencrypt.org%";' \;
</code></pre>
<h3 id="optional-quick-manual-validation-tests-of-ocsp-support"><a class="header" href="#optional-quick-manual-validation-tests-of-ocsp-support">Optional Quick Manual Validation Tests of OCSP Support</a></h3>
<p>These optional validation tests are not a required part of the test plan. However, these optional tests may be useful
for drivers trying to quickly determine if their TLS library supports OCSP and/or as an initial manual testing goal when
implementing OCSP support.</p>
<h4 id="optional-test-to-ensure-that-the-drivers-tls-library-supports-ocsp-stapling"><a class="header" href="#optional-test-to-ensure-that-the-drivers-tls-library-supports-ocsp-stapling">Optional test to ensure that the driver's TLS library supports OCSP stapling</a></h4>
<p>Create a test application with a connection string with TLS enabled that connects to any server that has OCSP-only
certificate and supports OCSP stapling.</p>
<p>For example, the test application could connect to C<sub>V</sub>, one of the special testing Atlas clusters with a valid
OCSP-only certificate. see Future Work for additional information).</p>
<p>Alternatively, the test application can attempt to connect to a <strong>non-mongod server</strong> that supports OCSP-stapling and
has a valid an OCSP-only certificate. The connection will fail of course, but we are only interested in the TLS
handshake and the OCSP requests that may follow. For example, the following connection string could be used:
<code>mongodb://valid-isrgrootx1.letsencrypt.org:443/?tls=true</code></p>
<p>Run the test application and verify through packet analysis that the driver's ClientHello message's TLS extension
section includes the <code>status_request</code> extension, thus indicating that the driver is advertising that it supports OCSP
stapling.</p>
<p>Note: If using <a href="https://www.wireshark.org/">WireShark</a> as your chosen packet analyzer, the <code>tls</code> (case-sensitive)
display filter may be useful in this endeavor.</p>
<h4 id="ocsp-caching-and-the-optional-test-to-ensure-that-the-drivers-tls-library-supports-non-stapled-ocsp"><a class="header" href="#ocsp-caching-and-the-optional-test-to-ensure-that-the-drivers-tls-library-supports-non-stapled-ocsp">OCSP Caching and the optional test to ensure that the driver's TLS library supports non-stapled OCSP</a></h4>
<p>The "Optional test to ensure that the driver's TLS library supports non-stapled OCSP" is complicated by the fact that
OCSP allows the client to <a href="https://tools.ietf.org/html/rfc5019#section-6.1">cache the OCSP responses</a>, so clearing an
OCSP cache may be needed in order to force the TLS library to reach out to an OCSP endpoint. This cache may exist at the
OS-level, application-level and/or at the user-level.</p>
<h4 id="optional-test-to-ensure-that-the-drivers-tls-library-supports-non-stapled-ocsp"><a class="header" href="#optional-test-to-ensure-that-the-drivers-tls-library-supports-non-stapled-ocsp">Optional test to ensure that the driver's TLS library supports non-stapled OCSP</a></h4>
<p>Create a test application with a connection string with TLS enabled that connects to any server with an OCSP-only
certificate.</p>
<p>Alternatively, the test application can attempt to connect to a <strong>non-mongod server</strong> that does not support
OCSP-stapling and has a valid an OCSP-only certificate. The connection will fail of course, but we are only interested
in the TLS handshake and the OCSP requests that may follow.</p>
<p>Alternatively, if it's known that a driver's TLS library does not support stapling or if stapling support can be toggled
off, then any <strong>non-mongod server</strong> that has a valid an OCSP-only certificate will work, including the example shown in
the "Optional test to ensure that the driver's TLS library supports OCSP stapling."</p>
<p>Clear the OS/user/application OCSP cache, if one exists and the TLS library makes use of it.</p>
<p>Run the test application and ensure that the TLS handshake succeeds. connection succeeds. Ensure that the driver's TLS
library has contacted the OCSP endpoint specified in the server's certificate. Two simple ways of checking this are:</p>
<ul>
<li>Use a packet analyzer while the test application is running to ensure that the driver's TLS library contacts the OCSP
endpoint. When using WireShark, the <code>ocsp</code> and <code>tls</code> (case-sensitive) display filters may be useful in this endeavor.</li>
<li>If the TLS library utilizes an OCSP cache and the cache was cleared prior to starting the test application, check the
OCSP cache for a response from an OCSP endpoint specified in the server's certificate.</li>
</ul>
<h2 id="changelog"><a class="header" href="#changelog">Changelog</a></h2>
<ul>
<li>
<p>2024-08-20: Migrated from reStructuredText to Markdown.</p>
</li>
<li>
<p>2022-10-05: Remove spec front matter and reformat changelog.</p>
</li>
<li>
<p>2022-01-19: Require that timeouts be applied per the client-side operations timeout spec.</p>
</li>
<li>
<p>2021-04-07: Updated terminology to use allowList.</p>
</li>
<li>
<p>2020-07-01: Default tlsDisableOCSPEndpointCheck or tlsDisableCertificateRevocationCheck to true in the case that a
driver's TLS library exhibits hard-fail behavior and add provision for platform-specific defaults.</p>
</li>
<li>
<p>2020-03-20: Clarify OCSP documentation requirements for drivers unable to enable OCSP by default on a per MongoClient
basis.</p>
</li>
<li>
<p>2020-03-03: Add tlsDisableCertificateRevocationCheck URI option. Add Go as a reference implementation. Add hard-fail
backwards compatibility documentation requirements.</p>
</li>
<li>
<p>2020-02-26: Add tlsDisableOCSPEndpointCheck URI option.</p>
</li>
<li>
<p>2020-02-19: Clarify behavior for reaching out to OCSP responders.</p>
</li>
<li>
<p>2020-02-10: Add cache requirement.</p>
</li>
<li>
<p>2020-01-31: Add SNI requirement and clarify design rationale regarding minimizing round trips.</p>
</li>
<li>
<p>2020-01-28: Clarify behavior regarding nonces and tolerance periods.</p>
</li>
<li>
<p>2020-01-16: Initial commit.</p>
</li>
</ul>
<h2 id="endnotes"><a class="header" href="#endnotes">Endnotes</a></h2>
<div class="footnote-definition" id="1"><sup class="footnote-definition-label">1</sup>
<p>Since this specification mandates that a driver must enable OCSP when possible, this may involve enabling
certificate revocation checking in general, and thus the accessibility of CRL distribution points can become a
factor.</p>
</div>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../uri-options/uri-options.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../mongodb-handshake/handshake.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../uri-options/uri-options.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../mongodb-handshake/handshake.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../elasticlunr.min.js"></script>
        <script src="../mark.min.js"></script>
        <script src="../searcher.js"></script>

        <script src="../clipboard.min.js"></script>
        <script src="../highlight.js"></script>
        <script src="../book.js"></script>

        <!-- Custom JS scripts -->


    </div>
    </body>
</html>
