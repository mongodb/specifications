collection_name: &collection_name "test"
database_name: &database_name "change-stream-tests"
collection2_name: &collection2_name "test2"
database2_name: &database2_name "change-stream-tests-2"
tests:
  -
    description: "change stream resumes after a network error"
    minServerVersion: "4.2"
    failPoint:
      configureFailPoint: failCommand
      mode: { times: 1 }
      data:
          failCommands: ["getMore"]
          closeConnection: true
    target: collection
    topology: 
      - replicaset
      - sharded
    changeStreamPipeline: []
    changeStreamOptions: {}
    operations:
      -
        database: *database_name
        collection: *collection_name
        name: insertOne
        arguments:
          document:
            x: 1
    expectations:
      -
        command_started_event:
          command:
            aggregate: *collection_name
            cursor: {}
            pipeline:
              -
                $changeStream: {}
          command_name: aggregate
          database_name: *database_name
      -
        command_started_event:
          command:
            getMore: "42"
            collection: *collection_name
          command_name: getMore
          database_name: *database_name
      -
        command_started_event:
          command:
            killCursors: *collection_name
          command_name: killCursors
          database_name: *database_name
      -
        command_started_event:
          command:
            aggregate: *collection_name
            cursor: {}
            pipeline:
              -
                $changeStream: {}
    result:
      success:
        -
          _id: "42"
          documentKey: "42"
          operationType: insert
          ns:
            db: *database_name
            coll: *collection_name
          fullDocument:
            x:
              $numberInt: "1"
  -
    description: "change stream resumes after HostUnreachable"
    minServerVersion: "4.2"
    failPoint:
      configureFailPoint: failCommand
      mode: { times: 1 }
      data:
          failCommands: ["getMore"]
          errorCode: 6
          closeConnection: false
    target: collection
    topology: 
      - replicaset
      - sharded
    changeStreamPipeline: []
    changeStreamOptions: {}
    operations:
      -
        database: *database_name
        collection: *collection_name
        name: insertOne
        arguments:
          document:
            x: 1
    expectations:
      -
        command_started_event:
          command:
            aggregate: *collection_name
            cursor: {}
            pipeline:
              -
                $changeStream: {}
          command_name: aggregate
          database_name: *database_name
      -
        command_started_event:
          command:
            getMore: "42"
            collection: *collection_name
          command_name: getMore
          database_name: *database_name
      -
        command_started_event:
          command:
            killCursors: *collection_name
          command_name: killCursors
          database_name: *database_name
      -
        command_started_event:
          command:
            aggregate: *collection_name
            cursor: {}
            pipeline:
              -
                $changeStream: {}
    result:
      success:
        -
          _id: "42"
          documentKey: "42"
          operationType: insert
          ns:
            db: *database_name
            coll: *collection_name
          fullDocument:
            x:
              $numberInt: "1"
