description: Detect stale application errors
uri: mongodb://a/?replicaSet=rs
phases:
- description: Primary A is discovered
  responses:
  - - a:27017
    - ok: 1
      ismaster: true
      hosts:
      - a:27017
      setName: rs
      minWireVersion: 0
      maxWireVersion: 9
      topologyVersion: &topologyVersion_1_1
        processId:
          "$oid": '000000000000000000000001'
        counter:
          "$numberLong": '1'
  outcome:
    servers:
      a:27017:
        type: RSPrimary
        setName: rs
        topologyVersion: *topologyVersion_1_1
        pool:
          generation: 0
    topologyType: ReplicaSetWithPrimary
    logicalSessionTimeoutMinutes: null
    setName: rs

- description: Non-stale application error (topologyVersion greater)
  applicationErrors:
  - address: a:27017
    generation: 0
    type: command
    response:
      ok: 0
      errmsg: ShutdownInProgress
      code: 91
      topologyVersion: &topologyVersion_1_2
        processId:
          "$oid": '000000000000000000000001'
        counter:
          "$numberLong": '2'
  outcome:
    servers:
      a:27017:
        type: Unknown
        topologyVersion: *topologyVersion_1_2
        pool:
          generation: 1
    topologyType: ReplicaSetNoPrimary
    logicalSessionTimeoutMinutes: null
    setName: rs

- description: Primary A is rediscovered (1)
  responses:
  - - a:27017
    - ok: 1
      ismaster: true
      hosts:
      - a:27017
      setName: rs
      minWireVersion: 0
      maxWireVersion: 9
      topologyVersion: *topologyVersion_1_2
  outcome:
    servers:
      a:27017:
        type: RSPrimary
        setName: rs
        topologyVersion: *topologyVersion_1_2
        pool:
          generation: 1
    topologyType: ReplicaSetWithPrimary
    logicalSessionTimeoutMinutes: null
    setName: rs

- description: Non-stale application error (topologyVersion.processId differs)
  applicationErrors:
  - address: a:27017
    generation: 1
    type: command
    response:
      ok: 0
      errmsg: ShutdownInProgress
      code: 91
      topologyVersion: &topologyVersion_2_1
        processId:
          "$oid": '000000000000000000000002'
        counter:
          "$numberLong": '1'
  outcome:
    servers:
      a:27017:
        type: Unknown
        topologyVersion: *topologyVersion_2_1
        pool:
          generation: 2
    topologyType: ReplicaSetNoPrimary
    logicalSessionTimeoutMinutes: null
    setName: rs

- description: Primary A is rediscovered (2)
  responses:
  - - a:27017
    - ok: 1
      ismaster: true
      hosts:
      - a:27017
      setName: rs
      minWireVersion: 0
      maxWireVersion: 9
      topologyVersion: &topologyVersion_2_2
        processId:
          "$oid": '000000000000000000000002'
        counter:
          "$numberLong": '2'
  outcome:
    servers:
      a:27017:
        type: RSPrimary
        setName: rs
        topologyVersion: *topologyVersion_2_2
        pool:
          generation: 2
    topologyType: ReplicaSetWithPrimary
    logicalSessionTimeoutMinutes: null
    setName: rs

- description: Non-stale application error (topologyVersion missing)
  applicationErrors:
  - address: a:27017
    generation: 2
    type: command
    response:
      ok: 0
      errmsg: ShutdownInProgress
      code: 91
  outcome:
    servers:
      a:27017:
        type: Unknown
        topologyVersion: null
        pool:
          generation: 3
    topologyType: ReplicaSetNoPrimary
    logicalSessionTimeoutMinutes: null
    setName: rs

- description: Primary A is rediscovered (3)
  responses:
  - - a:27017
    - ok: 1
      ismaster: true
      hosts:
      - a:27017
      setName: rs
      minWireVersion: 0
      maxWireVersion: 9
      topologyVersion: &topologyVersion_3_1
        processId:
          "$oid": '000000000000000000000003'
        counter:
          "$numberLong": '1'
  outcome:
    servers:
      a:27017:
        type: RSPrimary
        setName: rs
        topologyVersion: *topologyVersion_3_1
        pool:
          generation: 3
    topologyType: ReplicaSetWithPrimary
    logicalSessionTimeoutMinutes: null
    setName: rs

- description: Non-stale application network error
  applicationErrors:
  - address: a:27017
    generation: 3
    type: network
  outcome:
    servers:
      a:27017:
        type: Unknown
        topologyVersion: null
        pool:
          generation: 4
    topologyType: ReplicaSetNoPrimary
    logicalSessionTimeoutMinutes: null
    setName: rs

- description: Primary A is rediscovered (4)
  responses:
  - - a:27017
    - ok: 1
      ismaster: true
      hosts:
      - a:27017
      setName: rs
      minWireVersion: 0
      maxWireVersion: 9
      topologyVersion: *topologyVersion_3_1
  outcome:
    servers:
      a:27017:
        type: RSPrimary
        setName: rs
        topologyVersion: *topologyVersion_3_1
        pool:
          generation: 4
    topologyType: ReplicaSetWithPrimary
    logicalSessionTimeoutMinutes: null
    setName: rs

- description: Non-stale application network error (beforeHandshakeCompletes)
  applicationErrors:
  - address: a:27017
    generation: 4
    type: network
  outcome:
    servers:
      a:27017:
        type: Unknown
        topologyVersion: null
        pool:
          generation: 5
    topologyType: ReplicaSetNoPrimary
    logicalSessionTimeoutMinutes: null
    setName: rs

- description: Primary A is rediscovered (5)
  responses:
  - - a:27017
    - ok: 1
      ismaster: true
      hosts:
      - a:27017
      setName: rs
      minWireVersion: 0
      maxWireVersion: 9
      topologyVersion: *topologyVersion_3_1
  outcome:
    servers:
      a:27017:
        type: RSPrimary
        setName: rs
        topologyVersion: *topologyVersion_3_1
        pool:
          generation: 5
    topologyType: ReplicaSetWithPrimary
    logicalSessionTimeoutMinutes: null
    setName: rs

- description: Non-stale application network timeout error (beforeHandshakeCompletes)
  applicationErrors:
  - address: a:27017
    generation: 5
    type: timeout
  outcome:
    servers:
      a:27017:
        type: Unknown
        topologyVersion: null
        pool:
          generation: 6
    topologyType: ReplicaSetNoPrimary
    logicalSessionTimeoutMinutes: null
    setName: rs

- description: Primary A is rediscovered (6)
  responses:
  - - a:27017
    - ok: 1
      ismaster: true
      hosts:
      - a:27017
      setName: rs
      minWireVersion: 0
      maxWireVersion: 9
      topologyVersion: *topologyVersion_3_1
  outcome: &outcome_3_1
    servers:
      a:27017:
        type: RSPrimary
        setName: rs
        topologyVersion: *topologyVersion_3_1
        pool:
          generation: 6
    topologyType: ReplicaSetWithPrimary
    logicalSessionTimeoutMinutes: null
    setName: rs

- description: Ignore network timeout application error
  applicationErrors:
  - address: a:27017
    generation: 6
    type: timeout
  outcome: *outcome_3_1

- description: Ignore stale application network error (generation differs)
  applicationErrors:
  - address: a:27017
    generation: 5
    type: network
  outcome: *outcome_3_1

- description: Ignore stale application command error (generation differs)
  applicationErrors:
  - address: a:27017
    generation: 5
    type: command
    response:
      ok: 0
      errmsg: ShutdownInProgress
      code: 91
  outcome: *outcome_3_1


- description: Ignore stale application command error (topologyVersion less)
  applicationErrors:
  - address: a:27017
    generation: 6
    type: command
    response:
      ok: 0
      errmsg: ShutdownInProgress
      code: 91
      topologyVersion:
        processId:
          "$oid": '000000000000000000000003'
        counter:
          "$numberLong": '0'
  outcome: *outcome_3_1

- description: Ignore stale application command error (topologyVersion equal)
  applicationErrors:
  - address: a:27017
    generation: 6
    type: command
    response:
      ok: 0
      errmsg: ShutdownInProgress
      code: 91
      topologyVersion:
        processId:
          "$oid": '000000000000000000000003'
        counter:
          "$numberLong": '1'
  outcome: *outcome_3_1
