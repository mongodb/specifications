---
description: insert-shutdown-error
schemaVersion: "1.10"
runOnRequirements:
  - minServerVersion: "4.4"
createEntities:
  - client:
      id: &setupClient setupClient
initialData: &initialData
  - collectionName: &collectionName insert-shutdown-error
    databaseName: &databaseName sdam-tests
    documents: []
tests:
  - description: Concurrent shutdown error on insert
    operations:
      - name: createEntities
        object: testRunner
        arguments:
          entities:
            - client:
                id: &client client
                observeEvents:
                  - poolClearedEvent
                  - serverDescriptionChangedEvent
                uriOptions:
                  retryWrites: false
                  heartbeatFrequencyMS: 500
                  appname: shutdownErrorInsertTest
            - database:
                id: &database database
                client: *client
                databaseName: *databaseName
            - collection:
                id: &collection collection
                database: *database
                collectionName: *collectionName
      - name: insertOne
        object: *collection
        arguments:
          document:
            _id: 1
      - name: failPoint
        object: testRunner
        arguments:
          failPoint:
            configureFailPoint: failCommand
            mode:
              times: 2
            data:
              failCommands:
                - insert
              appName: shutdownErrorInsertTest
              errorCode: 91
              blockConnection: true
              blockTimeMS: 500
          client: *setupClient
      - name: createEntities
        object: testRunner
        arguments:
          entities:
            - thread:
                id: &thread0 thread0
      - name: createEntities
        object: testRunner
        arguments:
          entities:
            - thread:
                id: &thread1 thread1
      - name: runOnThread
        object: testRunner
        arguments:
          thread: *thread0
          operation:
            name: insertOne
            object: *collection
            arguments:
              document:
                _id: 2
            expectError:
              isError: true
      - name: runOnThread
        object: testRunner
        arguments:
          thread: *thread1
          operation:
            name: insertOne
            object: *collection
            arguments:
              document:
                _id: 3
            expectError:
              isError: true
      - name: waitForThread
        object: testRunner
        arguments:
          thread: *thread0
      - name: waitForThread
        object: testRunner
        arguments:
          thread: *thread1
      - name: waitForEvent
        object: testRunner
        arguments:
          client: *client
          event:
            serverDescriptionChangedEvent:
              newDescription:
                type: Unknown
          count: 1
      - name: waitForEvent
        object: testRunner
        arguments:
          client: *client
          event:
            poolClearedEvent: {}
          count: 1
      - name: insertOne
        object: *collection
        arguments:
          document:
            _id: 4
      - name: assertEventCount
        object: testRunner
        arguments:
          client: *client
          event:
            serverDescriptionChangedEvent:
              newDescription:
                type: Unknown
          count: 1
      - name: assertEventCount
        object: testRunner
        arguments:
          client: *client
          event:
            poolClearedEvent: {}
          count: 1
    outcome:
      - collectionName: *collectionName
        databaseName: *databaseName
        documents:
          - _id: 1
          - _id: 4
