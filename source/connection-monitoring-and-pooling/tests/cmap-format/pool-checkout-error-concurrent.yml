version: 1
style: integration
description: must properly handle multiple concurrent network errors on check out
runOn:
  -
    # required for appName in fail point
    minServerVersion: "4.9.0"
failPoint:
  configureFailPoint: failCommand
  # high amount to ensure not interfered with by monitor checks.
  mode: { times: 50 }
  data:
    failCommands: ["isMaster","hello"]
    closeConnection: true
    appName: &appName "poolCheckOutErrorTest"
poolOptions:
  appName: *appName
operations:
  - name: ready
  - name: start
    target: thread1
  - name: start
    target: thread2
  - name: start
    target: thread3
  - name: checkOut
    thread: thread1
  - name: checkOut
    thread: thread2
  - name: checkOut
    thread: thread3
  - name: waitForEvent
    event: ConnectionCheckOutFailed
    count: 3
  - name: ready
events:
  - type: ConnectionPoolReady
  # Pool should only be cleared once.
  - type: ConnectionPoolCleared
  - type: ConnectionPoolReady
ignore:
  - ConnectionCheckOutStarted
  - ConnectionCheckOutFailed
  - ConnectionPoolCreated
  - ConnectionCreated
  - ConnectionClosed

