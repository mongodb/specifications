# Tests in this file are generated from backpressure-retry-loop.yml.template.

description: tests that operations respect overload backoff retry loop

schemaVersion: '1.0'

runOnRequirements:
  -
    minServerVersion: '4.4' # failCommand
    topologies: [replicaset, sharded, load-balanced]

createEntities:
  -
    client:
      id: &client client
      useMultipleMongoses: false
      observeEvents: [ 'commandStartedEvent', 'commandSucceededEvent', 'commandFailedEvent' ]

  -
    client:
      id: &failPointClient failPointClient
      useMultipleMongoses: false

  -
    database:
      id: &utilDb utilDb
      client: *failPointClient
      databaseName: &database_name retryable-writes-tests

  -
    collection:
      id: &utilCollection utilCollection
      database: *utilDb
      collectionName: &collection_name coll

  -
    database:
      id: &database database
      client: *client
      databaseName: &database_name retryable-writes-tests
  -
    collection:
      id: &collection collection
      database: *database
      collectionName: &collection_name coll

initialData:
  -
    collectionName: *collection_name
    databaseName: *database_name
    documents:
      - { _id: 1, x: 11 }
      - { _id: 2, x: 22 }

tests:

  -
    description: 'client.listDatabases retries using operation loop'
    operations:
      -
        object: *utilCollection
        name: deleteMany
        arguments:
          filter: {}

      -
        object: *utilCollection
        name: deleteMany
        arguments:
          documents:
            - { _id: 1, x: 11 }      


      - name: failPoint
        object: testRunner
        arguments:
          client: *failPointClient
          failPoint:
            configureFailPoint: failCommand
            mode: { times: 3 }
            data:
              failCommands: [listDatabases]
              errorLabels: ["RetryableError", "SystemOverloadedError"]
              errorCode: 2
      
      -
        object: *client
        name: listDatabases
        arguments:
          filter: {}
        expectError: false

    expectEvents:
      - client: "client"
        events:
          - commandStartedEvent:
              commandName: listDatabases
          - commandFailedEvent:
              commandName: listDatabases
          - commandStartedEvent:
              commandName: listDatabases
          - commandFailedEvent:
              commandName: listDatabases
          - commandStartedEvent:
              commandName: listDatabases
          - commandFailedEvent:
              commandName: listDatabases
          - commandStartedEvent:
              commandName: listDatabases
          - commandSucceededEvent:
              commandName: listDatabases

  -
    description: 'client.listDatabaseNames retries using operation loop'
    operations:
      -
        object: *utilCollection
        name: deleteMany
        arguments:
          filter: {}

      -
        object: *utilCollection
        name: deleteMany
        arguments:
          documents:
            - { _id: 1, x: 11 }      


      - name: failPoint
        object: testRunner
        arguments:
          client: *failPointClient
          failPoint:
            configureFailPoint: failCommand
            mode: { times: 3 }
            data:
              failCommands: [listDatabases]
              errorLabels: ["RetryableError", "SystemOverloadedError"]
              errorCode: 2
      
      -
        object: *client
        name: listDatabaseNames
        expectError: false

    expectEvents:
      - client: "client"
        events:
          - commandStartedEvent:
              commandName: listDatabases
          - commandFailedEvent:
              commandName: listDatabases
          - commandStartedEvent:
              commandName: listDatabases
          - commandFailedEvent:
              commandName: listDatabases
          - commandStartedEvent:
              commandName: listDatabases
          - commandFailedEvent:
              commandName: listDatabases
          - commandStartedEvent:
              commandName: listDatabases
          - commandSucceededEvent:
              commandName: listDatabases

  -
    description: 'client.createChangeStream retries using operation loop'
    operations:
      -
        object: *utilCollection
        name: deleteMany
        arguments:
          filter: {}

      -
        object: *utilCollection
        name: deleteMany
        arguments:
          documents:
            - { _id: 1, x: 11 }      


      - name: failPoint
        object: testRunner
        arguments:
          client: *failPointClient
          failPoint:
            configureFailPoint: failCommand
            mode: { times: 3 }
            data:
              failCommands: [aggregate]
              errorLabels: ["RetryableError", "SystemOverloadedError"]
              errorCode: 2
      
      -
        object: *client
        name: createChangeStream
        arguments:
          pipeline: []
        saveResultAsEntity: changeStream
        expectError: false

    expectEvents:
      - client: "client"
        events:
          - commandStartedEvent:
              commandName: aggregate
          - commandFailedEvent:
              commandName: aggregate
          - commandStartedEvent:
              commandName: aggregate
          - commandFailedEvent:
              commandName: aggregate
          - commandStartedEvent:
              commandName: aggregate
          - commandFailedEvent:
              commandName: aggregate
          - commandStartedEvent:
              commandName: aggregate
          - commandSucceededEvent:
              commandName: aggregate

  -
    description: 'client.clientBulkWrite retries using operation loop'
    runOnRequirements:
      - minServerVersion: '8.0' # client bulk write added to server in 8.0
    operations:
      -
        object: *utilCollection
        name: deleteMany
        arguments:
          filter: {}

      -
        object: *utilCollection
        name: deleteMany
        arguments:
          documents:
            - { _id: 1, x: 11 }      


      - name: failPoint
        object: testRunner
        arguments:
          client: *failPointClient
          failPoint:
            configureFailPoint: failCommand
            mode: { times: 3 }
            data:
              failCommands: [bulkWrite]
              errorLabels: ["RetryableError", "SystemOverloadedError"]
              errorCode: 2
      
      -
        object: *client
        name: clientBulkWrite
        arguments:
          models:
          - insertOne:
              namespace: retryable-writes-tests.coll
              document: { _id: 8, x: 88 }
        expectError: false

    expectEvents:
      - client: "client"
        events:
          - commandStartedEvent:
              commandName: bulkWrite
          - commandFailedEvent:
              commandName: bulkWrite
          - commandStartedEvent:
              commandName: bulkWrite
          - commandFailedEvent:
              commandName: bulkWrite
          - commandStartedEvent:
              commandName: bulkWrite
          - commandFailedEvent:
              commandName: bulkWrite
          - commandStartedEvent:
              commandName: bulkWrite
          - commandSucceededEvent:
              commandName: bulkWrite

  -
    description: 'database.aggregate retries using operation loop'
    operations:
      -
        object: *utilCollection
        name: deleteMany
        arguments:
          filter: {}

      -
        object: *utilCollection
        name: deleteMany
        arguments:
          documents:
            - { _id: 1, x: 11 }      


      - name: failPoint
        object: testRunner
        arguments:
          client: *failPointClient
          failPoint:
            configureFailPoint: failCommand
            mode: { times: 3 }
            data:
              failCommands: [aggregate]
              errorLabels: ["RetryableError", "SystemOverloadedError"]
              errorCode: 2
      
      -
        object: *database
        name: aggregate
        arguments:
          pipeline: [ { $listLocalSessions: {} }, { $limit: 1 } ]
        expectError: false

    expectEvents:
      - client: "client"
        events:
          - commandStartedEvent:
              commandName: aggregate
          - commandFailedEvent:
              commandName: aggregate
          - commandStartedEvent:
              commandName: aggregate
          - commandFailedEvent:
              commandName: aggregate
          - commandStartedEvent:
              commandName: aggregate
          - commandFailedEvent:
              commandName: aggregate
          - commandStartedEvent:
              commandName: aggregate
          - commandSucceededEvent:
              commandName: aggregate

  -
    description: 'database.listCollections retries using operation loop'
    operations:
      -
        object: *utilCollection
        name: deleteMany
        arguments:
          filter: {}

      -
        object: *utilCollection
        name: deleteMany
        arguments:
          documents:
            - { _id: 1, x: 11 }      


      - name: failPoint
        object: testRunner
        arguments:
          client: *failPointClient
          failPoint:
            configureFailPoint: failCommand
            mode: { times: 3 }
            data:
              failCommands: [listCollections]
              errorLabels: ["RetryableError", "SystemOverloadedError"]
              errorCode: 2
      
      -
        object: *database
        name: listCollections
        arguments:
          filter: {}
        expectError: false

    expectEvents:
      - client: "client"
        events:
          - commandStartedEvent:
              commandName: listCollections
          - commandFailedEvent:
              commandName: listCollections
          - commandStartedEvent:
              commandName: listCollections
          - commandFailedEvent:
              commandName: listCollections
          - commandStartedEvent:
              commandName: listCollections
          - commandFailedEvent:
              commandName: listCollections
          - commandStartedEvent:
              commandName: listCollections
          - commandSucceededEvent:
              commandName: listCollections

  -
    description: 'database.listCollectionNames retries using operation loop'
    operations:
      -
        object: *utilCollection
        name: deleteMany
        arguments:
          filter: {}

      -
        object: *utilCollection
        name: deleteMany
        arguments:
          documents:
            - { _id: 1, x: 11 }      


      - name: failPoint
        object: testRunner
        arguments:
          client: *failPointClient
          failPoint:
            configureFailPoint: failCommand
            mode: { times: 3 }
            data:
              failCommands: [listCollections]
              errorLabels: ["RetryableError", "SystemOverloadedError"]
              errorCode: 2
      
      -
        object: *database
        name: listCollectionNames
        arguments:
          filter: {}
        expectError: false

    expectEvents:
      - client: "client"
        events:
          - commandStartedEvent:
              commandName: listCollections
          - commandFailedEvent:
              commandName: listCollections
          - commandStartedEvent:
              commandName: listCollections
          - commandFailedEvent:
              commandName: listCollections
          - commandStartedEvent:
              commandName: listCollections
          - commandFailedEvent:
              commandName: listCollections
          - commandStartedEvent:
              commandName: listCollections
          - commandSucceededEvent:
              commandName: listCollections

  -
    description: 'database.runCommand retries using operation loop'
    operations:
      -
        object: *utilCollection
        name: deleteMany
        arguments:
          filter: {}

      -
        object: *utilCollection
        name: deleteMany
        arguments:
          documents:
            - { _id: 1, x: 11 }      


      - name: failPoint
        object: testRunner
        arguments:
          client: *failPointClient
          failPoint:
            configureFailPoint: failCommand
            mode: { times: 3 }
            data:
              failCommands: [ping]
              errorLabels: ["RetryableError", "SystemOverloadedError"]
              errorCode: 2
      
      -
        object: *database
        name: runCommand
        arguments:
          command: { ping: 1 }
          commandName: ping
        expectError: false

    expectEvents:
      - client: "client"
        events:
          - commandStartedEvent:
              commandName: ping
          - commandFailedEvent:
              commandName: ping
          - commandStartedEvent:
              commandName: ping
          - commandFailedEvent:
              commandName: ping
          - commandStartedEvent:
              commandName: ping
          - commandFailedEvent:
              commandName: ping
          - commandStartedEvent:
              commandName: ping
          - commandSucceededEvent:
              commandName: ping

  -
    description: 'database.createChangeStream retries using operation loop'
    operations:
      -
        object: *utilCollection
        name: deleteMany
        arguments:
          filter: {}

      -
        object: *utilCollection
        name: deleteMany
        arguments:
          documents:
            - { _id: 1, x: 11 }      


      - name: failPoint
        object: testRunner
        arguments:
          client: *failPointClient
          failPoint:
            configureFailPoint: failCommand
            mode: { times: 3 }
            data:
              failCommands: [aggregate]
              errorLabels: ["RetryableError", "SystemOverloadedError"]
              errorCode: 2
      
      -
        object: *database
        name: createChangeStream
        arguments:
          pipeline: []
        saveResultAsEntity: changeStream
        expectError: false

    expectEvents:
      - client: "client"
        events:
          - commandStartedEvent:
              commandName: aggregate
          - commandFailedEvent:
              commandName: aggregate
          - commandStartedEvent:
              commandName: aggregate
          - commandFailedEvent:
              commandName: aggregate
          - commandStartedEvent:
              commandName: aggregate
          - commandFailedEvent:
              commandName: aggregate
          - commandStartedEvent:
              commandName: aggregate
          - commandSucceededEvent:
              commandName: aggregate

  -
    description: 'collection.aggregate retries using operation loop'
    operations:
      -
        object: *utilCollection
        name: deleteMany
        arguments:
          filter: {}

      -
        object: *utilCollection
        name: deleteMany
        arguments:
          documents:
            - { _id: 1, x: 11 }      


      - name: failPoint
        object: testRunner
        arguments:
          client: *failPointClient
          failPoint:
            configureFailPoint: failCommand
            mode: { times: 3 }
            data:
              failCommands: [aggregate]
              errorLabels: ["RetryableError", "SystemOverloadedError"]
              errorCode: 2
      
      -
        object: *collection
        name: aggregate
        arguments:
          pipeline: []
        expectError: false

    expectEvents:
      - client: "client"
        events:
          - commandStartedEvent:
              commandName: aggregate
          - commandFailedEvent:
              commandName: aggregate
          - commandStartedEvent:
              commandName: aggregate
          - commandFailedEvent:
              commandName: aggregate
          - commandStartedEvent:
              commandName: aggregate
          - commandFailedEvent:
              commandName: aggregate
          - commandStartedEvent:
              commandName: aggregate
          - commandSucceededEvent:
              commandName: aggregate

  -
    description: 'collection.countDocuments retries using operation loop'
    operations:
      -
        object: *utilCollection
        name: deleteMany
        arguments:
          filter: {}

      -
        object: *utilCollection
        name: deleteMany
        arguments:
          documents:
            - { _id: 1, x: 11 }      


      - name: failPoint
        object: testRunner
        arguments:
          client: *failPointClient
          failPoint:
            configureFailPoint: failCommand
            mode: { times: 3 }
            data:
              failCommands: [aggregate]
              errorLabels: ["RetryableError", "SystemOverloadedError"]
              errorCode: 2
      
      -
        object: *collection
        name: countDocuments
        arguments:
          filter: {}
        expectError: false

    expectEvents:
      - client: "client"
        events:
          - commandStartedEvent:
              commandName: aggregate
          - commandFailedEvent:
              commandName: aggregate
          - commandStartedEvent:
              commandName: aggregate
          - commandFailedEvent:
              commandName: aggregate
          - commandStartedEvent:
              commandName: aggregate
          - commandFailedEvent:
              commandName: aggregate
          - commandStartedEvent:
              commandName: aggregate
          - commandSucceededEvent:
              commandName: aggregate

  -
    description: 'collection.estimatedDocumentCount retries using operation loop'
    operations:
      -
        object: *utilCollection
        name: deleteMany
        arguments:
          filter: {}

      -
        object: *utilCollection
        name: deleteMany
        arguments:
          documents:
            - { _id: 1, x: 11 }      


      - name: failPoint
        object: testRunner
        arguments:
          client: *failPointClient
          failPoint:
            configureFailPoint: failCommand
            mode: { times: 3 }
            data:
              failCommands: [count]
              errorLabels: ["RetryableError", "SystemOverloadedError"]
              errorCode: 2
      
      -
        object: *collection
        name: estimatedDocumentCount
        expectError: false

    expectEvents:
      - client: "client"
        events:
          - commandStartedEvent:
              commandName: count
          - commandFailedEvent:
              commandName: count
          - commandStartedEvent:
              commandName: count
          - commandFailedEvent:
              commandName: count
          - commandStartedEvent:
              commandName: count
          - commandFailedEvent:
              commandName: count
          - commandStartedEvent:
              commandName: count
          - commandSucceededEvent:
              commandName: count

  -
    description: 'collection.distinct retries using operation loop'
    operations:
      -
        object: *utilCollection
        name: deleteMany
        arguments:
          filter: {}

      -
        object: *utilCollection
        name: deleteMany
        arguments:
          documents:
            - { _id: 1, x: 11 }      


      - name: failPoint
        object: testRunner
        arguments:
          client: *failPointClient
          failPoint:
            configureFailPoint: failCommand
            mode: { times: 3 }
            data:
              failCommands: [distinct]
              errorLabels: ["RetryableError", "SystemOverloadedError"]
              errorCode: 2
      
      -
        object: *collection
        name: distinct
        arguments:
          fieldName: x
          filter: {}
        expectError: false

    expectEvents:
      - client: "client"
        events:
          - commandStartedEvent:
              commandName: distinct
          - commandFailedEvent:
              commandName: distinct
          - commandStartedEvent:
              commandName: distinct
          - commandFailedEvent:
              commandName: distinct
          - commandStartedEvent:
              commandName: distinct
          - commandFailedEvent:
              commandName: distinct
          - commandStartedEvent:
              commandName: distinct
          - commandSucceededEvent:
              commandName: distinct

  -
    description: 'collection.find retries using operation loop'
    operations:
      -
        object: *utilCollection
        name: deleteMany
        arguments:
          filter: {}

      -
        object: *utilCollection
        name: deleteMany
        arguments:
          documents:
            - { _id: 1, x: 11 }      


      - name: failPoint
        object: testRunner
        arguments:
          client: *failPointClient
          failPoint:
            configureFailPoint: failCommand
            mode: { times: 3 }
            data:
              failCommands: [find]
              errorLabels: ["RetryableError", "SystemOverloadedError"]
              errorCode: 2
      
      -
        object: *collection
        name: find
        arguments:
          filter: {}
        expectError: false

    expectEvents:
      - client: "client"
        events:
          - commandStartedEvent:
              commandName: find
          - commandFailedEvent:
              commandName: find
          - commandStartedEvent:
              commandName: find
          - commandFailedEvent:
              commandName: find
          - commandStartedEvent:
              commandName: find
          - commandFailedEvent:
              commandName: find
          - commandStartedEvent:
              commandName: find
          - commandSucceededEvent:
              commandName: find

  -
    description: 'collection.findOne retries using operation loop'
    operations:
      -
        object: *utilCollection
        name: deleteMany
        arguments:
          filter: {}

      -
        object: *utilCollection
        name: deleteMany
        arguments:
          documents:
            - { _id: 1, x: 11 }      


      - name: failPoint
        object: testRunner
        arguments:
          client: *failPointClient
          failPoint:
            configureFailPoint: failCommand
            mode: { times: 3 }
            data:
              failCommands: [find]
              errorLabels: ["RetryableError", "SystemOverloadedError"]
              errorCode: 2
      
      -
        object: *collection
        name: findOne
        arguments:
          filter: {}
        expectError: false

    expectEvents:
      - client: "client"
        events:
          - commandStartedEvent:
              commandName: find
          - commandFailedEvent:
              commandName: find
          - commandStartedEvent:
              commandName: find
          - commandFailedEvent:
              commandName: find
          - commandStartedEvent:
              commandName: find
          - commandFailedEvent:
              commandName: find
          - commandStartedEvent:
              commandName: find
          - commandSucceededEvent:
              commandName: find

  -
    description: 'collection.listIndexes retries using operation loop'
    operations:
      -
        object: *utilCollection
        name: deleteMany
        arguments:
          filter: {}

      -
        object: *utilCollection
        name: deleteMany
        arguments:
          documents:
            - { _id: 1, x: 11 }      


      - name: failPoint
        object: testRunner
        arguments:
          client: *failPointClient
          failPoint:
            configureFailPoint: failCommand
            mode: { times: 3 }
            data:
              failCommands: [listIndexes]
              errorLabels: ["RetryableError", "SystemOverloadedError"]
              errorCode: 2
      
      -
        object: *collection
        name: listIndexes
        expectError: false

    expectEvents:
      - client: "client"
        events:
          - commandStartedEvent:
              commandName: listIndexes
          - commandFailedEvent:
              commandName: listIndexes
          - commandStartedEvent:
              commandName: listIndexes
          - commandFailedEvent:
              commandName: listIndexes
          - commandStartedEvent:
              commandName: listIndexes
          - commandFailedEvent:
              commandName: listIndexes
          - commandStartedEvent:
              commandName: listIndexes
          - commandSucceededEvent:
              commandName: listIndexes

  -
    description: 'collection.listIndexNames retries using operation loop'
    operations:
      -
        object: *utilCollection
        name: deleteMany
        arguments:
          filter: {}

      -
        object: *utilCollection
        name: deleteMany
        arguments:
          documents:
            - { _id: 1, x: 11 }      


      - name: failPoint
        object: testRunner
        arguments:
          client: *failPointClient
          failPoint:
            configureFailPoint: failCommand
            mode: { times: 3 }
            data:
              failCommands: [listIndexes]
              errorLabels: ["RetryableError", "SystemOverloadedError"]
              errorCode: 2
      
      -
        object: *collection
        name: listIndexNames
        expectError: false

    expectEvents:
      - client: "client"
        events:
          - commandStartedEvent:
              commandName: listIndexes
          - commandFailedEvent:
              commandName: listIndexes
          - commandStartedEvent:
              commandName: listIndexes
          - commandFailedEvent:
              commandName: listIndexes
          - commandStartedEvent:
              commandName: listIndexes
          - commandFailedEvent:
              commandName: listIndexes
          - commandStartedEvent:
              commandName: listIndexes
          - commandSucceededEvent:
              commandName: listIndexes

  -
    description: 'collection.createChangeStream retries using operation loop'
    operations:
      -
        object: *utilCollection
        name: deleteMany
        arguments:
          filter: {}

      -
        object: *utilCollection
        name: deleteMany
        arguments:
          documents:
            - { _id: 1, x: 11 }      


      - name: failPoint
        object: testRunner
        arguments:
          client: *failPointClient
          failPoint:
            configureFailPoint: failCommand
            mode: { times: 3 }
            data:
              failCommands: [aggregate]
              errorLabels: ["RetryableError", "SystemOverloadedError"]
              errorCode: 2
      
      -
        object: *collection
        name: createChangeStream
        arguments:
          pipeline: []
        saveResultAsEntity: changeStream
        expectError: false

    expectEvents:
      - client: "client"
        events:
          - commandStartedEvent:
              commandName: aggregate
          - commandFailedEvent:
              commandName: aggregate
          - commandStartedEvent:
              commandName: aggregate
          - commandFailedEvent:
              commandName: aggregate
          - commandStartedEvent:
              commandName: aggregate
          - commandFailedEvent:
              commandName: aggregate
          - commandStartedEvent:
              commandName: aggregate
          - commandSucceededEvent:
              commandName: aggregate

  -
    description: 'collection.insertOne retries using operation loop'
    operations:
      -
        object: *utilCollection
        name: deleteMany
        arguments:
          filter: {}

      -
        object: *utilCollection
        name: deleteMany
        arguments:
          documents:
            - { _id: 1, x: 11 }      


      - name: failPoint
        object: testRunner
        arguments:
          client: *failPointClient
          failPoint:
            configureFailPoint: failCommand
            mode: { times: 3 }
            data:
              failCommands: [insert]
              errorLabels: ["RetryableError", "SystemOverloadedError"]
              errorCode: 2
      
      -
        object: *collection
        name: insertOne
        arguments:
          document: { _id: 2, x: 22 }
        expectError: false

    expectEvents:
      - client: "client"
        events:
          - commandStartedEvent:
              commandName: insert
          - commandFailedEvent:
              commandName: insert
          - commandStartedEvent:
              commandName: insert
          - commandFailedEvent:
              commandName: insert
          - commandStartedEvent:
              commandName: insert
          - commandFailedEvent:
              commandName: insert
          - commandStartedEvent:
              commandName: insert
          - commandSucceededEvent:
              commandName: insert

  -
    description: 'collection.insertMany retries using operation loop'
    operations:
      -
        object: *utilCollection
        name: deleteMany
        arguments:
          filter: {}

      -
        object: *utilCollection
        name: deleteMany
        arguments:
          documents:
            - { _id: 1, x: 11 }      


      - name: failPoint
        object: testRunner
        arguments:
          client: *failPointClient
          failPoint:
            configureFailPoint: failCommand
            mode: { times: 3 }
            data:
              failCommands: [insert]
              errorLabels: ["RetryableError", "SystemOverloadedError"]
              errorCode: 2
      
      -
        object: *collection
        name: insertMany
        arguments:
          documents:
            - { _id: 2, x: 22 }
        expectError: false

    expectEvents:
      - client: "client"
        events:
          - commandStartedEvent:
              commandName: insert
          - commandFailedEvent:
              commandName: insert
          - commandStartedEvent:
              commandName: insert
          - commandFailedEvent:
              commandName: insert
          - commandStartedEvent:
              commandName: insert
          - commandFailedEvent:
              commandName: insert
          - commandStartedEvent:
              commandName: insert
          - commandSucceededEvent:
              commandName: insert

  -
    description: 'collection.deleteOne retries using operation loop'
    operations:
      -
        object: *utilCollection
        name: deleteMany
        arguments:
          filter: {}

      -
        object: *utilCollection
        name: deleteMany
        arguments:
          documents:
            - { _id: 1, x: 11 }      


      - name: failPoint
        object: testRunner
        arguments:
          client: *failPointClient
          failPoint:
            configureFailPoint: failCommand
            mode: { times: 3 }
            data:
              failCommands: [delete]
              errorLabels: ["RetryableError", "SystemOverloadedError"]
              errorCode: 2
      
      -
        object: *collection
        name: deleteOne
        arguments:
          filter: {}
        expectError: false

    expectEvents:
      - client: "client"
        events:
          - commandStartedEvent:
              commandName: delete
          - commandFailedEvent:
              commandName: delete
          - commandStartedEvent:
              commandName: delete
          - commandFailedEvent:
              commandName: delete
          - commandStartedEvent:
              commandName: delete
          - commandFailedEvent:
              commandName: delete
          - commandStartedEvent:
              commandName: delete
          - commandSucceededEvent:
              commandName: delete

  -
    description: 'collection.deleteMany retries using operation loop'
    operations:
      -
        object: *utilCollection
        name: deleteMany
        arguments:
          filter: {}

      -
        object: *utilCollection
        name: deleteMany
        arguments:
          documents:
            - { _id: 1, x: 11 }      


      - name: failPoint
        object: testRunner
        arguments:
          client: *failPointClient
          failPoint:
            configureFailPoint: failCommand
            mode: { times: 3 }
            data:
              failCommands: [delete]
              errorLabels: ["RetryableError", "SystemOverloadedError"]
              errorCode: 2
      
      -
        object: *collection
        name: deleteMany
        arguments:
          filter: {}
        expectError: false

    expectEvents:
      - client: "client"
        events:
          - commandStartedEvent:
              commandName: delete
          - commandFailedEvent:
              commandName: delete
          - commandStartedEvent:
              commandName: delete
          - commandFailedEvent:
              commandName: delete
          - commandStartedEvent:
              commandName: delete
          - commandFailedEvent:
              commandName: delete
          - commandStartedEvent:
              commandName: delete
          - commandSucceededEvent:
              commandName: delete

  -
    description: 'collection.replaceOne retries using operation loop'
    operations:
      -
        object: *utilCollection
        name: deleteMany
        arguments:
          filter: {}

      -
        object: *utilCollection
        name: deleteMany
        arguments:
          documents:
            - { _id: 1, x: 11 }      


      - name: failPoint
        object: testRunner
        arguments:
          client: *failPointClient
          failPoint:
            configureFailPoint: failCommand
            mode: { times: 3 }
            data:
              failCommands: [update]
              errorLabels: ["RetryableError", "SystemOverloadedError"]
              errorCode: 2
      
      -
        object: *collection
        name: replaceOne
        arguments:
          filter: {}
          replacement: { x: 22 }
        expectError: false

    expectEvents:
      - client: "client"
        events:
          - commandStartedEvent:
              commandName: update
          - commandFailedEvent:
              commandName: update
          - commandStartedEvent:
              commandName: update
          - commandFailedEvent:
              commandName: update
          - commandStartedEvent:
              commandName: update
          - commandFailedEvent:
              commandName: update
          - commandStartedEvent:
              commandName: update
          - commandSucceededEvent:
              commandName: update

  -
    description: 'collection.updateOne retries using operation loop'
    operations:
      -
        object: *utilCollection
        name: deleteMany
        arguments:
          filter: {}

      -
        object: *utilCollection
        name: deleteMany
        arguments:
          documents:
            - { _id: 1, x: 11 }      


      - name: failPoint
        object: testRunner
        arguments:
          client: *failPointClient
          failPoint:
            configureFailPoint: failCommand
            mode: { times: 3 }
            data:
              failCommands: [update]
              errorLabels: ["RetryableError", "SystemOverloadedError"]
              errorCode: 2
      
      -
        object: *collection
        name: updateOne
        arguments:
          filter: {}
          update: { $set: { x: 22 } }
        expectError: false

    expectEvents:
      - client: "client"
        events:
          - commandStartedEvent:
              commandName: update
          - commandFailedEvent:
              commandName: update
          - commandStartedEvent:
              commandName: update
          - commandFailedEvent:
              commandName: update
          - commandStartedEvent:
              commandName: update
          - commandFailedEvent:
              commandName: update
          - commandStartedEvent:
              commandName: update
          - commandSucceededEvent:
              commandName: update

  -
    description: 'collection.updateMany retries using operation loop'
    operations:
      -
        object: *utilCollection
        name: deleteMany
        arguments:
          filter: {}

      -
        object: *utilCollection
        name: deleteMany
        arguments:
          documents:
            - { _id: 1, x: 11 }      


      - name: failPoint
        object: testRunner
        arguments:
          client: *failPointClient
          failPoint:
            configureFailPoint: failCommand
            mode: { times: 3 }
            data:
              failCommands: [update]
              errorLabels: ["RetryableError", "SystemOverloadedError"]
              errorCode: 2
      
      -
        object: *collection
        name: updateMany
        arguments:
          filter: {}
          update: { $set: { x: 22 } }
        expectError: false

    expectEvents:
      - client: "client"
        events:
          - commandStartedEvent:
              commandName: update
          - commandFailedEvent:
              commandName: update
          - commandStartedEvent:
              commandName: update
          - commandFailedEvent:
              commandName: update
          - commandStartedEvent:
              commandName: update
          - commandFailedEvent:
              commandName: update
          - commandStartedEvent:
              commandName: update
          - commandSucceededEvent:
              commandName: update

  -
    description: 'collection.findOneAndDelete retries using operation loop'
    operations:
      -
        object: *utilCollection
        name: deleteMany
        arguments:
          filter: {}

      -
        object: *utilCollection
        name: deleteMany
        arguments:
          documents:
            - { _id: 1, x: 11 }      


      - name: failPoint
        object: testRunner
        arguments:
          client: *failPointClient
          failPoint:
            configureFailPoint: failCommand
            mode: { times: 3 }
            data:
              failCommands: [findAndModify]
              errorLabels: ["RetryableError", "SystemOverloadedError"]
              errorCode: 2
      
      -
        object: *collection
        name: findOneAndDelete
        arguments:
          filter: {}
        expectError: false

    expectEvents:
      - client: "client"
        events:
          - commandStartedEvent:
              commandName: findAndModify
          - commandFailedEvent:
              commandName: findAndModify
          - commandStartedEvent:
              commandName: findAndModify
          - commandFailedEvent:
              commandName: findAndModify
          - commandStartedEvent:
              commandName: findAndModify
          - commandFailedEvent:
              commandName: findAndModify
          - commandStartedEvent:
              commandName: findAndModify
          - commandSucceededEvent:
              commandName: findAndModify

  -
    description: 'collection.findOneAndReplace retries using operation loop'
    operations:
      -
        object: *utilCollection
        name: deleteMany
        arguments:
          filter: {}

      -
        object: *utilCollection
        name: deleteMany
        arguments:
          documents:
            - { _id: 1, x: 11 }      


      - name: failPoint
        object: testRunner
        arguments:
          client: *failPointClient
          failPoint:
            configureFailPoint: failCommand
            mode: { times: 3 }
            data:
              failCommands: [findAndModify]
              errorLabels: ["RetryableError", "SystemOverloadedError"]
              errorCode: 2
      
      -
        object: *collection
        name: findOneAndReplace
        arguments:
          filter: {}
          replacement: { x: 22 }
        expectError: false

    expectEvents:
      - client: "client"
        events:
          - commandStartedEvent:
              commandName: findAndModify
          - commandFailedEvent:
              commandName: findAndModify
          - commandStartedEvent:
              commandName: findAndModify
          - commandFailedEvent:
              commandName: findAndModify
          - commandStartedEvent:
              commandName: findAndModify
          - commandFailedEvent:
              commandName: findAndModify
          - commandStartedEvent:
              commandName: findAndModify
          - commandSucceededEvent:
              commandName: findAndModify

  -
    description: 'collection.findOneAndUpdate retries using operation loop'
    operations:
      -
        object: *utilCollection
        name: deleteMany
        arguments:
          filter: {}

      -
        object: *utilCollection
        name: deleteMany
        arguments:
          documents:
            - { _id: 1, x: 11 }      


      - name: failPoint
        object: testRunner
        arguments:
          client: *failPointClient
          failPoint:
            configureFailPoint: failCommand
            mode: { times: 3 }
            data:
              failCommands: [findAndModify]
              errorLabels: ["RetryableError", "SystemOverloadedError"]
              errorCode: 2
      
      -
        object: *collection
        name: findOneAndUpdate
        arguments:
          filter: {}
          update: { $set: { x: 22 } }
        expectError: false

    expectEvents:
      - client: "client"
        events:
          - commandStartedEvent:
              commandName: findAndModify
          - commandFailedEvent:
              commandName: findAndModify
          - commandStartedEvent:
              commandName: findAndModify
          - commandFailedEvent:
              commandName: findAndModify
          - commandStartedEvent:
              commandName: findAndModify
          - commandFailedEvent:
              commandName: findAndModify
          - commandStartedEvent:
              commandName: findAndModify
          - commandSucceededEvent:
              commandName: findAndModify

  -
    description: 'collection.bulkWrite retries using operation loop'
    operations:
      -
        object: *utilCollection
        name: deleteMany
        arguments:
          filter: {}

      -
        object: *utilCollection
        name: deleteMany
        arguments:
          documents:
            - { _id: 1, x: 11 }      


      - name: failPoint
        object: testRunner
        arguments:
          client: *failPointClient
          failPoint:
            configureFailPoint: failCommand
            mode: { times: 3 }
            data:
              failCommands: [insert]
              errorLabels: ["RetryableError", "SystemOverloadedError"]
              errorCode: 2
      
      -
        object: *collection
        name: bulkWrite
        arguments:
          requests:
            - insertOne:
                document: { _id: 2, x: 22 }
        expectError: false

    expectEvents:
      - client: "client"
        events:
          - commandStartedEvent:
              commandName: insert
          - commandFailedEvent:
              commandName: insert
          - commandStartedEvent:
              commandName: insert
          - commandFailedEvent:
              commandName: insert
          - commandStartedEvent:
              commandName: insert
          - commandFailedEvent:
              commandName: insert
          - commandStartedEvent:
              commandName: insert
          - commandSucceededEvent:
              commandName: insert

  -
    description: 'collection.createIndex retries using operation loop'
    operations:
      -
        object: *utilCollection
        name: deleteMany
        arguments:
          filter: {}

      -
        object: *utilCollection
        name: deleteMany
        arguments:
          documents:
            - { _id: 1, x: 11 }      


      - name: failPoint
        object: testRunner
        arguments:
          client: *failPointClient
          failPoint:
            configureFailPoint: failCommand
            mode: { times: 3 }
            data:
              failCommands: [createIndexes]
              errorLabels: ["RetryableError", "SystemOverloadedError"]
              errorCode: 2
      
      -
        object: *collection
        name: createIndex
        arguments:
          keys: { x: 11 }
          name: "x_11"
        expectError: false

    expectEvents:
      - client: "client"
        events:
          - commandStartedEvent:
              commandName: createIndexes
          - commandFailedEvent:
              commandName: createIndexes
          - commandStartedEvent:
              commandName: createIndexes
          - commandFailedEvent:
              commandName: createIndexes
          - commandStartedEvent:
              commandName: createIndexes
          - commandFailedEvent:
              commandName: createIndexes
          - commandStartedEvent:
              commandName: createIndexes
          - commandSucceededEvent:
              commandName: createIndexes

  -
    description: 'collection.dropIndex retries using operation loop'
    operations:
      -
        object: *utilCollection
        name: deleteMany
        arguments:
          filter: {}

      -
        object: *utilCollection
        name: deleteMany
        arguments:
          documents:
            - { _id: 1, x: 11 }
      -
        object: *utilCollection
        name: createIndex
        arguments:
          keys: { x: 11 }
          name: "x_11"      


      - name: failPoint
        object: testRunner
        arguments:
          client: *failPointClient
          failPoint:
            configureFailPoint: failCommand
            mode: { times: 3 }
            data:
              failCommands: [dropIndexes]
              errorLabels: ["RetryableError", "SystemOverloadedError"]
              errorCode: 2
      
      -
        object: *collection
        name: dropIndex
        arguments:
          name: "x_11"
        expectError: false

    expectEvents:
      - client: "client"
        events:
          - commandStartedEvent:
              commandName: dropIndexes
          - commandFailedEvent:
              commandName: dropIndexes
          - commandStartedEvent:
              commandName: dropIndexes
          - commandFailedEvent:
              commandName: dropIndexes
          - commandStartedEvent:
              commandName: dropIndexes
          - commandFailedEvent:
              commandName: dropIndexes
          - commandStartedEvent:
              commandName: dropIndexes
          - commandSucceededEvent:
              commandName: dropIndexes

  -
    description: 'collection.dropIndexes retries using operation loop'
    operations:
      -
        object: *utilCollection
        name: deleteMany
        arguments:
          filter: {}

      -
        object: *utilCollection
        name: deleteMany
        arguments:
          documents:
            - { _id: 1, x: 11 }      


      - name: failPoint
        object: testRunner
        arguments:
          client: *failPointClient
          failPoint:
            configureFailPoint: failCommand
            mode: { times: 3 }
            data:
              failCommands: [dropIndexes]
              errorLabels: ["RetryableError", "SystemOverloadedError"]
              errorCode: 2
      
      -
        object: *collection
        name: dropIndexes
        expectError: false

    expectEvents:
      - client: "client"
        events:
          - commandStartedEvent:
              commandName: dropIndexes
          - commandFailedEvent:
              commandName: dropIndexes
          - commandStartedEvent:
              commandName: dropIndexes
          - commandFailedEvent:
              commandName: dropIndexes
          - commandStartedEvent:
              commandName: dropIndexes
          - commandFailedEvent:
              commandName: dropIndexes
          - commandStartedEvent:
              commandName: dropIndexes
          - commandSucceededEvent:
              commandName: dropIndexes
