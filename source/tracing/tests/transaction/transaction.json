{
  "description" : "transaction spans",
  "schemaVersion" : "1.9",
  "runOnRequirements": [
    {
      "minServerVersion": "4.0",
      "topologies": [
        "replicaset"
      ]
    },
    {
      "minServerVersion": "4.1.8",
      "topologies": [
        "sharded",
        "load-balanced"
      ]
    }
  ],
  "createEntities" : [
    {
      "client" : {
        "id" : "client0",
        "useMultipleMongoses" : false,
        "tracing" : {
          "enableCommandPayload" : true
        }
      }
    },
    {
      "database" : {
        "id" : "database0",
        "client" : "client0",
        "databaseName" : "transaction-tests"
      }
    },
    {
      "collection" : {
        "id" : "collection0",
        "database" : "database0",
        "collectionName" : "test"
      }
    },
    {
      "session" : {
        "id" : "session0",
        "client" : "client0"
      }
    }
  ],
  "initialData" : [
    {
      "collectionName" : "test",
      "databaseName" : "transaction-tests",
      "documents" : []
    }
  ],
  "tests" : [
    {
      "description" : "tracing around transaction",
      "operations" : [
        {
          "object" : "session0",
          "name" : "startTransaction"
        },
        {
          "object" : "collection0",
          "name" : "insertOne",
          "arguments" : {
            "session" : "session0",
            "document" : {
              "_id" : 1
            }
          }
        },
        {
          "object" : "session0",
          "name" : "commitTransaction"
        },
        {
          "name" : "find",
          "object" : "collection0",
          "arguments" : {
            "filter" : {
              "x" : 1
            }
          }
        }
      ],
      "expectTracingSpans" : {
        "client" : "client0",
        "ignoreExtraSpans" : false,
        "spans" : [
          {
            "name" : "transaction",
            "nested" : [
              {
                "name" : "mixedbulkwriteoperation transaction-tests.test",
                "tags" : {
                  "db.system" : "mongodb",
                  "db.collection.name" : "test",
                  "db.namespace" : "transaction-tests"
                },
                "nested" : [
                  {
                    "name" : "command insert",
                    "tags" : {
                      "db.system" : "mongodb",
                      "db.namespace" : "transaction-tests",
                      "server.address" : {
                        "$$type" : "string"
                      },
                      "server.port" : {
                        "$$type" : [
                          "long",
                          "string"
                        ]
                      },
                      "server.type" : {
                        "$$type" : "string"
                      },
                      "db.query.summary" : {
                        "$$matchAsDocument" : {
                          "$$matchAsRoot" : {
                            "insert" : "test",
                            "ordered" : true
                          }
                        }
                      },
                      "db.query.text" : {
                        "$$matchAsDocument" : {
                          "$$matchAsRoot" : {
                            "insert" : "test",
                            "ordered" : true,
                            "$db" : "transaction-tests",
                            "lsid" : {
                              "$$sessionLsid" : "session0"
                            },
                            "txnNumber" : 1,
                            "startTransaction" : true,
                            "autocommit" : false,
                            "documents" : [
                              {
                                "_id" : 1
                              }
                            ]
                          }
                        }
                      },
                      "db.mongodb.lsid" : {
                        "$$sessionLsid" : "session0"
                      }
                    }
                  }
                ]
              },
              {
                "name" : "commitTransaction",
                "nested" : [
                  {
                    "name" : "command commitTransaction",
                    "tags" : {
                      "db.system" : "mongodb"
                    }
                  }
                ]
              }
            ]
          },
          {
            "name" : "find transaction-tests.test",
            "tags" : {
            },
            "nested" : [
              {
                "name" : "command find",
                "tags" : {
                  "db.system" : "mongodb",
                  "db.namespace" : "transaction-tests",
                  "server.address" : {
                    "$$type" : "string"
                  },
                  "server.port" : {
                    "$$type" : [
                      "long",
                      "string"
                    ]
                  },
                  "server.type" : {
                    "$$type" : "string"
                  },
                  "db.query.summary" : {
                    "$$matchAsDocument" : {
                      "$$matchAsRoot" : {
                        "find" : "test",
                        "filter" : {
                          "x" : 1
                        }
                      }
                    }
                  }
                }
              }
            ]
          }
        ]
      },
      "outcome" : [
        {
          "collectionName" : "test",
          "databaseName" : "transaction-tests",
          "documents" : [
            {
              "_id" : 1
            }
          ]
        }
      ]
    }
  ]
}
