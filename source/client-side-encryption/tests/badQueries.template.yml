runOn:
  - minServerVersion: "4.1.10"
database_name: &database_name "default"
collection_name: &collection_name "default"

data:
  - &doc0_encrypted { _id: 1, ssn: {{ciphertext("457-55-5462", field="ssn")}} }
  - &doc1_encrypted { _id: 2, ssn: {{ciphertext("123-45-6789", field="ssn")}} }
json_schema: {{schema()}}
key_vault_data: [{{key()}}]

tests:
  - description: "$expr unconditionally fails"
    clientOptions:
      auto_encrypt_opts:
        kms_providers:
          aws: {} # Credentials filled in from environment.
    operations:
      - name: find
        arguments:
          filter:
            { $expr: { $eq: [1, 1] } }
        result:
          errorContains: "Unsupported match expression operator for encryption"
  - description: "$text unconditionally fails"
    clientOptions:
      auto_encrypt_opts:
        kms_providers:
          aws: {} # Credentials filled in from environment.
    operations:
      - name: find
        arguments:
          filter:
            { $text: { $search: "search text" } }
        result:
          errorContains: "Unsupported match expression operator for encryption"
  - description: "$where unconditionally fails"
    clientOptions:
      auto_encrypt_opts:
        kms_providers:
          aws: {} # Credentials filled in from environment.
    operations:
      - name: find
        arguments:
          filter:
            { $where: { $code: "function() { return true }" } }
        result:
          errorContains: "Unsupported match expression operator for encryption"
  - description: "$jsonSchema unconditionally fails"
    skipReason: "SERVER-41012"
    clientOptions:
      auto_encrypt_opts:
        kms_providers:
          aws: {} # Credentials filled in from environment.
    operations:
      - name: find
        arguments:
          filter:
            { $jsonSchema: { properties: {} } }
        result:
          errorContains: "Unsupported match expression operator for encryption"