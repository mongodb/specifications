runOn:
  - minServerVersion: "4.1.10"
database_name: &database_name "default"
collection_name: &collection_name "default"

data:
  - &doc0_encrypted { _id: 1, ssn: {{ciphertext("457-55-5462", field="ssn")}} }
  - &doc1_encrypted { _id: 2, ssn: {{ciphertext("123-45-6789", field="ssn")}} }
json_schema: {{schema()}}
key_vault_data: [{{key()}}]

# TODO: I could see an argument against having these tests of mongocryptd as part
# of driver tests. When mongocryptd introduces support for these operators, these
# tests will fail. But it's also easy enough to remove these tests when that happens.

tests:
  - description: "$expr unconditionally fails"
    clientOptions:
      auto_encrypt_opts:
        kms_providers:
          aws: {} # Credentials filled in from environment.
    operations:
      - name: find
        arguments:
          filter:
            { $expr: { $eq: [1, 1] } }
        result:
          errorContains: "Unsupported match expression operator for encryption"
  - description: "$text unconditionally fails"
    clientOptions:
      auto_encrypt_opts:
        kms_providers:
          aws: {} # Credentials filled in from environment.
    operations:
      - name: find
        arguments:
          filter:
            { $text: { $search: "search text" } }
        result:
          errorContains: "Unsupported match expression operator for encryption"
  - description: "$where unconditionally fails"
    clientOptions:
      auto_encrypt_opts:
        kms_providers:
          aws: {} # Credentials filled in from environment.
    operations:
      - name: find
        arguments:
          filter:
            { $where: { $code: "function() { return true }" } }
        result:
          errorContains: "Unsupported match expression operator for encryption"
  - description: "$jsonSchema unconditionally fails"
    skipReason: "SERVER-41012"
    clientOptions:
      auto_encrypt_opts:
        kms_providers:
          aws: {} # Credentials filled in from environment.
    operations:
      - name: find
        arguments:
          filter:
            { $jsonSchema: { properties: {} } }
        result:
          errorContains: "Unsupported match expression operator for encryption"
  - description: "$bit operators succeed on unencrypted, error on encrypted"
    clientOptions:
      auto_encrypt_opts:
        kms_providers:
          aws: {} # Credentials filled in from environment.
    operations:
      - name: find
        arguments:
          filter: { unencrypted: { $bitsAllClear: 35 }}
        result: []
      - name: find
        arguments:
          filter: { ssn: { $bitsAllClear: 35 }}
        result:
          errorContains: "Invalid match expression operator on encrypted field"
      - name: find
        arguments:
          filter: { unencrypted: { $bitsAllSet: 35 }}
        result: []
      - name: find
        arguments:
          filter: { ssn: { $bitsAllSet: 35 }}
        result:
          errorContains: "Invalid match expression operator on encrypted field"
      - name: find
        arguments:
          filter: { unencrypted: { $bitsAnyClear: 35 }}
        result: []
      - name: find
        arguments:
          filter: { ssn: { $bitsAnyClear: 35 }}
        result:
          errorContains: "Invalid match expression operator on encrypted field"
      - name: find
        arguments:
          filter: { unencrypted: { $bitsAnySet: 35 }}
        result: []
      - name: find
        arguments:
          filter: { ssn: { $bitsAnySet: 35 }}
        result:
          errorContains: "Invalid match expression operator on encrypted field"
  - description: "geo operators succeed on unencrypted, error on encrypted"
    clientOptions:
      auto_encrypt_opts:
        kms_providers:
          aws: {} # Credentials filled in from environment.
    operations:
      - name: find
        arguments:
          filter: { unencrypted: { $near: [0,0] }}
        result:
          # Still an error because no geo index, but from mongod - not mongocryptd.
          errorContains: "unable to find index"
      - name: find
        arguments:
          filter: { ssn: { $near: [0,0] }}
        result:
          errorContains: "Invalid match expression operator on encrypted field"
      - name: find
        arguments:
          filter: { unencrypted: { $nearSphere: [0,0] }}
        result:
          # Still an error because no geo index, but from mongod - not mongocryptd.
          errorContains: "unable to find index"
      - name: find
        arguments:
          filter: { ssn: { $nearSphere: [0,0] }}
        result:
          errorContains: "Invalid match expression operator on encrypted field"
      - name: find
        arguments:
          filter: { unencrypted: { $geoIntersects: { $geometry: { type: "Polygon", coordinates: [[ [0,0], [1,0], [1,1], [0,0] ]] }} }}
        result: []
      - name: find
        arguments:
          filter: { ssn: { $geoIntersects: { $geometry: { type: "Polygon", coordinates: [[ [0,0], [1,0], [1,1], [0,0] ]] }} }}
        result:
          errorContains: "Invalid match expression operator on encrypted field"
      - name: find
        arguments:
          filter: { unencrypted: { $geoWithin: { $geometry: { type: "Polygon", coordinates: [[ [0,0], [1,0], [1,1], [0,0] ]] }} }}
        result: []
      - name: find
        arguments:
          filter: { ssn: { $geoWithin: { $geometry: { type: "Polygon", coordinates: [[ [0,0], [1,0], [1,1], [0,0] ]] }} }}
        result:
          errorContains: "Invalid match expression operator on encrypted field"
  - description: "inequality operators succeed on unencrypted, error on encrypted"
    clientOptions:
      auto_encrypt_opts:
        kms_providers:
          aws: {} # Credentials filled in from environment.
    operations:
      - name: find
        arguments:
          filter: { unencrypted: { $gt: 1 }}
        result: []
      - name: find
        arguments:
          filter: { ssn: { $gt: 1 }}
        result:
          errorContains: "Invalid match expression operator on encrypted field"
      - name: find
        arguments:
          filter: { unencrypted: { $lt: 1 }}
        result: []
      - name: find
        arguments:
          filter: { ssn: { $lt: 1 }}
        result:
          errorContains: "Invalid match expression operator on encrypted field"
      - name: find
        arguments:
          filter: { unencrypted: { $gte: 1 }}
        result: []
      - name: find
        arguments:
          filter: { ssn: { $gte: 1 }}
        result:
          errorContains: "Invalid match expression operator on encrypted field"
      - name: find
        arguments:
          filter: { unencrypted: { $lte: 1 }}
        result: []
      - name: find
        arguments:
          filter: { ssn: { $lte: 1 }}
        result:
          errorContains: "Invalid match expression operator on encrypted field"
  - description: "other misc operators succeed on unencrypted, error on encrypted"
    clientOptions:
      auto_encrypt_opts:
        kms_providers:
          aws: {} # Credentials filled in from environment.
    operations:
      - name: find
        arguments:
          filter: { unencrypted: { $mod: [3, 1] }}
        result: []
      - name: find
        arguments:
          filter: { ssn: { $mod: [3, 1] }}
        result:
          errorContains: "Invalid match expression operator on encrypted field"
      - name: find
        arguments:
          filter: { unencrypted: { $regex: "pattern", $options: "" }}
        result: []
      - name: find
        arguments:
          filter: { ssn: { $regex: "pattern", $options: "" }}
        result:
          errorContains: "Invalid match expression operator on encrypted field"
      - name: find
        arguments:
          filter: { unencrypted: { $size: 2 }}
        result: []
      - name: find
        arguments:
          filter: { ssn: { $size: 2 }}
        result:
          errorContains: "Invalid match expression operator on encrypted field"
      - name: find
        arguments:
          filter: { unencrypted: { $type: 2 }}
        result: []
      - name: find
        arguments:
          filter: { ssn: { $type: 2 }}
        result:
          errorContains: "Invalid match expression operator on encrypted field"
      - name: find
        arguments:
          filter: { unencrypted: { $eq: null }}
        result:
          - &doc0 { _id: 1, ssn: "457-55-5462" }
          - &doc1 { _id: 2, ssn: "123-45-6789" }
      - name: find
        arguments:
          filter: { ssn: { $eq: null }}
        result:
          errorContains: "Illegal equality to null predicate for encrypted field"
      - name: find
        arguments:
          filter: { unencrypted: { $in: [null] }}
        result:
          - *doc0
          - *doc1
      - name: find
        arguments:
          filter: { ssn: { $in: [null] }}
        result:
          errorContains: "Illegal equality to null inside $in against an encrypted field"