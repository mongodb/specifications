description: runCommand spec requirements

schemaVersion: "1.0"

runOnRequirements: {}

createEntities:
  - client:
      id: &client client
      observeEvents: [commandStartedEvent]
  - database:
      id: plainDb
      client: *client
      databaseName: plainDb
  - database:
      id: dbWithRC
      client: *client
      databaseName: dbWithRC
      readConcern:
        level: 'local'
  - database:
      id: dbWithWC
      client: *client
      databaseName: dbWithWC
      writeConcern:
        w: 0
  - session:
      id: &session0 session0
      client: *client

tests:
  - description: executes a ping with $db attached
    operations:
      - name: runCommand
        object: plainDb
        arguments:
          commandName: ping
          command:
            ping: 1
        expectResult:
          ok: 1
    expectEvents:
      - client: *client
        events:
        - commandStartedEvent:
              command:
                ping: 1
                $db: plainDb
              commandName: ping

  - description: executes a ping with lsid attached
    operations:
      - name: runCommand
        object: plainDb
        arguments:
          commandName: ping
          command:
            ping: 1
          session: *session0
        expectResult:
          ok: 1
    expectEvents:
      - client: *client
        events:
        - commandStartedEvent:
              command:
                ping: 1
                lsid: { $$sessionLsid: *session0 }
                $db: plainDb
              commandName: ping

  - description: executes a ping with $readPreference attached
    operations:
      - name: runCommand
        object: plainDb
        arguments:
          commandName: ping
          command:
            ping: 1
          readPreference: 'nearest'
        expectResult:
          ok: 1
    expectEvents:
      - client: *client
        events:
        - commandStartedEvent:
              command:
                ping: 1
                $readPreference: { mode: 'nearest' }
                $db: plainDb
              commandName: ping

  - description: executes a ping without attaching readConcern
    operations:
      - name: runCommand
        object: dbWithRC
        arguments:
          commandName: ping
          command:
            ping: 1
        expectResult:
          ok: 1
    expectEvents:
      - client: *client
        events:
        - commandStartedEvent:
              command:
                ping: 1
                readConcern: { $$exists: false }
                $db: dbWithRC
              commandName: ping

  - description: executes a ping without attaching writeConcern
    operations:
      - name: runCommand
        object: dbWithWC
        arguments:
          commandName: ping
          command:
            ping: 1
        expectResult:
          ok: 1
    expectEvents:
      - client: *client
        events:
        - commandStartedEvent:
              command:
                ping: 1
                writeConcern: { $$exists: false }
                $db: dbWithWC
              commandName: ping

  - description: executes a ping and does not retry retryable error
    operations:
      - name: failPoint
        object: testRunner
        arguments:
          client: *client
          failPoint:
            configureFailPoint: failCommand
            mode: { times: 1 }
            data:
              failCommands: [ping]
              closeConnection: true
      - name: runCommand
        object: plainDb
        arguments:
          commandName: ping
          command:
            ping: 1
        expectError:
          isError: true

# TODO - Transaction coverage
# TODO - Stable API coverage
