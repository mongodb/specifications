<!DOCTYPE HTML>
<html lang="en" class="light" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Decimal128 - MongoDB Driver Specifications</title>


        <!-- Custom HTML head -->
        
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->

    </head>
    <body class="sidebar-visible no-js">
    <div id="body-container">
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('light')
            html.classList.add(theme);
            var body = document.querySelector('body');
            body.classList.remove('no-js')
            body.classList.add('js');
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var body = document.querySelector('body');
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            body.classList.remove('sidebar-visible');
            body.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="../index.html">Introduction</a></li><li class="chapter-item expanded affix "><a href="../driver-mantras.html">Mantras</a></li><li class="chapter-item expanded affix "><a href="../wireversion-featurelist/wireversion-featurelist.html">Wire Version Feature List</a></li><li class="chapter-item expanded affix "><li class="part-title">Specifications</li><li class="chapter-item expanded "><div><strong aria-hidden="true">1.</strong> Serialization</div></li><li><ol class="section"><li class="chapter-item expanded "><a href="../BSON.html"><strong aria-hidden="true">1.1.</strong> BSON</a></li><li class="chapter-item expanded "><a href="../bson-objectid/objectid.html"><strong aria-hidden="true">1.2.</strong> ObjectId</a></li><li class="chapter-item expanded "><a href="../bson-decimal128/decimal128.html" class="active"><strong aria-hidden="true">1.3.</strong> Decimal128</a></li><li class="chapter-item expanded "><a href="../bson-binary-uuid/uuid.html"><strong aria-hidden="true">1.4.</strong> UUID</a></li><li class="chapter-item expanded "><a href="../dbref/dbref.html"><strong aria-hidden="true">1.5.</strong> DBRef</a></li><li class="chapter-item expanded "><a href="../extended-json/extended-json.html"><strong aria-hidden="true">1.6.</strong> Extended JSON</a></li></ol></li><li class="chapter-item expanded "><li class="spacer"></li><li class="chapter-item expanded "><div><strong aria-hidden="true">2.</strong> Communication</div></li><li><ol class="section"><li class="chapter-item expanded "><a href="../message/OP_MSG.html"><strong aria-hidden="true">2.1.</strong> OP_MSG</a></li><li class="chapter-item expanded "><a href="../run-command/run-command.html"><strong aria-hidden="true">2.2.</strong> Command Execution</a></li><li class="chapter-item expanded "><a href="../connection-string/connection-string-spec.html"><strong aria-hidden="true">2.3.</strong> Connection String</a></li><li class="chapter-item expanded "><a href="../uri-options/uri-options.html"><strong aria-hidden="true">2.4.</strong> URI Options</a></li><li class="chapter-item expanded "><a href="../ocsp-support/ocsp-support.html"><strong aria-hidden="true">2.5.</strong> OCSP</a></li><li class="chapter-item expanded "><a href="../mongodb-handshake/handshake.html"><strong aria-hidden="true">2.6.</strong> Initial Handshake</a></li><li class="chapter-item expanded "><a href="../compression/OP_COMPRESSED.html"><strong aria-hidden="true">2.7.</strong> Wire Compression</a></li><li class="chapter-item expanded "><a href="../socks5-support/socks5.html"><strong aria-hidden="true">2.8.</strong> SOCKS5</a></li><li class="chapter-item expanded "><a href="../initial-dns-seedlist-discovery/initial-dns-seedlist-discovery.html"><strong aria-hidden="true">2.9.</strong> Initial DNS Seedlist Discovery</a></li></ol></li><li class="chapter-item expanded "><li class="spacer"></li><li class="chapter-item expanded "><div><strong aria-hidden="true">3.</strong> Connectivity</div></li><li><ol class="section"><li class="chapter-item expanded "><a href="../server-discovery-and-monitoring/server-discovery-and-monitoring.html"><strong aria-hidden="true">3.1.</strong> Server Discovery and Monitoring</a></li><li class="chapter-item expanded "><a href="../connection-monitoring-and-pooling/connection-monitoring-and-pooling.html"><strong aria-hidden="true">3.2.</strong> Connection Monitoring and Pooling</a></li><li class="chapter-item expanded "><a href="../load-balancers/load-balancers.html"><strong aria-hidden="true">3.3.</strong> Load Balancer Support</a></li></ol></li><li class="chapter-item expanded "><li class="spacer"></li><li class="chapter-item expanded "><div><strong aria-hidden="true">4.</strong> Availability</div></li><li><ol class="section"><li class="chapter-item expanded "><a href="../server-discovery-and-monitoring/server-monitoring.html"><strong aria-hidden="true">4.1.</strong> Server Monitoring</a></li><li class="chapter-item expanded "><a href="../polling-srv-records-for-mongos-discovery/polling-srv-records-for-mongos-discovery.html"><strong aria-hidden="true">4.2.</strong> SRV Polling for mongos Discovery</a></li><li class="chapter-item expanded "><a href="../server-selection/server-selection.html"><strong aria-hidden="true">4.3.</strong> Server Selection</a></li><li class="chapter-item expanded "><a href="../max-staleness/max-staleness.html"><strong aria-hidden="true">4.4.</strong> Max Staleness</a></li></ol></li><li class="chapter-item expanded "><li class="spacer"></li><li class="chapter-item expanded "><div><strong aria-hidden="true">5.</strong> Resilience</div></li><li><ol class="section"><li class="chapter-item expanded "><div><strong aria-hidden="true">5.1.</strong> Retryability</div></li><li><ol class="section"><li class="chapter-item expanded "><a href="../retryable-reads/retryable-reads.html"><strong aria-hidden="true">5.1.1.</strong> Reads</a></li><li class="chapter-item expanded "><a href="../retryable-writes/retryable-writes.html"><strong aria-hidden="true">5.1.2.</strong> Writes</a></li></ol></li><li class="chapter-item expanded "><a href="../client-side-operations-timeout/client-side-operations-timeout.html"><strong aria-hidden="true">5.2.</strong> CSOT</a></li><li class="chapter-item expanded "><div><strong aria-hidden="true">5.3.</strong> Consistency</div></li><li><ol class="section"><li class="chapter-item expanded "><a href="../sessions/driver-sessions.html"><strong aria-hidden="true">5.3.1.</strong> Sessions</a></li><li class="chapter-item expanded "><a href="../causal-consistency/causal-consistency.html"><strong aria-hidden="true">5.3.2.</strong> Causal Consistency</a></li><li class="chapter-item expanded "><a href="../sessions/snapshot-sessions.html"><strong aria-hidden="true">5.3.3.</strong> Snapshot Reads</a></li><li class="chapter-item expanded "><a href="../transactions/transactions.html"><strong aria-hidden="true">5.3.4.</strong> Transactions</a></li><li class="chapter-item expanded "><a href="../transactions-convenient-api/transactions-convenient-api.html"><strong aria-hidden="true">5.3.5.</strong> Convenient Transactions API</a></li></ol></li></ol></li><li class="chapter-item expanded "><li class="spacer"></li><li class="chapter-item expanded "><div><strong aria-hidden="true">6.</strong> Programmability</div></li><li><ol class="section"><li class="chapter-item expanded "><div><strong aria-hidden="true">6.1.</strong> Resource Management</div></li><li><ol class="section"><li class="chapter-item expanded "><a href="../enumerate-databases/enumerate-databases.html"><strong aria-hidden="true">6.1.1.</strong> Databases</a></li><li class="chapter-item expanded "><a href="../enumerate-collections/enumerate-collections.html"><strong aria-hidden="true">6.1.2.</strong> Collections</a></li><li class="chapter-item expanded "><a href="../index-management/index-management.html"><strong aria-hidden="true">6.1.3.</strong> Indexes</a></li></ol></li><li class="chapter-item expanded "><div><strong aria-hidden="true">6.2.</strong> Data Management</div></li><li><ol class="section"><li class="chapter-item expanded "><a href="../crud/crud.html"><strong aria-hidden="true">6.2.1.</strong> CRUD</a></li><li class="chapter-item expanded "><a href="../collation/collation.html"><strong aria-hidden="true">6.2.2.</strong> Collation</a></li><li class="chapter-item expanded "><a href="../server_write_commands/server_write_commands.html"><strong aria-hidden="true">6.2.3.</strong> Write Commands</a></li><li class="chapter-item expanded "><a href="../driver-bulk-update.html"><strong aria-hidden="true">6.2.4.</strong> Bulk API</a></li><li class="chapter-item expanded "><a href="../crud/bulk-write.html"><strong aria-hidden="true">6.2.5.</strong> Bulk Write</a></li><li class="chapter-item expanded "><a href="../read-write-concern/read-write-concern.html"><strong aria-hidden="true">6.2.6.</strong> R/W Concern</a></li></ol></li><li class="chapter-item expanded "><div><strong aria-hidden="true">6.3.</strong> Cursors</div></li><li><ol class="section"><li class="chapter-item expanded "><a href="../change-streams/change-streams.html"><strong aria-hidden="true">6.3.1.</strong> Change Streams</a></li><li class="chapter-item expanded "><a href="../find_getmore_killcursors_commands/find_getmore_killcursors_commands.html"><strong aria-hidden="true">6.3.2.</strong> find/getMore/killCursors</a></li></ol></li><li class="chapter-item expanded "><a href="../gridfs/gridfs-spec.html"><strong aria-hidden="true">6.4.</strong> GridFS</a></li><li class="chapter-item expanded "><a href="../versioned-api/versioned-api.html"><strong aria-hidden="true">6.5.</strong> Stable API</a></li><li class="chapter-item expanded "><div><strong aria-hidden="true">6.6.</strong> Security</div></li><li><ol class="section"><li class="chapter-item expanded "><a href="../client-side-encryption/client-side-encryption.html"><strong aria-hidden="true">6.6.1.</strong> Client Side Encryption</a></li><li class="chapter-item expanded "><a href="../bson-binary-encrypted/binary-encrypted.html"><strong aria-hidden="true">6.6.2.</strong> BSON Binary Subtype 6</a></li></ol></li></ol></li><li class="chapter-item expanded "><li class="spacer"></li><li class="chapter-item expanded "><div><strong aria-hidden="true">7.</strong> Observability</div></li><li><ol class="section"><li class="chapter-item expanded "><a href="../command-logging-and-monitoring/command-logging-and-monitoring.html"><strong aria-hidden="true">7.1.</strong> Command Logging and Monitoring</a></li><li class="chapter-item expanded "><a href="../server-discovery-and-monitoring/server-discovery-and-monitoring-logging-and-monitoring.html"><strong aria-hidden="true">7.2.</strong> SDAM Logging and Monitoring</a></li><li class="chapter-item expanded "><a href="../logging/logging.html"><strong aria-hidden="true">7.3.</strong> Standardized Logging</a></li><li class="chapter-item expanded "><a href="../connection-monitoring-and-pooling/connection-monitoring-and-pooling.html"><strong aria-hidden="true">7.4.</strong> Connection Pool Logging</a></li></ol></li><li class="chapter-item expanded "><li class="spacer"></li><li class="chapter-item expanded "><div><strong aria-hidden="true">8.</strong> Testability</div></li><li><ol class="section"><li class="chapter-item expanded "><a href="../unified-test-format/unified-test-format.html"><strong aria-hidden="true">8.1.</strong> Unified Test Format</a></li><li class="chapter-item expanded "><a href="../atlas-data-lake-testing/tests/index.html"><strong aria-hidden="true">8.2.</strong> Atlas Data Federation Testing</a></li><li class="chapter-item expanded "><a href="../benchmarking/benchmarking.html"><strong aria-hidden="true">8.3.</strong> Performance Benchmarking</a></li><li class="chapter-item expanded "><a href="../bson-corpus/bson-corpus.html"><strong aria-hidden="true">8.4.</strong> BSON Corpus</a></li><li class="chapter-item expanded "><a href="../connections-survive-step-down/tests/index.html"><strong aria-hidden="true">8.5.</strong> Replication Event Resilience</a></li><li class="chapter-item expanded "><a href="../faas-automated-testing/faas-automated-testing.html"><strong aria-hidden="true">8.6.</strong> FAAS Automated Testing</a></li><li class="chapter-item expanded "><a href="../serverless-testing/index.html"><strong aria-hidden="true">8.7.</strong> Atlas Serverless Testing</a></li></ol></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <!-- Track and set sidebar scroll position -->
        <script>
            var sidebarScrollbox = document.querySelector('#sidebar .sidebar-scrollbox');
            sidebarScrollbox.addEventListener('click', function(e) {
                if (e.target.tagName === 'A') {
                    sessionStorage.setItem('sidebar-scroll', sidebarScrollbox.scrollTop);
                }
            }, { passive: true });
            var sidebarScrollTop = sessionStorage.getItem('sidebar-scroll');
            sessionStorage.removeItem('sidebar-scroll');
            if (sidebarScrollTop) {
                // preserve sidebar scroll position when navigating via links within sidebar
                sidebarScrollbox.scrollTop = sidebarScrollTop;
            } else {
                // scroll sidebar to current active section when navigating via "next/previous chapter" buttons
                var activeSection = document.querySelector('#sidebar .active');
                if (activeSection) {
                    activeSection.scrollIntoView({ block: 'center' });
                }
            }
        </script>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">MongoDB Driver Specifications</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="bson-decimal128"><a class="header" href="#bson-decimal128">BSON Decimal128</a></h1>
<ul>
<li>Status: Accepted</li>
<li>Minimum Server Version: 3.4</li>
</ul>
<hr />
<h2 id="abstract"><a class="header" href="#abstract">Abstract</a></h2>
<p>MongoDB 3.4 introduces a new BSON type representing high precision decimal (<code>"\x13"</code>), known as Decimal128. 3.4
compatible drivers must support this type by creating a Value Object for it, possibly with accessor functions for
retrieving its value in data types supported by the respective languages.</p>
<p>Round-tripping Decimal128 types between driver and server MUST not change its value or representation in any way.
Conversion to and from native language types is complicated and there are many pitfalls to represent Decimal128
precisely in all languages</p>
<p>While many languages offer a native decimal type, the precision of these types often does not exactly match that of the
MongoDB implementation. To ensure error-free conversion and consistency between official MongoDB drivers, this
specification does not allow automatically converting the <code>BSON Decimal128</code> type into a language-defined decimal type.</p>
<p>Language drivers will wrap their native type in value objects by default and SHOULD offer accessor functions for
retrieving its value represented by language-defined types if appropriate. A driver that offers the ability to configure
mappings to/from BSON types to native types MAY allow the option to automatically convert the <code>BSON Decimal128</code> type to
a native type. It should however be made abundantly clear to the user that converting to native data types risks
incurring data loss.</p>
<h2 id="meta"><a class="header" href="#meta">META</a></h2>
<p>The keywords "MUST", "MUST NOT", "REQUIRED", "SHALL", "SHALL NOT", "SHOULD", "SHOULD NOT", "RECOMMENDED", "MAY", and
"OPTIONAL" in this document are to be interpreted as described in <a href="https://www.ietf.org/rfc/rfc2119.txt">RFC 2119</a>.</p>
<h2 id="terminology"><a class="header" href="#terminology">Terminology</a></h2>
<p><strong>IEEE 754-2008 128-bit decimal floating point (Decimal128)</strong></p>
<p>The Decimal128 specification supports 34 decimal digits of precision, a max value of approximately <code>10^6145</code>, and min
value of approximately <code>-10^6145</code>. This is the new <code>BSON Decimal128</code> type (<code>"\x13"</code>).</p>
<p><strong>Clamping</strong></p>
<p>Clamping happens when a value's exponent is too large for the destination format. This works by adding zeros to the
coefficient to reduce the exponent to the largest usable value. An overflow occurs if the number of digits required is
more than allowed in the destination format.</p>
<p><strong>Binary Integer Decimal (BID)</strong></p>
<p>MongoDB uses this binary encoding for the coefficient as specified in <code>IEEE 754-2008</code> section 3.5.2 using method 2
"binary encoding" rather than method 1 "decimal encoding". The byte order is little-endian, like the rest of the BSON
types.</p>
<p><strong>Value Object</strong></p>
<p>An immutable container type representing a value (e.g. Decimal128). This Value Object MAY provide accessors that
retrieve the abstracted value as a different type (e.g. casting it). <code>double x = valueObject.getAsDouble();</code></p>
<h2 id="specification"><a class="header" href="#specification">Specification</a></h2>
<h3 id="bson-decimal128-implementation-details"><a class="header" href="#bson-decimal128-implementation-details">BSON Decimal128 implementation details</a></h3>
<p>The <code>BSON Decimal128</code> data type implements the
<a href="http://speleotrove.com/decimal/decbits.html">Decimal Arithmetic Encodings</a> specification, with certain exceptions
around value integrity and the coefficient encoding. When a value cannot be represented exactly, the value will be
rejected.</p>
<p>The coefficient MUST be stored as an unsigned binary integer (BID) rather than the densely-packed decimal (DPD) shown in
the specification. See either the <code>IEEE Std 754-2008</code> spec or the driver examples for further detail.</p>
<p>The specification defines several statuses which are meant to signal exceptional
<a href="http://speleotrove.com/decimal/daexcep.html">circumstances</a>, such as when overflowing occurs, and how to handle them.</p>
<p><code>BSON Decimal128</code> Value Objects MUST implement these actions for these exceptions:</p>
<ul>
<li>
<p>Overflow</p>
<ul>
<li>When overflow occurs, the operation MUST emit an error and result in a failure</li>
</ul>
</li>
<li>
<p>Underflow</p>
<ul>
<li>When underflow occurs, the operation MUST emit an error and result in a failure</li>
</ul>
</li>
<li>
<p>Clamping</p>
<ul>
<li>Since clamping does not change the actual value, only the representation of it, clamping MUST occur without emitting
an error.</li>
</ul>
</li>
<li>
<p>Rounding</p>
<ul>
<li>When the coefficient requires more digits then Decimal128 provides, rounding MUST be done without emitting an error,
unless it would result in inexact rounding, in which case the operation MUST emit an error and result in a failure.</li>
</ul>
</li>
<li>
<p>Conversion Syntax</p>
<ul>
<li>Invalid strings MUST emit an error and result in a failure.</li>
</ul>
</li>
</ul>
<p>It should be noted that the given exponent is a preferred representation. If the value cannot be stored due to the value
of the exponent being too large or too small, but can be stored using an alternative representation by clamping and or
rounding, a <code>BSON Decimal128</code> compatible Value Object MUST do so, unless such operation results in an inexact rounding
or other underflow or overflow.</p>
<h3 id="reading-from-bson"><a class="header" href="#reading-from-bson">Reading from BSON</a></h3>
<p>A BSON type <code>"\x13"</code> MUST be represented by an immutable Value Object by default and MUST NOT be automatically converted
into language native numeric type by default. A driver that offers users a way to configure the exact type mapping to
and from BSON types MAY allow the <code>BSON Decimal128</code> type to be converted to the user configured type.</p>
<p>A driver SHOULD provide accessors for this immutable Value Object, which can return a language-specific representation
of the Decimal128 value, after converting it into the respective type. For example, Java may choose to provide
<code>Decimal128.getBigDecimal()</code>.</p>
<p>All drivers MUST provide an accessor for retrieving the value as a string. Drivers MAY provide other accessors,
retrieving the value as other types.</p>
<h3 id="serializing-and-writing-bson"><a class="header" href="#serializing-and-writing-bson">Serializing and writing BSON</a></h3>
<p>Drivers MUST provide a way of constructing the Value Object, as the driver representation of the <code>BSON Decimal128</code> is an
immutable Value Object by default.</p>
<p>A driver MUST have a way to construct this Value Object from a string. For example, Java MUST provide a method similar
to <code>Decimal128.valueOf("2.000")</code>.</p>
<p>A driver that has accessors for different types SHOULD provide a way to construct the Value Object from those types.</p>
<h3 id="reading-from-extended-json"><a class="header" href="#reading-from-extended-json">Reading from Extended JSON</a></h3>
<p>The Extended JSON representation of Decimal128 is a document with the key <code>$numberDecimal</code> and a value of the Decimal128
as a string. Drivers that support Extended JSON formatting MUST support the <code>$numberDecimal</code> type specifier.</p>
<p>When an Extended JSON <code>$numberDecimal</code> is parsed, its type should be the same as that of a deserialized
<code>BSON Decimal128</code>, as described in <a href="#reading-from-bson">Reading from BSON</a>.</p>
<p>The Extended JSON <code>$numberDecimal</code> value follows the same stringification rules as defined in
<a href="#from-string-representation">From String Representation</a>.</p>
<h3 id="writing-to-extended-json"><a class="header" href="#writing-to-extended-json">Writing to Extended JSON</a></h3>
<p>The Extended JSON type identifier is <code>$numberDecimal</code>, while the value itself is a string. Drivers that support
converting values to Extended JSON MUST be able to convert its Decimal128 value object to Extended JSON.</p>
<p>Converting a Decimal128 Value Object to Extended JSON MUST follow the conversion rules in
<a href="#to-string-representation">To String Representation</a>, and other stringification rules as when converting Decimal128
Value Object to a String.</p>
<h3 id="operator-overloading-and-math-on-decimal128-value-objects"><a class="header" href="#operator-overloading-and-math-on-decimal128-value-objects">Operator overloading and math on Decimal128 Value Objects</a></h3>
<p>Drivers MUST NOT allow any mathematical operator overloading for the Decimal128 Value Objects. This includes adding two
Decimal128 Value Objects and assigning the result to a new object.</p>
<p>If a user wants to perform mathematical operations on Decimal128 Value Objects, the user must explicitly retrieve the
native language value representations of the objects and perform the operations on those native representations. The
user will then create a new Decimal128 Value Object and optionally overwrite the original Decimal128 Value Object.</p>
<h3 id="from-string-representation"><a class="header" href="#from-string-representation">From String Representation</a></h3>
<p>For finite numbers, we will use the definition at <a href="http://speleotrove.com/decimal/daconvs.html">http://speleotrove.com/decimal/daconvs.html</a>. It has been modified to
account for a different NaN representation and whitespace rules and copied here:</p>
<pre><code>Strings which are acceptable for conversion to the abstract representation of
numbers, or which might result from conversion from the abstract representation
to a string, are called numeric strings.


A numeric string is a character string that describes either a finite
number or a special value.
* If it describes a finite number, it includes one or more decimal digits,
  with an optional decimal point. The decimal point may be embedded in the
  digits, or may be prefixed or suffixed to them. The group of digits (and
  optional point) thus constructed may have an optional sign ('+' or '-')
  which must come before any digits or decimal point. 
* The string thus described may optionally be followed by an 'E'
  (indicating an exponential part), an optional sign, and an integer
  following the sign that represents a power of ten that is to be applied.
  The 'E' may be in uppercase or lowercase.
* If it describes a special value, it is one of the case-independent names
  'Infinity', 'Inf', or 'NaN' (where the first two represent infinity and
  the second represent NaN). The name may be preceded by an optional sign,
  as for finite numbers. 
* No blanks or other whitespace characters are permitted in a numeric string.

Formally

          sign           ::=  '+' | '-'
          digit          ::=  '0' | '1' | '2' | '3' | '4' | '5' | '6' | '7' |
                              '8' | '9'
          indicator      ::=  'e' | 'E'
          digits         ::=  digit [digit]...
          decimal-part   ::=  digits '.' [digits] | ['.'] digits
          exponent-part  ::=  indicator [sign] digits
          infinity       ::=  'Infinity' | 'Inf'
          nan            ::=  'NaN'
          numeric-value  ::=  decimal-part [exponent-part] | infinity
          numeric-string ::=  [sign] numeric-value | [sign] nan

where the characters in the strings accepted for 'infinity' and 'nan' may be in
any case.  If an implementation supports the concept of diagnostic information
on NaNs, the numeric strings for NaNs MAY include one or more digits, as shown
above.[3]  These digits encode the diagnostic information in an
implementation-defined manner; however, conversions to and from string for
diagnostic NaNs should be reversible if possible. If an implementation does not
support diagnostic information on NaNs, these digits should be ignored where
necessary. A plain 'NaN' is usually the same as 'NaN0'.


Drivers MAY choose to support signed NaN (sNaN), along with sNaN with
diagnostic information. 



Examples::
Some numeric strings are:
            "0"         -- zero
           "12"         -- a whole number
          "-76"         -- a signed whole number
           "12.70"      -- some decimal places
           "+0.003"     -- a plus sign is allowed, too
          "017."        -- the same as 17
             ".5"       -- the same as 0.5
           "4E+9"       -- exponential notation
            "0.73e-7"   -- exponential notation, negative power
           "Inf"        -- the same as Infinity
           "-infinity"  -- the same as -Infinity
           "NaN"        -- not-a-Number

Notes:
1. A single period alone or with a sign is not a valid numeric string.
2. A sign alone is not a valid numeric string.
3. Significant (after the decimal point) and insignificant leading zeros
       are permitted.
</code></pre>
<h3 id="to-string-representation"><a class="header" href="#to-string-representation">To String Representation</a></h3>
<p>For finite numbers, we will use the definition at <a href="http://speleotrove.com/decimal/daconvs.html">http://speleotrove.com/decimal/daconvs.html</a>. It has been copied
here:</p>
<pre><code>The coefficient is first converted to a string in base ten using the characters
0 through 9 with no leading zeros (except if its value is zero, in which case a
single 0 character is used).


Next, the adjusted exponent is calculated; this is the exponent, plus the
number of characters in the converted coefficient, less one. That is,
exponent+(clength-1), where clength is the length of the coefficient in decimal
digits.


If the exponent is less than or equal to zero and the adjusted exponent is
greater than or equal to -6, the number will be converted to a character form
without using exponential notation. In this case, if the exponent is zero then
no decimal point is added. Otherwise (the exponent will be negative), a decimal
point will be inserted with the absolute value of the exponent specifying the
number of characters to the right of the decimal point. '0' characters are
added to the left of the converted coefficient as necessary. If no character
precedes the decimal point after this insertion then a conventional '0'
character is prefixed.


Otherwise (that is, if the exponent is positive, or the adjusted exponent is
less than -6), the number will be converted to a character form using
exponential notation. In this case, if the converted coefficient has more than
one digit a decimal point is inserted after the first digit. An exponent in
character form is then suffixed to the converted coefficient (perhaps with
inserted decimal point); this comprises the letter 'E' followed immediately by
the adjusted exponent converted to a character form. The latter is in base ten,
using the characters 0 through 9 with no leading zeros, always prefixed by a
sign character ('-' if the calculated exponent is negative, '+' otherwise).
</code></pre>
<p>This corresponds to the following code snippet:</p>
<blockquote>
<pre><code class="language-c">var adjusted_exponent = _exponent + (clength - 1);
if (_exponent &gt; 0 || adjusted_exponent &lt; -6) {
    // exponential notation
} else {
    // character form without using exponential notation
}
</code></pre>
</blockquote>
<p>For special numbers such as infinity or the not a number (NaN) variants, the below table is used:</p>
<div class="table-wrapper"><table><thead><tr><th>Value</th><th>String</th></tr></thead><tbody>
<tr><td>Positive Infinite</td><td>Infinity</td></tr>
<tr><td>Negative Infinite</td><td>-Infinity</td></tr>
<tr><td>Positive NaN</td><td>NaN</td></tr>
<tr><td>Negative NaN</td><td>NaN</td></tr>
<tr><td>Signaled NaN</td><td>NaN</td></tr>
<tr><td>Negative Signaled NaN</td><td>NaN</td></tr>
<tr><td>NaN with a payload</td><td>NaN</td></tr>
</tbody></table>
</div>
<p>Finally, there are certain other invalid representations that must be treated as zeros, as per <code>IEEE 754-2008</code>. The
tests will verify that each special value has been accounted for.</p>
<p>The server log files as well as the Extended JSON Format for Decimal128 use this format.</p>
<h2 id="motivation-for-change"><a class="header" href="#motivation-for-change">Motivation for Change</a></h2>
<p>BSON already contains support for <code>double</code> (<code>"\x01"</code>), but this type is insufficient for certain values that require
strict precision and representation, such as money, where it is necessary to perform exact decimal rounding.</p>
<p>The new BSON type is the 128-bit <code>IEEE 754-2008</code> decimal floating point number, which is specifically designed to cope
with these issues.</p>
<h2 id="design-rationale"><a class="header" href="#design-rationale">Design Rationale</a></h2>
<p>For simplicity and consistency between drivers, drivers must not automatically convert this type into a native type by
default. This also ensures original data preservation, which is crucial to Decimal128. It is however recommended that
drivers offer a way to convert the Value Object to a native type through accessors, and to create a new BSON type from
native types. This forces the user to explicitly do the conversion and thus understand the difference between the
MongoDB type and possible language precision and representation. Representations via conversions done outside MongoDB
are not guaranteed to be identical.</p>
<h2 id="backwards-compatibility"><a class="header" href="#backwards-compatibility">Backwards Compatibility</a></h2>
<p>There should be no backwards compatibility concerns. This specification merely deals with how to encode and decode
BSON/Extended JSON Decimal128.</p>
<h2 id="reference-implementations"><a class="header" href="#reference-implementations">Reference Implementations</a></h2>
<ul>
<li><a href="https://github.com/mongodb/libbson/blob/master/src/bson/bson-decimal128.c">Libbson</a></li>
<li><a href="https://github.com/estolfo/bson-ruby/blob/RUBY-1098-decimal128/lib/bson/decimal128.rb">Ruby</a></li>
<li><a href="https://github.com/craiggwilson/mongo-csharp-driver/tree/decimal">.NET</a></li>
<li><a href="https://github.com/mongodb/mongo-python-driver/blob/master/bson/decimal128.py">PyMongo</a></li>
<li><a href="https://github.com/mongodb/js-bson/blob/0.5/lib/bson/decimal128.js">Node</a></li>
<li><a href="https://github.com/mongodb/mongo-java-driver/blob/master/bson/src/main/org/bson/BsonDecimal128.java">Java</a></li>
</ul>
<h2 id="tests"><a class="header" href="#tests">Tests</a></h2>
<p>See the <a href="../bson-corpus/bson-corpus.html">BSON Corpus</a> for tests.</p>
<p>Most of the tests are converted from the
<a href="http://speleotrove.com/decimal/dectest.html">General Decimal Arithmetic Testcases</a>.</p>
<h2 id="qa"><a class="header" href="#qa">Q&amp;A</a></h2>
<ul>
<li>
<p>Is it true Decimal128 doesn't normalize the value?</p>
<ul>
<li>Yes. As a result of non-normalization rules of the Decimal128 data type, precision is represented exactly. For
example, '2.00' always remains stored as 200E-2 in Decimal128, and it differs from the representation of '2.0'
(20E-1). These two values compare equally, but represent different ideas.</li>
</ul>
</li>
<li>
<p>How does Decimal128 "2.000" look in the shell?</p>
<ul>
<li>NumberDecimal("2.000")</li>
</ul>
</li>
<li>
<p>Should a driver avoid sending Decimal128 values to pre-3.4 servers?</p>
<ul>
<li>No</li>
</ul>
</li>
<li>
<p>Is there a wire version bump or something for Decimal128?</p>
<ul>
<li>No</li>
</ul>
</li>
</ul>
<h2 id="changelog"><a class="header" href="#changelog">Changelog</a></h2>
<ul>
<li>2024-02-08: Migrated from reStructuredText to Markdown.</li>
<li>2022-10-05: Remove spec front matter.</li>
</ul>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../bson-objectid/objectid.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../bson-binary-uuid/uuid.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../bson-objectid/objectid.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../bson-binary-uuid/uuid.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../elasticlunr.min.js"></script>
        <script src="../mark.min.js"></script>
        <script src="../searcher.js"></script>

        <script src="../clipboard.min.js"></script>
        <script src="../highlight.js"></script>
        <script src="../book.js"></script>

        <!-- Custom JS scripts -->


    </div>
    </body>
</html>
